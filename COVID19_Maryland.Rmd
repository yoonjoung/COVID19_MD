---
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
---
```{r intro, echo=FALSE, results="hide"}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      comment = "", 
                      warning=FALSE, 
                      results="hide") 
knitr::opts_knit$set(root.dir = "C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/")

date<-as.Date(Sys.time(	), format='%d%b%Y')
time<-Sys.time()

suppressMessages(library(dplyr))
suppressMessages(library(ggplot2))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(readxl)))
suppressMessages(library(plotly))
suppressMessages(library(Matrix))
suppressMessages(library(stringr))
suppressMessages(library(stringi))

```

```{r dataPop}
dtapopcounty<-read.csv("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataCensusBureau/co-est2019-alldata.csv")

names(dtapopcounty)<- tolower(names(dtapopcounty))   
dtapopcounty<-dtapopcounty%>%select(stname, ctyname, popestimate2019)%>%
    filter(stname=="Maryland")%>%
    mutate(pop=popestimate2019, 
           state=as.character(stname), 
           county=str_remove(as.character(ctyname), " County")
           )%>%
    select(state, county, pop)%>%
    filter(state=="Maryland")

#View(dtapopcounty)
```

```{r dataByCounty}
url<-"https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
dtacases<-read.csv(url)

dtacounty<-read.csv(url)%>%
    mutate(
        date=as.Date(as.character(date)),
        state=as.character(state),
        county=as.character(county)
    )

dtacounty<-dtacounty%>%
    filter(state=="Maryland")%>%
    mutate(
        firstdatestate=min(date), #first date for the state
        firstcounty=FALSE, 
        firstcounty=ifelse(firstdatestate==date, TRUE, firstcounty),
        firstcountyname="", 
        firstcountyname=ifelse(firstcounty==TRUE, county, firstcountyname) 
    )%>%
    group_by(date)%>%
    mutate(
        numcounties= n_distinct(county)#number of affected counties by date
    )%>%ungroup()%>%
    group_by(county)%>%
    mutate(
        firstdatecounty=min(date),#first date by county 
        latestdatecounty=max(date),#latest update date by county
        latesttotal=max(cases)#latest cumulative number
    )%>%ungroup()%>%
    arrange(county, date)

dim(dtacounty)
dtacounty<-left_join(dtacounty, dtapopcounty, by = "county")%>%filter(county!="Maryland") 
dim(dtacounty)
```

```{r dataMD}
#DATA FROM MDHD
dtaMD<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/MDHealthDepartmentDashboard.xlsx")
str(dtaMD)

names(dtaMD)<- tolower(names(dtaMD))   
dtaMD<-dtaMD%>%
    filter(group=="total")%>%
    mutate(    
        cases=as.numeric(str_replace_all(stri_trim_both(cases), fixed(","),"")),
        negativetest=as.numeric(str_replace_all(stri_trim_both(negativetest), fixed(","),"")),
        deaths=as.numeric(str_replace_all(stri_trim_both(deaths), fixed(","),"")),
        probabledeaths=as.numeric(str_replace_all(stri_trim_both(probabledeaths), fixed(","),"")),
        hospitalizations=as.numeric(str_replace_all(stri_trim_both(hospitalizations), fixed(","),"")),
        releasedfromisolation=as.numeric(str_replace_all(stri_trim_both(releasedfromisolation), fixed(","),"")),
        totaltests=cases+negativetest
    )%>%
    arrange(date)%>%
    mutate(
        newcases=lead(cases)-cases,
        newtests=lead(totaltests)-totaltests
    )%>%
    select(date, cases, negativetest, deaths, hospitalizations, releasedfromisolation, totaltests, starts_with("new"))
str(dtaMD)

```

```{r dataByAge}
#DATA FROM MDHD
dtapopbyage<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/CNTY-PopEst-2018.xlsx")%>%
    select(agegroup, pop10)%>%
    filter(is.na(pop10)==F)%>%
    filter(agegroup!="Total")%>%
    mutate(    
        age=as.numeric(sapply(strsplit(agegroup,"-"), `[`, 1)) 
    )%>%
    select(age, pop10)

dtabyage<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/MDHealthDepartmentDashboard.xlsx")

names(dtabyage)<- tolower(names(dtabyage))   
dtabyage<-dtabyage%>%
    filter(group=="age")%>%
    mutate(    
        grouplabel=ifelse(grouplabel=="80+", "80", grouplabel), 
        age=as.numeric(sapply(strsplit(grouplabel,"-"), `[`, 1)),
        agegroup=grouplabel, 
        agegroup=ifelse(age==80, "80+", agegroup), 
        cases=as.numeric(cases) 
    )%>%
    select(date, age, agegroup, cases)

dim(dtabyage)
dtabyage<-left_join(dtabyage, dtapopbyage, by = "age")
dim(dtabyage)

dtabyage<-dtabyage%>%
    mutate(
        incidence=round(cases*100000/pop10, 0), 
        temp=max(date),
        latest=date==temp
    )%>%select(-temp)
```


```{r dataByRace}
#Total pop
popMD<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(mean))

#pop data FROM MD planning deparment 
dtapopbyrace<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/table1a.xlsx")%>%
    filter(is.na(pop)==F)%>%
    mutate(
        popMD=as.numeric(popMD),
        pop=round(popMD*pctpop, 0)
    )%>%select(race, pop)%>%
    group_by(race)%>%summarize_all(funs(sum))%>%filter(is.na(pop)==F)

#COVID data by race
dtabyrace<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/MDHealthDepartmentDashboard.xlsx")

names(dtabyrace)<- tolower(names(dtabyrace))   
dtabyrace<-dtabyrace%>%
    filter(group=="race")%>%
    mutate(    
        race=grouplabel, 
        cases=as.numeric(cases),
        deaths=as.numeric(deaths),
        probabledeaths=as.numeric(probabledeaths)
    )%>%
    select(date, race, cases, deaths, probabledeaths)

table(dtapopbyrace$race)
table(dtabyrace$race)

dim(dtabyrace)
dtabyrace<-left_join(dtabyrace, dtapopbyrace, by = "race")
dim(dtabyrace)

dtabyrace<-dtabyrace%>%
    mutate(
        incidence=round(cases*100000/pop, 0), 
        temp=max(date),
        latest=date==temp,
        cfr=round(100*deaths/cases, 1),
        mortality=round(100000*(deaths)/pop, 1),
        mortalityprobable=round(100000*(probabledeaths)/pop, 1)
    )%>%select(-temp)
```

#####__COVID-19 update in Maryland, US__ 

(Updated: `r time` EDT)  

So, I have been watching the epidemic in China and Korea since the beginning, but it is still not easy to settle into this reality here in the US. 

* First of all, everyone, __STAY HEALTHY and [see what YOU can do](https://www.cdc.gov/coronavirus/2019-ncov/protect/index.html)__! 

* Second, there are many excellent news articles and information sources, but I'm sharing some more __questions (see left panel) and answers for those who are curious about a specific situation in Maryland, US - especially including local data__. Maryland is my beautiful adopted home state of over 20 years. The State is doing its best with strong leadership, but this virus arrived here when the country was not ready and is spreading fast unfortunately... 

_See footnote for further information about data sources. More questions and answers will be added, as more local data become available._ 

(Sorry, this is not mobile device friendly, and is best viewed on your regular monitor.)

---

#####__Q 6. How has it affected population across different races?__

The Maryland Department of Health started publishing data by race (i.e., the number of cases and deaths by race) on April 9th, following an upsetting report about racial disparity in COVID mortality in the US: [higher morality in states with higher proportions of black population](https://www.washingtonpost.com/nation/2020/04/07/coronavirus-is-infecting-killing-black-americans-an-alarmingly-high-rate-post-analysis-shows/?arc404=true). Further data - specifically disaggregated by individual people's race, beyond the state-level analysis - are crucial to monitor and understand the disparity. Also, though initially unavailable, __a separate category for Hispanic popualtion is published on April 15__. As a resident of Maryland, I am very proud of the state's rapid action to publish race data!

```{r}
incidencetop<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(incidence==max(incidence))%>%select(incidence)%>%
    summarize_all(funs(max))
                            
incidencetoprace<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(incidence==max(incidence))%>%select(race)
incidencetoprace<-incidencetoprace$race

missingracecases<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(race=="Missing")%>%select(cases)%>%
    summarize_all(funs(mean))
allcases<-dtabyrace%>%filter(latest==TRUE)%>%select(cases)%>%
    summarize_all(funs(sum))
missingracepct<-round(100*missingracecases/allcases, 0)

```
However, note that __`r missingracepct` % of cases do not have race information (i.e., "missing" race)__. This is likely because [private labs are not required to report race](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-race-data-20200409-ffim7y4bljcz3hjk4dmt773mp4-story.html). 

_Hover over each figure to see values and more options._
```{r plotbyracecases, results='asis', fig.align="left", out.width="500px"}
dtafig<-dtabyrace%>%filter(date==max(date))

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$cases, decreasing = TRUE)])

plot_ly(dtafig, x=~race, y=~cases, type = 'bar', name="confirmed cases")%>% 
    layout(
            title = c("COVID-19 cases by race"),
            yaxis = list(title = "Number of confirmed cases")
            )
```

Now with Hispanic population disaggregated from "other", the pattern of incidence and mortality by race/ethnicity can be examined better. __In terms of rates, incidence is substantially higher among Other, African American, and Hispanic population__ (blue bars). Currently, __mortality, specifically the case fatality rate, is highest among White and Asian Americans__ (orange bars). This implies that __the disproportionately higher number of deaths among African American population in Maryland is because of the higher rate of infection among African Americans, not because of higher risk of dying among those African Americans who are infected__. At the same time, though the infection rate is lower, mortality risk is higher among Asian Americans in Maryland.   

To understand reasons behind this, we will need to learn more about characteristics of patients by race (e.g., Do Asian Americans with COVID tend to be older and/or have existing conditions in Maryland?) and any differences in access to health care by race among COVID patients. Also, what can we do to reduce the higher infection rate among African Americans and Hispanic population in Maryland? Finally and importantly, if and when we have better data on race (i.e., less cases with missing race information), the findings on racial disparity can change. 

(__Note__: In Maryland, "Other" population includes: American Indian and Alaska Native, Native Hawaiian and Other Pacific Islander, and 'Two or more races'. It accounts for about 3% of total population in the state.)

_Hover over each figure to see values and more options._
```{r plotbyracerates, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabyrace%>%filter(date==max(date))

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$incidence, decreasing = TRUE)])

figincidencerate<-plot_ly(dtafig, x=~race, y=~incidence, type = 'bar', name="Cases per 100,000 population")%>% 
    layout(
            xaxis = list(title = "Race",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10)),
            yaxis = list(title = "Cases per 100,000 population")
            )

dtafig<-dtabyrace%>%filter(date==max(date))

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$cfr, decreasing = TRUE)])

figcfr<-plot_ly(dtafig, x=~race, y=~cfr, type = 'bar' , name="Deaths per 100 cases (%)")%>% 
    layout(
            xaxis = list(title = "Race",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10)),
            yaxis = list(title = "Deaths per 100 cases (%)")
            )

subplot(figincidencerate, figcfr, nrows=1, shareY = FALSE, titleY = TRUE) %>%
        layout(  title ="Cumulative incidence and case fatality rate rates by race in Maryland", 
                 showlegend=FALSE  )
```
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))

#####__Q 5. What is the latest mortality, and how has it changed?__ 
```{r}
latestdateMD<-max(dtaMD$date)

deathsMD<-dtaMD%>%filter(date==max(date))%>%select(deaths)%>%summarize_all(funs(mean))
casesMD<-dtaMD%>%filter(date==max(date))%>%select(cases)%>%summarize_all(funs(mean))
cfrMD<-round(100*deathsMD/casesMD, 1)

latestdatecounty<-max(dtacounty$date)
```
As of `r latestdateMD` 10:00AM, __`r deathsMD` COVID-19-positive deaths have occurred__, according to Maryland Department of Health. __This means `r cfrMD` percent of all confirmed cases__. Below figure shows mortality by county - in terms of both absolute number (blue bars) and case fatality rate (orange bars) as of `r latestdatecounty`. 

(_Note: MD Health Department has published the number of probably COVID deaths since April 15. Those deaths have not been included in analyses here_.)

```{r plotdeathsCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%filter(date==latestdatecounty)%>%filter(deaths>0)%>%select(date, county, deaths, cases)%>%mutate(cfr=round(100*deaths/cases, 1)) 

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$deaths, decreasing = TRUE)])

fig1<-plot_ly(dtafig, x = ~county, y = ~deaths, type="bar", 
              name = "Total number of deaths") %>%
        layout(
            title ="Latest number of COVID-19-positive deaths by county in Maryland",
            xaxis = list( 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Total number of deaths")
            )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$cfr, decreasing = TRUE)])

fig2<-plot_ly(dtafig, x = ~county, y = ~cfr, type="bar",
              name="Deaths per 100 cases (%)") %>%
        layout(
            title ="COVID-19 case fatality rate by county in Maryland",
            xaxis = list(  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Deaths per 100 cases (%)")
            )

subplot(fig1, fig2, titleY = TRUE) %>%
        layout(
            title ="COVID-19 mortality by county in Maryland",
            legend = list(orientation = "h",   
                        xanchor = "center",  
                        x=0.5, y=-0.4)            
            )

```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data), US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage))

Below chart shows the mortality trends, since March 18 when the first COVID-19 death was reported in Maryland. Globally in countries severely affected by the epidemic before US, case fatality rates increased rapidly in the beginning. The rates then stabilized in some of the countries, depending on health systems' response and characteristics of patient population.  
```{r plotcfrMDtrends, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%select(date, deaths, cases)%>%
    group_by(date)%>%
    summarize_all(funs(sum))%>%
    mutate(cfr=round(100*deaths/cases, 1))%>%
    filter(cfr>0)

plot_ly(dtafig, x = ~date, y = ~cfr, type="bar") %>%
        layout(
            title ="Trends of COVID-19 case fatality rates in Maryland",
            xaxis = list( 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Deaths per 100 confirmed cases (%)")
            )
```

```{r plotdeathsMDtrends, fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%select(date, deaths, cases)%>%
    group_by(date)%>%
    summarize_all(funs(sum))%>%
    mutate(cfr=round(100*deaths/cases, 1))%>%
    filter(cfr>0)

plot_ly(dtafig, x = ~date, y = ~deaths, type="bar") %>%
        layout(
            title ="Trends of COVID-19 mortality in Maryland",
            xaxis = list( 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Number of COVID-19 deaths")
            )
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data), US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage))

#####__Q 4. How extensive has testing been?__ 

```{r}
firstdateMD<-min(dtaMD$date)
latestdateMD<-max(dtaMD$date)
totaltestMD<-dtaMD%>%filter(date==max(date))%>%select(totaltests)%>%summarize_all(funs(max))

popstate<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(sum))
testrateMD<-round(1000*totaltestMD/popstate, 1)
totaltestMD<-as.character(totaltestMD)

#The State has tested 220,880 individuals, with 15,694 new people tested on March 31.
#https://coronavirus.health.ny.gov/home
totaltestNY<-as.vector(220880)
popstateNY<-as.vector(19500000)
testrateNY<-round(1000*totaltestNY/popstateNY, 0)
latestnewtestsNY<-"15,694"
```
This is a very important question, since the magnitude of testing over time is critical information to understand the epidemic. I got trend data on testing in Maryland from [COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/) by Maryland Department of Health also [COVID Tracking Project](https://covidtracking.com/data/state/maryland#historical) for earlier data. Still, data on the number of new tests are not available between 3/12 and 3/28. 

As of `r latestdateMD` 10:00AM, __a total of `r totaltestMD` tests have been conducted__. There are about 6 million people in Maryland, and this means __`r testrateMD` tests have been conducted in every 1000 people. Below shows the number of new tests by date in Maryland__. 

[A large spike on the number of new tests on April 7th appears to be artifact of delayed processes in laboratory and/or data entry, not actual changes in the number of tests](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).   
```{r plotTrendNewTestsMD, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtaMD%>%select(date, cases, negativetest, newtests)%>%
    mutate(notestdata=(date>as.Date("2020-03-11") & date< as.Date("2020-03-29")) ,
           newtests=ifelse(notestdata==TRUE, NA, newtests)
    )

plot_ly(dtafig, x=~date, y=~newtests, type = 'bar') %>%
    #, name="Total tests"     
    #add_trace(y=dtafig$newcases, name = 'Positive tests') %>%
        layout(
            annotations= list(x = "2020-03-22",
                              y = 5500,
                              text = "Total number of new tests not available between 3/12-3/28",
                              font = list(color = 'gray', size = 12),
                              xref = "x",
                              yref = "y",
                              showarrow = FALSE),
            title = "Trend of daily new COVID-19 tests in Maryland",
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new tests"))

```
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/))

#####__Q 3. What age groups are affected? And, how has it changed over time? (NEW)__ 

```{r}
incidencetop<-dtabyage%>%filter(latest==TRUE)%>%filter(is.na(age)==FALSE)%>%
    filter(incidence==max(incidence))%>%select(incidence)%>%
    summarize_all(funs(mean))
                            
incidencetopage<-dtabyage%>%filter(latest==TRUE)%>%filter(is.na(age)==FALSE)%>%
    filter(incidence==max(incidence))%>%select(agegroup)
incidencetopage<-incidencetopage$agegroup


incidencetop
incidencetopage

```
Initially, COVID-19 has affected __adult population relatively evenly across different ages__ (approaching or above 300 per 100,000 population in all age groups 30 and above). Recently, however, __the incidence rate has increased more rapidly among those 80 and older__ (see the second figure). Currently, the incidence rate is highest, `r incidencetop` per 100,000 population, among people `r incidencetopage` years of age.  

```{r plotincidencebyage, results='asis', fig.align="left", out.width="600px"}
dtafig<-dtabyage%>%filter(latest==TRUE)
plot_ly(dtafig, x=~agegroup, y=~incidence, 
        mode = 'marker',
        transforms = list(
            list(
                type = 'groupby',
                groups = dtabyage$date
                )
            )
        ) %>%
        layout(
            title = "Number of COVID-19 cases per 100,000 population, by age group",
            xaxis = list(title = "Age group"),
            yaxis = list(title = "Incidence rate per 100,000 population"))
```
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))

```{r plotincidencebyagetrends, results='asis', fig.align="left", out.width="800px"}

dtafig<-dtabyage%>%select(date, age, incidence)%>%
    mutate(
        age=paste0("incidence",age)
    )%>%
    arrange(date, age)%>% 
    spread(age, incidence, fill = NA, convert = FALSE) 
#head(dta, 20)
#str(dta)

fig <- plot_ly(dtafig, x=~date, y=~incidence20, name = "20-29", 
               type = 'scatter', mode='lines',
               line = list(color = c( "rgb(102,194,164)"))) %>% 
    add_trace(y = ~incidence30, name = "30-39", line = list(color = c( "rgb(65,174,118)"))) %>% 
    add_trace(y = ~incidence40, name = "40-49", line = list(color = c( "rgb(35,139,69)"))) %>% 
    add_trace(y = ~incidence50, name = "50-59", line = list(color = c( "rgb(0,109,44)"))) %>% 
    add_trace(y = ~incidence60, name = "60-69", line = list(color = c( "rgb(0,68,27)"))) %>% 
    add_trace(y = ~incidence70, name = "70-79", line = list(color = c( "rgb(33,113,18)"))) %>% 
    add_trace(y = ~incidence80, name = "80+", line = list(color = c( "rgb(239,59,44)"))) %>% 
    layout(
        title ="Trends of cumulative incidence rate by age group",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of confirmed cases (per 100,000 population)",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=10), traceorder="reversed") 
        ) 

fig
```

(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))

#####__Q 2. How fast has it been spreading?__ 
```{r dataplotTrendNewCasesMD}
dtafig<-dtacounty%>%select(date, cases)%>%group_by(date)%>%
    summarize_all(funs(sum))%>%
    mutate(
        newcases=cases-lag(cases)
        )

latestdate<-max(dtafig$date)
latestnewcases<-dtafig%>%filter(date==max(date))%>%select(newcases)%>%summarize_all(funs(mean)) 
previousnewcases<-dtafig%>%arrange(date)%>%mutate(previousnewcases=lag(newcases))%>%filter(date==max(date))%>%select(previousnewcases)%>%summarize_all(funs(mean)) 
```
Since testing capacity has been low, we _cannot_ confidently answer this question. Nevertheless, we can see __the number of NEW confirmed cases each day__. The first figure is for the entire state. We want to see the number of new infections to be stable more or less, without sudden and large increases. __On `r latestdate`, `r latestnewcases` new cases were confirmed, compared to `r previousnewcases` on the previous date__. The (now relatively small) peak on March 28th was due to new cases in Carroll county on March 28 - see the second figure below.  

[The spike of new cofirmed cases on April 8th may be artifact of delayed processes in laboratory and/or data entry, not an actual increase on this speciic date](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).

_Hover over each figure to see values and more options._
```{r plotTrendNewCasesMD, results='asis', fig.align="left", out.width="800px"}

plot_ly(dtafig, x=~date, y=~newcases, 
        type = 'bar' ) %>%
        layout(
            title = "Trend of daily new confirmed COVID-19 cases in Maryland",
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new confirmed cases"))
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data))

```{r dataplotTrendNewCasesCounty}
dtafig<-dtacounty%>%select(date, county, cases, latesttotal)%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(county!=lag(county), NA, newcases )
    )%>%
    mutate(
        rank = dense_rank(desc(latesttotal))
    )%>%
    filter(latesttotal>=50)%>% arrange(county, date)

ncounty50<-n_distinct(dtafig$county)
ncounty50
```

Now, _among `r ncounty50` counties with 50 or more confirmed cases_, below shows the trends of daily number of NEW confirmed cases for each of the county. The number of new cases surged in Carroll county on March 28th, because of [an outbreak at a nursing home](https://baltimore.cbslocal.com/2020/03/28/coronavirus-latest-66-residents-at-carroll-county-nursing-home-test-positive-for-covid-19/). 

_Hover over each figure to see values and more options._
```{r plotTrendNewCasesCounty, results='asis', fig.align="left", out.width="800px"}
plot_ly(dtafig, x=~date, y=~newcases, 
             type = 'bar', color= ~county ) %>%
        layout(
            title = c("Trend of daily new confirmed COVID-19 cases by county in Maryland"),
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new confirmed cases"),
            barmode="stack",  
            legend = list(x = 0.1, y = 0.9, 
                          title=list(text='Counties with 50 or more cases'))
            )

```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data))

```{r}
dtafig<-dtafig%>%filter(latesttotal>=150)%>% arrange(county, date)
ncounty150<-n_distinct(dtafig$county)
ncounty150

dtafig<-dtafig%>%filter(latesttotal>=200)%>% arrange(county, date)
ncounty200<-n_distinct(dtafig$county)
ncounty200
```

And, below detailed figure is for `r ncounty200` counties with 200 or more confirmed cases. 

Again, [large spikes on April 8th may well be results of delayed processes in laboratory and/or data entry, not actual increases on that date](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).   

_Hover over each figure to see values and more options._
```{r plotTrendNewCasesCountyBar, results='asis', fig.align="left", out.width="800px", out.height="350px"}

panel <- . %>% 
  plot_ly(x=~date, y=~newcases, type = 'bar', marker=list(color=("'#1F77B4'")) ) %>%
  add_annotations(
    text = ~unique(county),
    x = 0.5, y = 0.9, xref = "paper", yref = "paper",    
    xanchor = "center", yanchor = "bottom", showarrow = FALSE,
    font = list(size = 10)
  ) %>%
  layout(
    showlegend = FALSE,
    xaxis=list(title = "Date",  
             font=list(size=10),
             tickfont = list(size=8) 
             ),
    yaxis=list(title = "New cases"))


dtafig<-dtafig%>%filter(latesttotal>=200)

#write.csv(dtafig, "KCOVID/dtaKCOVIDSouthKoreaUnlike1.csv")

dtafig%>%
    group_by(county) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 3, shareX = TRUE, shareY = FALSE)    
```

```{r fig.align="left", out.width="800px"}
countylist<-as.vector(as.data.frame(table(dtafig$county))$Var1)

#looping code not working to save a figure with a number! why??? 
for (i in 1:ncounty150){
    temp<-dtafig%>%filter(county==countylist[i])
}

listx<- list(title = "",  
             font=list(size=8),
             autotick = FALSE,
             tickfont = list(size=8), 
             tickangle=-90)

    temp<-dtafig%>%filter(county==countylist[1])
    fig1<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[1])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[2])
    fig2<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[2])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[3])
    fig3<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[3])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[4])
    fig4<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[4])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[5])
    fig5<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[5])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[6])
    fig6<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[6])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[7])
    fig7<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[7])%>%layout(xaxis=listx)    
    temp<-dtafig%>%filter(county==countylist[8])
    fig8<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[8])%>%layout(xaxis=listx)    
    temp<-dtafig%>%filter(county==countylist[9])
    fig9<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[9])%>%layout(xaxis=listx)      
    temp<-dtafig%>%filter(county==countylist[10])
    fig10<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[10])%>%layout(xaxis=listx)        
    temp<-dtafig%>%filter(county==countylist[11])
    fig11<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[11])%>%layout(xaxis=listx)            

listx<- list(title = "Date",  
             font=list(size=10),
             autotick = FALSE,
             showticklabels = TRUE, 
             tickfont = list(size=8), 
             tickangle=-90)

listy<- list(title = "Number of new confirmed cases")

listlegend <- list(font=list(size=10), orientation = "h",   
                        xanchor = "center", x=0.5, y=-0.15)

subplot(fig1 , fig2, fig3, fig4, fig5, fig6, fig7, fig8, fig9, fig10, fig11,
        nrows = 3, shareX = TRUE )%>%
    layout(title = c("Trend of daily new confirmed COVID-19 cases by county, among counties with 150+ cases"),
           xaxis=listx,  yaxis = listy, legend= listlegend)
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data))

```{r}
#{r plotnewcasesCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%select(date, county, cases)%>%arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(county!=lag(county), NA, newcases )
        )
str(table(dtafig$country))

plot_ly(dtafig, x=~date, y=~newcases, color= ~county, 
        type = 'scatter', mode='lines') %>%
    layout(
            title = "Trends of new confirmed COVID-19 cases per day by county in Maryland",
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new confirmed cases each day"),
            legend = list(font=list(size=8))
            )
```

#####__Q 1. How many confirmed cases do we have now, and where are they?__ 
```{r}
latestdatecounty<-max(dtacounty$date)
temp<-dtacounty%>%filter(date==latestdatecounty)
statecases<-sum(temp$cases)

ncounties<-dtacounty%>%filter(date==latestdatecounty)%>%nrow()
ncountiestotal<-dtapopcounty%>%filter(county!="Maryland")%>%nrow()
popstate<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(sum))

latestdateMD<-max(dtaMD$date)
casesMD<-dtaMD%>%filter(date==max(date))%>%select(cases)%>%summarize_all(funs(max))
incidencerateMD<-round(100000*casesMD/popstate, 0)
casesMD<-as.character(casesMD)

topincidencecounty<-dtacounty%>%filter(date==latestdatecounty)%>%mutate(incidence=round(cases*100000/pop), 0)%>%filter(county!="Unknown")%>%filter(incidence==max(incidence)) %>%select(county)
topincidencecounty<-topincidencecounty
topincidencecounty

```
As of `r latestdateMD` 10:00AM, __`r casesMD` confirmed cases have been reported in Maryland__, according to Maryland Department of Health. This means there are __`r incidencerateMD` people with confirmed COVID-19 per 100,000 population in the state__. 

Below figure shows number of confirmed cases by county by the end of `r latestdatecounty`.  

_Hover over each figure to see values and more options._
```{r plottotalcasesCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%filter(date==latestdatecounty)%>%select(date, county, cases)

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$cases, decreasing = TRUE)])

fig<-plot_ly(dtafig, x = ~county, y = ~cases, type="bar") %>%
        layout(
            title ="Number of total confirmed cases by county in Maryland",
            xaxis = list(title = "County",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Total number of confirmed cases")
            )
fig
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data))

__When we look at infection rates (i.e., number of confirmed cases per 100,000 population), `r topincidencecounty` county now has the highest rate currently__. 

_Hover over each figure to see values and more options._
```{r plotincidenceCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%filter(date==latestdatecounty)%>%
    select(date, county, cases, pop)%>%
    mutate(incidence=round(cases*100000/pop), 0)

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$incidence, decreasing = TRUE)])

fig<-plot_ly(dtafig, x = ~county, y = ~incidence, 
             type="bar", marker = list(color = 'rgb(252,141,89)')) %>%
        layout(
            title ="Incidence rate by county in Maryland",
            xaxis = list(title = "County",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Number of confirmed cases per 100,000 population")
            )
fig
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data), US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage))

```{r}
#####__Q 1. When and where was COVID-19 first reported in Maryland?__ 
firstdatestate<-mean(dtacounty$firstdatestate)

firstcountyname<-dtacounty%>%filter(firstcounty==TRUE)%>%select(county)
firstcountyname<-firstcountyname$county

#The first confirmed COVID-19 case was reported in __`r firstcountyname` county on `r firstdatestate`__. 
```

---

__Data sources__:  
1. All COVID-19 data for counties come from New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data). Accessed on `r date`.    
2. All COVID-19 data for Maryland disaggregated by age and sex come from [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/) by Maryland Department of Health. This dashboard presents latest numbers as of 10:00AM on each day. Accessed on `r date`.      
3. All data on county population come from US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage). Accessed on March 29, 2020.   
4. Data on Maryland population by age and sex come from Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx). Accessed on April 1, 2020.    

---

<p style="color:gray">
See [GitHub](https://github.com/yoonjoung/COVID19_MD) for data, code, and more information. 
For typos, errors, and questions, contact me at [www.isquared.global]("https://www.iSquared.global/YJ")</p>

_Making Data Delicious, One Byte at a Time_, in good times and bad times.