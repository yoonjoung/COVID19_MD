---
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
---
```{r intro, echo=FALSE, results="hide"}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      comment = "", 
                      warning=FALSE, 
                      results="hide") 
knitr::opts_knit$set(root.dir = "C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/")

date<-as.Date(Sys.time(	), format='%d%b%Y')
time<-Sys.time()

suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(ggplot2)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(readxl)))
suppressWarnings(suppressMessages(library(plotly)))
suppressWarnings(suppressMessages(library(Matrix)))
suppressWarnings(suppressMessages(library(stringr)))
suppressWarnings(suppressMessages(library(stringi)))

suppressWarnings(suppressMessages(library(jsonlite)))
suppressWarnings(suppressMessages(library(httr)))
suppressWarnings(suppressMessages(library(rlist)))
suppressWarnings(suppressMessages(library(zoo)))
suppressWarnings(suppressMessages(library(RColorBrewer))) 
suppressWarnings(suppressMessages(library(lubridate)))
```

```{r dataPop}
dtapopcounty<-read.csv("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataCensusBureau/co-est2019-alldata.csv")

names(dtapopcounty)<- tolower(names(dtapopcounty))   
dtapopcounty<-dtapopcounty%>%select(stname, ctyname, popestimate2019)%>%
    filter(stname=="Maryland")%>%
    mutate(pop=popestimate2019, 
           state=as.character(stname), 
           county=str_remove(as.character(ctyname), " County")
           )%>%
    select(state, county, pop)%>%
    filter(state=="Maryland")

#View(dtapopcounty)
```

```{r dataByCounty}
url<-"https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
dtacases<-read.csv(url)

dtacounty<-read.csv(url)%>%
    mutate(
        date=as.Date(as.character(date)),
        state=as.character(state),
        county=as.character(county)
    )

dtacounty<-dtacounty%>%
    filter(state=="Maryland")%>%
    mutate(
        firstdatestate=min(date), #first date for the state
        firstcounty=FALSE, 
        firstcounty=ifelse(firstdatestate==date, TRUE, firstcounty),
        firstcountyname="", 
        firstcountyname=ifelse(firstcounty==TRUE, county, firstcountyname) 
    )%>%
    group_by(date)%>%
    mutate(
        numcounties= n_distinct(county)#number of affected counties by date
    )%>%ungroup()%>%
    group_by(county)%>%
    mutate(
        firstdatecounty=min(date),#first date by county 
        latestdatecounty=max(date),#latest update date by county
        latesttotal=max(cases)#latest cumulative number
    )%>%ungroup()%>%
    arrange(county, date)

dim(dtacounty)
dtacounty<-left_join(dtacounty, dtapopcounty, by = "county")%>%filter(county!="Maryland") 
dim(dtacounty)


```

```{r dataMD}
#DATA FROM MDHD
dtaMD<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/MDHealthDepartmentDashboard.xlsx")
str(dtaMD)

names(dtaMD)<- tolower(names(dtaMD))   
dtaMD<-dtaMD%>%
    filter(group=="total")%>%
    mutate(    
        cases=as.numeric(str_replace_all(stri_trim_both(cases), fixed(","),"")),
        negativetest=as.numeric(str_replace_all(stri_trim_both(negativetest), fixed(","),"")),
        deaths=as.numeric(str_replace_all(stri_trim_both(deaths), fixed(","),"")),
        probabledeaths=as.numeric(str_replace_all(stri_trim_both(probabledeaths), fixed(","),"")),
        hospitalizations=as.numeric(str_replace_all(stri_trim_both(hospitalizations), fixed(","),"")),
        releasedfromisolation=as.numeric(str_replace_all(stri_trim_both(releasedfromisolation), fixed(","),"")),
        totaltests=cases+negativetest
    )%>%
    arrange(date)%>%
    mutate(
        newcases=lead(cases)-cases,
        newtests=lead(totaltests)-totaltests
    )%>%
    select(date, cases, negativetest, deaths, hospitalizations, releasedfromisolation, totaltests, probabledeaths, starts_with("new"))
str(dtaMD)

```

```{r}
temp<-dtaMD%>%select(date, cases, negativetest, totaltests, newcases, newtests)
tail(temp, 10)

```

```{r dataByAge}
#DATA FROM MDHD
dtapopbyage<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/CNTY-PopEst-2018.xlsx")%>%
    select(agegroup, pop10)%>%
    filter(is.na(pop10)==F)%>%
    filter(agegroup!="Total")%>%
    mutate(    
        age=as.numeric(sapply(strsplit(agegroup,"-"), `[`, 1)) 
    )%>%
    select(age, pop10)

dtabyage<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/MDHealthDepartmentDashboard.xlsx")

names(dtabyage)<- tolower(names(dtabyage))   
dtabyage<-dtabyage%>%
    filter(group=="age")%>%
    mutate(    
        grouplabel=ifelse(grouplabel=="80+", "80", grouplabel), 
        age=as.numeric(sapply(strsplit(grouplabel,"-"), `[`, 1)),
        agegroup=grouplabel, 
        agegroup=ifelse(age==80, "80+", agegroup), 
        cases=as.numeric(cases), 
        deaths=as.numeric(deaths),
        probabledeaths=as.numeric(probabledeaths) 
    )%>%
    select(date, age, agegroup, cases, deaths, probabledeaths)

dim(dtabyage)
dtabyage<-left_join(dtabyage, dtapopbyage, by = "age")
dim(dtabyage)

dtabyage<-dtabyage%>%
    mutate(
        incidence=round(cases*100000/pop10, 1), 
        cfr=round(100*deaths/cases, 3), 
        cfrprobable=round(100*(deaths+probabledeaths)/(cases+probabledeaths), 3), 
        cfrextra=cfrprobable - cfr, 
        temp=max(date),
        latest=date==temp
    )%>%select(-temp)
```

```{r dataByRace}
#Total pop
popMD<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(mean))

#pop data FROM MD planning deparment 
dtapopbyrace<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/table1a.xlsx")%>%
    filter(is.na(pop)==F)%>%
    mutate(
        popMD=as.numeric(popMD),
        pop=round(popMD*pctpop, 0)
    )%>%select(race, pop)%>%
    group_by(race)%>%summarize_all(funs(sum))%>%filter(is.na(pop)==F)

#COVID data by race
dtabyrace<-read_excel("C:/Users/YoonJoung Choi/Dropbox/0 Project/COVID19_US/DataMD/MDHealthDepartmentDashboard.xlsx")

names(dtabyrace)<- tolower(names(dtabyrace))   
dtabyrace<-dtabyrace%>%
    filter(group=="race")%>%
    mutate(    
        race=grouplabel, 
        cases=as.numeric(cases),
        deaths=as.numeric(deaths),
        probabledeaths=as.numeric(probabledeaths)
    )%>%
    select(date, race, cases, deaths, probabledeaths)

table(dtapopbyrace$race)
table(dtabyrace$race)

dim(dtabyrace)
dtabyrace<-left_join(dtabyrace, dtapopbyrace, by = "race")
dim(dtabyrace)

dtabyrace<-dtabyrace%>%
    mutate(
        incidence=round(cases*100000/pop, 1), 
        cfr=round(100*deaths/cases, 3), 
        cfrprobable=round(100*(deaths+probabledeaths)/(cases+probabledeaths), 3), 
        cfrextra=cfrprobable - cfr, 
        mortality=round(100000*(deaths)/pop, 3),
        mortalityprobable=round(100000*(deaths+probabledeaths)/pop, 3), 
        temp=max(date),
        latest=date==temp
    )%>%select(-temp)
```

```{r dtaGlobal}
url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"

dtacases<- read.csv(url)%>%
    rename(country = Country.Region,
           region = Province.State)%>%
    mutate(country=as.character(country), 
           country=ifelse(country=="Korea, South", "South Korea", country))%>%
    filter(country=="South Korea" | country=="Italy")%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           cases = value, 
           group = country)%>%
    select(group, date, cases)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()
            
url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"
dtadeaths<- read.csv(url)%>%
    rename(country = Country.Region,
           region = Province.State)%>%
    mutate(country=as.character(country), 
           country=ifelse(country=="Korea, South", "South Korea", country))%>%
    filter(country=="South Korea" | country=="Italy")%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           deaths = value, 
           group = country)%>%
    select(group, date, deaths)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()

url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"

dtacasesMD<-read.csv(url)%>%
    rename(country = Country_Region,
           state = Province_State,
           county = Admin2)%>%
    filter(state=="Maryland" | state=="New York")%>%
    select(country, state, county, FIPS, Combined_Key, starts_with("X"))%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           cases = value)%>%
    mutate(group="",
           group=ifelse(state=="Maryland", "Maryland, US", group),
           group=ifelse(state=="New York", "New York, US", group))%>%
    select(group, date, cases)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()


url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv"

dtadeathsMD<-read.csv(url)%>%
    rename(country = Country_Region,
           state = Province_State,
           county = Admin2)%>%
        filter(state=="Maryland" | state=="New York")%>%
    select(country, state, county, FIPS, Combined_Key, starts_with("X"))%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           deaths = value)%>%
    mutate(group="",
           group=ifelse(state=="Maryland", "Maryland, US", group),
           group=ifelse(state=="New York", "New York, US", group))%>%
    select(group, date, deaths)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()

dtacases<-rbind(dtacases, dtacasesMD)
dtadeaths<-rbind(dtadeaths, dtadeathsMD)

dtacurve<-left_join(dtacases, dtadeaths, by = c("group", "date"))%>%
    mutate(
        date=mdy(substring(date, 2)), 
        pop=0,  
        pop=ifelse(group=="Maryland, US",  6045.680, pop), 
        pop=ifelse(group=="New York, US", 19453.561, pop), 
        pop=ifelse(group=="South Korea",  51269.183, pop), 
        pop=ifelse(group=="Italy",        60461.828, pop)
        )%>%
    arrange(group, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases),

        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(group!=lag(group), NA, newdeaths),
        
        incidence=round(100000*cases/(pop*1000), 1), # confiremd cases per 100,000 pop
        cfr=round(100*deaths/cases, 3), # deaths per 100 confirmed cases   
        mortality=round(100000*deaths/(pop*1000), 1) # deaths per 100000 pop
    )%>%arrange(group, date)%>%
    mutate(
        newcasessmooth =c(NA,NA,NA,rollmean(newcases, 7),NA,NA,NA), 
        newdeathssmooth=c(NA,NA,NA,rollmean(newdeaths, 7),NA,NA,NA), 
        newcasessmooth=ifelse(group!=lag(group), NA, newcasessmooth),
        newdeathssmooth=ifelse(group!=lag(group), NA, newdeathssmooth),
        newcasessmooth =round(newcasessmooth, 3),  
        newdeathssmooth=round(newdeathssmooth, 3),

        newcasessmoothpp=round(100*newcasessmooth/pop, 1),   
        newdeathssmoothpp=round(100*newdeathssmooth/pop, 1)
       
		)

#data quality problem: cumulative deaths and acses going down in some cases 

#Force negative smooth numbers to 0 

dtacurve<-dtacurve%>%
    mutate(
        newcasessmooth   =ifelse(newcasessmooth<0,    0, newcasessmooth),
        newcasessmoothpp =ifelse(newcasessmoothpp<0,  0, newcasessmoothpp),
        newdeathssmooth  =ifelse(newdeathssmooth<0,   0, newdeathssmooth),
        newdeathssmoothpp=ifelse(newdeathssmoothpp<0, 0, newdeathssmoothpp)
    )

```

#####__COVID-19 in Maryland, US: Daily Updates and Insights with Granular Local Data__ 

(Updated: `r time` EDT)  

So, I have been watching the epidemic in China and Korea since the beginning, but it is still not easy to settle into this reality here in the US. 

* First of all, everyone, __STAY HEALTHY and [see what YOU can do](https://www.cdc.gov/coronavirus/2019-ncov/protect/index.html)__! 

* Second, there are many excellent news articles and information sources, but I'm sharing some more __questions (see left panel) and answers for those who are curious about a specific situation in Maryland, US - especially including local data__. Maryland is my beautiful adopted home state of over 20 years. The State is doing its best with strong leadership, but this virus arrived here when the country was not ready and is spreading fast unfortunately... 

_See footnote for further information about data sources. More questions and answers will be added, as more local data become available._ 

(Sorry, this is not mobile device friendly, and is best viewed on your regular monitor.)

---

#####__Q 9. Maryland starts phase-2 reopening from June 12th. How important is social distancing? (NEW)__ 

__VERY IMPORTANT!__ The state starts [phase-2 reopening](https://www.wbaltv.com/article/coronavirus-recovery-plan-maryland-stage-two-update-governor-larry-hogan/32824562) on June 12th for various reasons. The number of new cases is declining (see Question 2). Test positivity rate is decreasing (see Question 4). Hospitalization is decreasing and under the state capacity threshold. Economic reasons are important, too.  

However, __the number of new confirmed cases is substantially higher currently than in early March__ (see below also Question 2). In other words, __without following strict preventive guidelines, our chance of getting infected is actually higher now than in early March__, since there is a higher proportion of the state population who are likely contagious. You may wonder if this higher number of new cases now is because of more testing, thus maybe things are potentially better now than in early March. That's possible (since we know very little about the level back then), but probably unlikely.       

Still not convinced? Think this way. As of June 10, when the phase-2 reopening was announced, __our current level of new infections ([11 per 100,000 population](https://rpubs.com/YJ_Choi/COVID19_US_states_curve)) is about 9 times higher than the peak level in [South Korea](https://rpubs.com/YJ_Choi/COVID19_SouthKorea) (back in early March) and also higher than the peak level in Italy, an earlier epicenter in Europe, (back in late March)__ ([see here for more international comparisons](https://rpubs.com/YJ_Choi/KCOVID_Global)).   

We may reopen. But, __we must keep social distancing seriously__. Again, here are [business guidelines from the state](https://commerce.maryland.gov/Documents/BusinessResource/Restaurants-bars-COVID-19-Best-Practices.pdf) and [preventive guidelines from CDC](https://www.cdc.gov/coronavirus/2019-ncov/protect/index.html).  

```{r plotMD_Global, results="asis", fig.align="left", out.width="800px"}


dtafig<-dtacurve%>%
    select(group, date, newcasessmoothpp)%>%
    mutate(
        group=paste0("Y_",group)
    ) %>% 
    arrange(date, group) %>% 
    spread(group, newcasessmoothpp, fill = NA, convert = FALSE)%>%
    rename(Y_MD = "Y_Maryland, US",
           Y_NY = "Y_New York, US",
           Y_SK = "Y_South Korea")

plot_ly(dtafig, x=~date, y=~Y_MD, name = "Maryland, US", 
        type = 'scatter', mode='lines', line = list(color = c("#1f77b4")),
        hoverinfo = 'text',
        text = ~paste(
                      '</br> Date: ', date,
                      '</br> New cases per 100,000: ', Y_MD)) %>%
    add_trace(y=~Y_Italy, name="Italy", line = list(color = c("#e34a33")) ,
            hoverinfo = 'text',
            text = ~paste(
                          '</br> Date: ', date,
                          '</br> New cases per 100,000: ', Y_Italy)) %>%
    add_trace(y=~Y_SK, name="South Korea", line = list(color = c("#b30000")) ,
            hoverinfo = 'text',
            text = ~paste(
                          '</br> Date: ', date,
                          '</br> New cases per 100,000: ', Y_SK)) %>%
    layout(showlegend=TRUE,
           title = "New cases per 100,000 population (7-day rolling average)", 
           xaxis = list(title = "Date", 
                        tickfont = list(size=10)),
           yaxis = list(title = "Daily new confirmed cases per 100,000 population"), 
           legend = list(font=list(size=12), 
                      orientation = "v", xanchor = "left",  
                      x=0.1, y=0.9)    
           )

#    add_trace(y=~Y_NY, name="New York, US", line = list(color = c("#fc8d59")) ,
#            hoverinfo = 'text',
#            text = ~paste(
#                          '</br> Date: ', date,
#                          '</br> New cases per 100,000: ', Y_NY)) %>%
```
(Date sources: [JHU/CSSE COVID-19 Dashgboard](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data), [World Population Prospects 2019 Revision](https://population.un.org/wpp/), [Maryland Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx)) 

---

#####__Q 8.1 What do we know about changing (or not) demographic background of people with confirmed COVID-19? (NEW)__ 

Among those with COVID-19, the proportions of younger population have increased. Also, the proportions of minority groups, __especially Hispanics__, have increased. __Only 10% of population is Hispanic (as of 2018), but one third of confirmed cases belong to Hipanic population__.    

It is important to know _age composition within each race_ as well. As of early June, only three states in the US publish such data, and Maryland is not one of them unfortunately.   

```{r plotcompositiontrend, results="asis", fig.align="left", out.width="800px"}
### cases

dtafig <- dtabyage%>%
    select(date, age, agegroup, cases, pop10)%>%
    filter(is.na(age)==FALSE)%>%
    group_by(date)%>%
    mutate(
        total=sum(cases),
        pct=round(100*cases/total,1), 
        totalpop=sum(pop10),
        pctpop=round(100*pop10/totalpop,1) )%>%
    ungroup()

dtapopbyage <- dtafig%>%filter(date==max(date))%>%select(agegroup, pop10, totalpop, pctpop)

#head(dtapopbyage, 10)

fig1<-dtafig %>% group_by(agegroup) %>% 
    arrange(date) %>%
    plot_ly( x = ~date, y = ~pct, type = "bar",
             color= ~agegroup, 
             colors = brewer.pal(length(unique(dtafig$agegroup)),
                                "Spectral")
             ) %>%
    layout(
        title ="Composition by age-group among confirmed COVID-19 cases over time, Maryland", 
        yaxis = list(title = "Percent of confirmed cases",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

fig1

dtafig <- dtabyrace%>%
    select(date, race, cases, pop)%>%
    filter(is.na(race)==FALSE)%>%
    filter(race!="Missing")%>%
    mutate(
        raceorder="", 
        raceorder=ifelse(race=="White", "1 White", raceorder),
        raceorder=ifelse(race=="African-American", "2 African-American", raceorder),
        raceorder=ifelse(race=="Hispanic", "3 Hispanic", raceorder),
        raceorder=ifelse(race=="Asian", "4 Asian", raceorder),
        raceorder=ifelse(race=="Other", "5 Other", raceorder)
        )%>%
    group_by(date)%>%
    mutate(
        total=sum(cases),
        pct=round(100*cases/total,1), 
        totalpop=sum(pop),
        pctpop=round(100*pop/totalpop,1) )%>%
    ungroup()

dtapopbyrace <- dtafig%>%filter(date==max(date))%>%select(raceorder, pop, totalpop, pctpop)

#head(dtapopbyrace, 10)

fig2<-dtafig %>% group_by(raceorder) %>% 
    arrange(date) %>%
    plot_ly( x = ~date, y = ~pct, type = "bar",
             color= ~raceorder, 
             colors = brewer.pal(length(unique(dtafig$raceorder)),
                                "PuBu")
             ) %>%
    layout(
        title ="Composition by race* among confirmed COVID-19 cases over time, Maryland", 
        yaxis = list(title = "Percent of confirmed cases",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 
fig2

#subplot(fig1, fig2, 
#        nrows=1, margin=0.05, shareY = TRUE, shareX = TRUE) %>%
#        layout(  title ="Changing composition by age and race among confirmed COVID-19 cases, Maryland")
```
_NOTE on race data_: composition excluding cases with unknown race. Hispanic was not reported as a separate category until April 15th.  

#####__Q 8.2. Does it explain slightly decreasing mortality?__ 

Yes, at least partially. There is a very strong age-pattern in COVID-19 mortality (i.e., the older, the higher risk of dying), and having proportionately more younger people with COVID-19 would lower _overall, all-age, case fatality rate_, which has declined slightly (See Question 5). In addition, importantly, a recent study showed [how hospital care might have improved and saved lives more effectively over time, even just over several weeks](https://www.bmj.com/content/369/bmj.m1966). 

At the same time, minority populations [have lower health insurance coverage](https://www.kff.org/disparities-policy/issue-brief/changes-in-health-coverage-by-race-and-ethnicity-since-the-aca-2010-2018/) and [receive lower quality of care](https://www.ahrq.gov/research/findings/nhqrdr/nhqdr18/index.html) than White population in the US. So, having proportionately more minorities means access to quality health care may decrease among people with confirmed cases.     

---

#####__Q 7. How has mortality changed over time by age?__

Answers to Question 5 show latest case fatality rate (i.e., deaths per 100 COVID-19 cases) by county and how it has changed in the State. But, how about across different age groups? __Case fatality rate has increased continuously in older age groups. The rate of increase is highest among people who are 80 and older__.  

```{r plotmortalitytrendbyage, results="asis", fig.align="left", out.width="800px"}
    #add_trace(        y=~cfrprobable, name="CFR",        type='scatter',mode = 'lines',         marker=list(color = c( "gray"), size = 1),        line=list(color = c( "gray"))        )%>%
    
panel <- . %>% 
    plot_ly(x=~date, 
            y=~cfr, name="CFR including probable cases/deaths",
            type = 'scatter', mode = 'lines'
            ) %>%
    add_annotations(
        text = ~unique(agegroup),
        x = 0.5, y = 0.9, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        showlegend = FALSE,
        title=c("Trend of case fatality rate by age group"),
        xaxis=list(title = "Date", tickfont = list(size=8)),
        yaxis=list(title = "Case fatality rate (%)", 
                   range=c(0.2, upperrange))
        
        )

upperrange<-round(max(dtabyage$cfrprobable)+1) 

dtabyage%>%filter(age>=50)%>%
    group_by(agegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE)  
```
(__Note__: case fatality rate including only lab-confirmed COVID-19 deaths and cases. See Question 5 for comparison between case fatality rates _with vs. without_ probable deaths/cases.) 

---

#####__Q 6. How has it affected population across different races? And, how has it changed over time?__

The Maryland Department of Health started publishing data by race (i.e., the number of cases and deaths by race) on April 9th, following an upsetting report about racial disparity in COVID mortality in the US: [higher morality in states with higher proportions of black population](https://www.washingtonpost.com/nation/2020/04/07/coronavirus-is-infecting-killing-black-americans-an-alarmingly-high-rate-post-analysis-shows/?arc404=true). Further data - specifically disaggregated by individual people's race, beyond the state-level analysis - are crucial to monitor and understand the disparity. Also, though initially unavailable, __a separate category for Hispanic population is published on April 15__. As a resident of Maryland, I am very proud of the state's rapid action to publish race data!

```{r}
incidencetop<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(incidence==max(incidence))%>%select(incidence)%>%
    summarize_all(funs(max))
                            
incidencetoprace<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(incidence==max(incidence))%>%select(race)
incidencetoprace<-incidencetoprace$race

missingracecases<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(race=="Missing")%>%select(cases)%>%
    summarize_all(funs(mean))
allcases<-dtabyrace%>%filter(latest==TRUE)%>%select(cases)%>%
    summarize_all(funs(sum))
missingracepct<-round(100*missingracecases/allcases, 0)

```

```{r plotbyracecases, fig.align="left", out.width="500px"}
dtafig<-dtabyrace%>%filter(date==max(date))

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$cases, decreasing = TRUE)])

plot_ly(dtafig, x=~race, y=~cases, type = 'bar', name="confirmed cases")%>% 
    layout(
            title = c("COVID-19 cases by race"),
            yaxis = list(title = "Number of confirmed cases")
            )
```

Now with Hispanic population disaggregated from "other", the pattern of incidence and mortality by race/ethnicity can be examined better. In terms of rates (important to compare across races with different population sizes), __the incidence rate is substantially higher among Hispanic, followed by African American population__ (blue bars). And, __incidence rate among Hispanic population has increased most rapidly__ - see the second figure below.   

However, __case fatality rate is highest among White and Asian Americans__ (orange bars). This implies that __the disproportionately higher number of deaths among African American population in Maryland is because of the higher rate of infection, not because of higher risk of dying among those who are infected__. At the same time, it is notable that, though the infection rate is lower, mortality risk is higher among Asian Americans in Maryland.    

To understand reasons behind this, we will need to learn more about characteristics of patients by race (e.g., Do Asian Americans with COVID tend to be older and/or have existing conditions in Maryland? Are Hispanic Marylanders with COVID younger than their counterparts?) and any differences in access to health care by race among COVID patients. Also, __what can we do to reduce the higher infection rate among African Americans and Hispanic population in Maryland?__ Finally and importantly, if and when we have better data on race (i.e., less cases with missing race information), the findings on racial disparity may well change (see below note on race data in Maryland).    

_Hover over each figure to see values and more options._

```{r plotbyracerates, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabyrace%>%filter(date==max(date))%>%
    filter(race!="Missing")%>%filter(race!="Other")

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$incidence, decreasing = TRUE)])

figincidencerate<-plot_ly(dtafig, x=~race, y=~incidence, type = 'bar', name="Cases per 100,000 population")%>% 
    layout(
            xaxis = list(title = "Race",  
                         titlefont=list(size=10), 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10)),
            yaxis = list(title = "Cases per 100,000 population", 
                         titlefont=list(size=10) )
            )

dtafig<-dtabyrace%>%filter(date==max(date))%>%
    filter(race!="Missing")%>%filter(race!="Other")

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$cfr, decreasing = TRUE)])

figcfr<-plot_ly(dtafig, x=~race, y=~cfr, type = 'bar' , name="Deaths per 100 cases (%)")%>% 
    layout(
            xaxis = list(title = "Race",  
                         titlefont=list(size=10), 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10)),
            yaxis = list(title = "Deaths per 100 cases (%)",
                         titlefont=list(size=10) )
            )

subplot(figincidencerate, figcfr, 
        nrows=1, margin=0.05, shareY = FALSE, titleY = TRUE) %>%
        layout(  title ="Cumulative incidence and case fatality rates by race in Maryland", 
                 showlegend=FALSE  )
```
(__Note__: case fatality rate including only lab-confirmed COVID-19 deaths and cases. See Question 5 for comparison between case fatality rates _with vs. without_ probable deaths/cases.)   
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))
 

```{r plottrendbyrace, results="asis", fig.align="left", out.width="800px"}

dtafig<-dtabyrace%>%select(date, race, incidence)%>%
    mutate(
        race=ifelse(race=="African-American", "AfricanAmerican", race), 
        race=paste0("incidence",race)
    )%>%
    arrange(date, race)%>% 
    spread(race, incidence, fill = NA, convert = FALSE) 

maxy<-max(dtabyrace$incidence)

figincidenceratetrend<-plot_ly(dtafig, x=~date, y=~incidenceAfricanAmerican, name = "African-American", 
               type = 'scatter', mode='lines',
               line = list(color = c( "#d62728"))) %>% 
    add_trace(y = ~incidenceAsian, name = "Asian", line = list(color = c( "#ff7f0e"))) %>% 
    add_trace(y = ~incidenceHispanic, name = "Hispanic", line = list(color = c( "#2ca02c"))) %>% 
    add_trace(y = ~incidenceWhite, name = "White", line = list(color = c( "#1f77b4"))) %>%  
    layout(
        title ="Trends of cumulative incidence rate by race",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of confirmed cases (per 100,000 population)",
                     titlefont=list(size=10),
                     tickfont=list(size=10),
                     range=c(0, maxy) ), 
        legend = list(font=list(size=10), 
                      orientation = "h", xanchor = "center",  
                      x=0.5, y=-0.1)               
        ) 

dtafig<-dtabyrace%>%select(date, race, cfr)%>%
    mutate(
        race=ifelse(race=="African-American", "AfricanAmerican", race), 
        race=paste0("cfr",race)
    )%>%
    arrange(date, race)%>% 
    spread(race, cfr, fill = NA, convert = FALSE) 

maxy<-max(dtabyrace$cfr)+1

figcfrtrend<-plot_ly(dtafig, x=~date, y=~cfrAfricanAmerican, name = "African-American", 
               type = 'scatter', mode='lines',
               line = list(color = c( "#d62728"))) %>% 
    add_trace(y = ~cfrAsian, name = "Asian", line = list(color = c( "#ff7f0e"))) %>% 
    add_trace(y = ~cfrHispanic, name = "Hispanic", line = list(color = c( "#2ca02c"))) %>% 
    add_trace(y = ~cfrWhite, name = "White", line = list(color = c( "#1f77b4"))) %>%   
    layout(
        title ="Trends of case fatality rate by race",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of deaths per 100 cases (%)",
                     titlefont=list(size=10),
                     tickfont=list(size=10),
                     range=c(0, maxy)), 
        legend = list(font=list(size=10), 
                      orientation = "h", xanchor = "center",  
                      x=0.5, y=-0.1)          
        ) 

subplot(figincidenceratetrend, figcfrtrend, 
        nrows=1, margin=0.05, shareY = FALSE, titleY = TRUE) %>%
        layout(  title ="Trends of cumulative incidence and case fatality rates by race in Maryland" , 
                 showlegend=TRUE, 
                 legend=list(font=list(size=9))
                 )

```            
(__Note__: case fatality rate including only lab-confirmed COVID-19 deaths and cases. See Question 5 for comparison between case fatality rates _with vs. without_ probable deaths/cases.)    
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))

__Important note on race data in Maryland__:   
1. _`r missingracepct` % of cases do not have race information_. This is likely because [private labs are not required to report race](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-race-data-20200409-ffim7y4bljcz3hjk4dmt773mp4-story.html). All data shown here is only based among cases and deaths with known race.   
2. In Maryland, "Other" population includes: American Indian and Alaska Native, Native Hawaiian and Other Pacific Islander, and 'Two or more races' - accounting for about 3% of total population in the state. Figures do not include "Other" races, given possibility that Hispanic population might have been included in this category initially. 

---

#####__Q 5. What is the latest mortality, and how has it changed?__ 
```{r}
latestdateMD<-max(dtaMD$date)

deathsMD<-dtaMD%>%filter(date==max(date))%>%select(deaths)%>%summarize_all(funs(mean))
casesMD<-dtaMD%>%filter(date==max(date))%>%select(cases)%>%summarize_all(funs(mean))
cfrMD<-round(100*deathsMD/casesMD, 1)

probabledeathsMD<-dtaMD%>%filter(date==max(date))%>%select(probabledeaths)%>%summarize_all(funs(mean))
cfrprobableMD<-round(100*(deathsMD+probabledeathsMD)/(casesMD+probabledeathsMD), 1)

latestdatecounty<-max(dtacounty$date)
```
As of `r latestdateMD` 10:00AM, according to Maryland Department of Health, __`r deathsMD` COVID-19 deaths have occurred, that had been laboratory-confirmed__. In addition, MD Health Department has published the number of probably COVID deaths since April 15. There have been __`r probabledeathsMD` probable COVID-19 deaths__, for which death certificate lists COVID-19 as the cause of death but not yet confirmed by a laboratory test. This means case fatality rate can be calculated _with vs. without_ the probable deaths (which are thus probable cases as well). Case fatality rate is: 

* __`r cfrMD`__ % based on only laboratory confirmed cases and deaths.   
* __`r cfrprobableMD`__ % based on laboratory confirmed as well as probable cases and deaths. 

Given relatively small differences across groups (i.e., by age, sex, and race, results now shown), __only laboratory-confirmed COVID-19 deaths and cases are used throughout this report__. I will keep monitoring how the two approaches produce different/similar results, and update as needed. 

Below figure shows mortality by county - in terms of both absolute number (red bars) and case fatality rate (orange bars) as of `r latestdatecounty`.  

```{r plotdeathsCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%filter(date==latestdatecounty)%>%
    filter(deaths>0)%>%
    filter(county!="Unknown")%>%
    select(date, county, deaths, cases)%>%mutate(cfr=round(100*deaths/cases, 1))

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$deaths, decreasing = FALSE)])

fig1<-plot_ly(dtafig, y = ~county, x = ~deaths, type="bar", orientation="h",
              name = "lab confirmed COVID-19 deaths", 
              marker = list(color = c( "#d62728"))) %>%
        layout(
            title ="Absolute number of COVID-19-positive deaths by county in Maryland",
            yaxis = list( 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=9)
                         ),
        xaxis = list(title = "Total number of deaths")
            )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$cfr, decreasing = FALSE)])

fig2<-plot_ly(dtafig, y = ~county, x = ~cfr, type="bar", orientation="h",
              name="Deaths per 100 cases (%)",
              marker = list(color = c( "#ff7f0e"))) %>%
        layout(
            title ="COVID-19 case fatality rate by county in Maryland",
            yaxis = list(  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=9) 
                    
                         ),
            xaxis = list(title = "Deaths per 100 cases (%)")
            )

subplot(fig1, fig2, titleX = TRUE) %>%
        layout(
            title ="COVID-19 mortality by county in Maryland",
            legend = list(orientation = "h",   
                        xanchor = "center",  
                        x=0.5, y=-0.4)            
            )

```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data), US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage))

Below chart shows the mortality trends, since March 18 when the first COVID-19 death was reported in Maryland. Globally in countries severely affected by the epidemic before US, case fatality rates increased rapidly in the beginning. The rates then stabilized in some of the countries, depending on health systems' response and characteristics of patient population.  

```{r plotcfrMDtrends, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%select(date, deaths, cases)%>%
    group_by(date)%>%
    summarize_all(funs(sum))%>%
    mutate(cfr=round(100*deaths/cases, 1))%>%
    filter(cfr>0)

plot_ly(dtafig, x = ~date, y = ~cfr, type="bar", 
        marker=list(color = c( "#ff7f0e"))
        ) %>%
        layout(
            title ="Trend of COVID-19 case fatality rate in Maryland",
            xaxis = list( 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Deaths per 100 confirmed cases (%)")
            )
```

```{r plotdeathsMDtrends, fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%select(date, deaths, cases)%>%
    group_by(date)%>%
    summarize_all(funs(sum))%>%
    mutate(cfr=round(100*deaths/cases, 1))%>%
    filter(cfr>0)

plot_ly(dtafig, x = ~date, y = ~deaths, type="bar") %>%
        layout(
            title ="Trends of COVID-19 mortality in Maryland",
            xaxis = list( 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=11), 
                         tickangle=-90
                         ),
            yaxis = list(title = "Number of COVID-19 deaths")
            )
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data), US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage))

---

#####__Q 4. How extensive has testing been? How has the test positivity rate changed?__ 

```{r}
firstdateMD<-min(dtaMD$date)
latestdateMD<-max(dtaMD$date)
totaltestMD<-dtaMD%>%filter(date==max(date))%>%select(totaltests)%>%summarize_all(funs(max))

popstate<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(sum))
testrateMD<-round(1000*totaltestMD/popstate, 1)
totaltestMD<-as.character(totaltestMD)

#The State has tested 220,880 individuals, with 15,694 new people tested on March 31.
#https://coronavirus.health.ny.gov/home
totaltestNY<-as.vector(220880)
popstateNY<-as.vector(19500000)
testrateNY<-round(1000*totaltestNY/popstateNY, 0)
latestnewtestsNY<-"15,694"
```

```{r}
temp<-dtaMD%>%
    select(date, cases, newcases,  negativetest, totaltests, newtests)%>%
    mutate(notestdata=(date>as.Date("2020-03-11") & date< as.Date("2020-03-29")) ,
           newtests=ifelse(notestdata==TRUE, NA, newtests), 
           positiverate=round(100*(newcases/newtests), 1), 
           positiverate=ifelse(date==min(date), NA, positiverate),  
           positiverate=ifelse(notestdata==TRUE, NA, positiverate), 
           positiveratesmooth =round(c(NA,NA,NA,rollmean(positiverate, 7),NA,NA,NA), 1), 
           positiveratesmooth =ifelse(positiveratesmooth<0,  0, positiveratesmooth)
           )%>%
    filter(is.na(positiveratesmooth)==FALSE)%>%filter(date==max(date))
                                                                 
positiveratesmoothlatest<-mean(temp$positiveratesmooth)    

positiveratesmoothlatest

```
This is a very important question, since the magnitude of testing over time is critical information to understand the epidemic. I got trend data on testing in Maryland from [COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/) by Maryland Department of Health also [COVID Tracking Project](https://covidtracking.com/data/state/maryland#historical) for earlier data. Still, data on the number of new tests are not available between 3/12 and 3/28. 

As of `r latestdateMD` 10:00AM, __a total of `r totaltestMD` tests have been conducted__. There are about 6 million people in Maryland, and this means __`r testrateMD` tests have been conducted in every 1000 people__. 

However, __a high rate of positive test, `r positiveratesmoothlatest` % (average over the latest 7-day data)__, indicates that testing is still limited to those with symptoms primarily, not based on effective contact tracing. Ideally, the positive test rate should be well below 10%.

```{r plotTrendNewTestsMD, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtaMD%>%select(date, cases, newcases,  negativetest, totaltests, newtests)%>%
    mutate(notestdata=(date>as.Date("2020-03-11") & date< as.Date("2020-03-29")) ,
           newtests=ifelse(notestdata==TRUE, NA, newtests), 
           #positiverate=round(100*(cases/totaltests), 1), 
           positiverate=round(100*(newcases/newtests), 1), 
           positiverate=ifelse(date==min(date), NA, positiverate),  
           positiverate=ifelse(notestdata==TRUE, NA, positiverate), 
           
           positiveratesmooth =round(c(NA,NA,NA,rollmean(positiverate, 7),NA,NA,NA), 1), 
           positiveratesmooth =ifelse(positiveratesmooth<0,  0, positiveratesmooth)
           )


fig<-plot_ly(dtafig, x=~date, y=~newtests, type = 'bar') %>%
    #, name="Total tests"     
    #add_trace(y=dtafig$newcases, name = 'Positive tests') %>%
        layout(
            annotations= list(x = "2020-03-22",
                              y = 5500,
                              text = "Total number of new tests not available between 3/12-3/28",
                              font = list(color = 'gray', size = 12),
                              xref = "x",
                              yref = "y",
                              showarrow = FALSE),
            title = "Trend of daily new COVID-19 tests in Maryland",
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new tests"))

plot_ly(dtafig, x=~date, 
        y=~newtests, name="New tests per day",
        type='bar',  
        marker=list(color = c( "#8DB9D9"), opacity=1, size=2)
        ) %>%
    add_lines(
        y=~positiveratesmooth, name="Positive rate, 7-day average", 
        marker=list(color = "black"),
        line=list(color = "black"),
        yaxis='y2')%>%
    add_segments(x = min(dtafig$date), xend = max(dtafig$date), 
                 y = 10, yend = 10,yaxis='y2', 
                 marker = list(color = "gray",size = 2),
                 line= list(color = "gray",  dash = 'dot'),
                 showlegend=FALSE)%>%
    layout(
        title = c("Trend of daily tests and positive test rate"),
        xaxis = list(title = "", tickfont = list(size=10), showgrid = FALSE), 
        yaxis = list(title = "Number of tests", 
                     range=c(0, 10000),
                     side="left", showgrid = FALSE ),
        yaxis2 = list(title = "Positive rate (%)", 
                      range=c(0, 40),
                      overlaying='y',  
                      side="right", showgrid = FALSE),
        margin = list(r=100), 
        legend=list(orientation="v", xanchor = "left", yanchor = "center", 
                    x = 0.1, y = 0.8) 
        
        ) 


```
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/))

_Note 1_: On May 28th, Maryland Health Department started publishing ["total testing volume"](https://coronavirus.maryland.gov/)". However, it is unclear what a unit of testing is, since the volume is about 15% higher than the sum of "Number of confirmed cases" and "Number of persons tested negative", as of May 28, 2020. Until this is clarified, the test positivity in this report is calculated consistently as percent of "number of _new_ confirmed cases" out of "number of _new_ confirmed cases AND number of _new_ persons tested negative." The number of _new_ cases/persons is a difference between cumulative numbers over two consecutive days, which are published by the state. Then, the test positivity rates are averaged over 7 days.      

_Note 2_: On May 28th, Maryland Health Department also started publishing ["Percent positive testing, all jurisdictions"](https://phpa.health.maryland.gov/Documents/Positivity%20by%20Jurisdiction.pdf)".     

_Note 3_: [A large spike on the number of new tests on April 7th appears to be artifact of delayed processes in laboratory and/or data entry, not actual changes in the number of tests](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).  

---

#####__Q 3. What age groups are affected? And, how has it changed over time?__ 

```{r}
incidencetop<-dtabyage%>%filter(latest==TRUE)%>%filter(is.na(age)==FALSE)%>%
    filter(incidence==max(incidence))%>%select(incidence)%>%
    summarize_all(funs(mean))
                            
incidencetopage<-dtabyage%>%filter(latest==TRUE)%>%filter(is.na(age)==FALSE)%>%
    filter(incidence==max(incidence))%>%select(agegroup)
incidencetopage<-incidencetopage$agegroup


incidencetop
incidencetopage

```
Initially, COVID-19 has affected __adult population relatively evenly across different ages__ (approaching or above 300 per 100,000 population in all age groups 30 and above). Recently, however, __the incidence rate has increased more rapidly among those 80 and older__ (see the second figure). Currently, the incidence rate is highest, `r incidencetop` per 100,000 population, among people `r incidencetopage` years of age.  

```{r plotincidencebyage, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabyage%>%filter(latest==TRUE)
plot_ly(dtafig, x=~agegroup, y=~incidence, 
        mode = 'marker',
        transforms = list(
            list(
                type = 'groupby',
                groups = dtabyage$date
                )
            )
        ) %>%
        layout(
            title = "COVID-19 cumulative incidence rate by age group in Maryland",
            xaxis = list(title = "Age group"),
            yaxis = list(title = "Number of COVID-19 cases per 100,000 population"))
```
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))

```{r plotincidencebyagetrends, results='asis', fig.align="left", out.width="800px"}

dtafig<-dtabyage%>%select(date, age, incidence)%>%
    mutate(
        age=paste0("incidence",age)
    )%>%
    arrange(date, age)%>% 
    spread(age, incidence, fill = NA, convert = FALSE) 
#head(dta, 20)
#str(dta)

fig <- plot_ly(dtafig, x=~date, y=~incidence20, name = "20-29", 
               type = 'scatter', mode='lines',
               line = list(color = c( "rgb(102,194,164)"))) %>% 
    add_trace(y = ~incidence30, name = "30-39", line = list(color = c( "rgb(65,174,118)"))) %>% 
    add_trace(y = ~incidence40, name = "40-49", line = list(color = c( "rgb(35,139,69)"))) %>% 
    add_trace(y = ~incidence50, name = "50-59", line = list(color = c( "rgb(0,109,44)"))) %>% 
    add_trace(y = ~incidence60, name = "60-69", line = list(color = c( "rgb(0,68,27)"))) %>% 
    add_trace(y = ~incidence70, name = "70-79", line = list(color = c( "rgb(33,113,18)"))) %>% 
    add_trace(y = ~incidence80, name = "80+", line = list(color = c( "rgb(239,59,44)"))) %>% 
    layout(
        title ="Trends of cumulative incidence rate by age group in Maryland",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of confirmed cases (per 100,000 population)",
                     titlefont=list(size=12), 
                     type = "log"), 
        legend = list(font=list(size=10), traceorder="reversed") 
        ) 

fig
```
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))


```{r plotagecompositiontrend, fig.align="left", out.width="800px"}
#Another approach, potentially simpler, is to see any changes in age-composition of confirmed cases. As expected based on the above figure, there are relatively more elderlies. 

#_Hover over each figure to see values and more options._

temp <- dtabyage%>%filter(is.na(agegroup)==FALSE)%>%select(date, cases)%>%
    group_by(date)%>%summarize_all(funs(sum))%>%
    mutate(total=cases)%>%select(date, total)

dta<-left_join(dtabyage, temp, by = "date") %>% 
    select(date, agegroup, cases, total) %>% 
    mutate(
        pct=round(100*cases/total,1)    
    )


dta %>% group_by(agegroup) %>% 
    arrange(date) %>%
    plot_ly( x = ~date, y = ~pct, 
             color= ~agegroup, colors = 'Reds',
             type = "bar") %>%
    layout(
        title ="Age pattern of confirmed cases over time in Maryland",
        yaxis = list(title = "Percent of confirmed cases",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=10)),
        barmode = 'stack'
        ) 

```

---

#####__Q 2. How fast has it been spreading? What is the trend of new cases?__ 
```{r dataplotTrendNewCasesMD}
dtafig<-dtacounty%>%select(date, cases)%>%group_by(date)%>%
    summarize_all(funs(sum))%>%
    arrange(date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcasessmooth =c(NA,NA,NA,rollmean(newcases, 7),NA,NA,NA), 
        newcasessmooth = round(newcasessmooth, 3)
        )

latestdate<-max(dtafig$date)
latestnewcases<-dtafig%>%filter(date==max(date))%>%select(newcases)%>%summarize_all(funs(mean)) 
previousnewcases<-dtafig%>%arrange(date)%>%mutate(previousnewcases=lag(newcases))%>%filter(date==max(date))%>%select(previousnewcases)%>%summarize_all(funs(mean)) 
```
Since testing capacity has been low, we _cannot_ confidently answer this question. Nevertheless, we can see __the number of NEW confirmed cases each day__. The first figure is for the entire state. We want to see the number of new infections to be stable more or less, without sudden and large increases. __On `r latestdate`, `r latestnewcases` new cases were confirmed, compared to `r previousnewcases` on the previous date__. The (now relatively small) peak on March 28th was due to new cases in Carroll county on March 28 - see the second figure below.  

[The spike of new confirmed cases on April 8th may be artifact of delayed processes in laboratory and/or data entry, not an actual increase on this specific date](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).

_Hover over each figure to see values and more options._
```{r plotTrendNewCasesMD, results='asis', fig.align="left", out.width="800px"}

plot_ly(dtafig, x=~date, y=~newcases, name="New cases, daily",
        type = 'bar',
        marker=list(color=("lightgray")) ) %>%
        add_trace(
            y=~newcasessmooth, name="7-day rolling average",
            type='scatter',mode = 'lines', 
            marker=list(color = c( "black"), size = 1),
            line=list(color = c( "black"))
            )%>%
        layout(
            title = "Trend of daily new confirmed COVID-19 cases in Maryland",
            xaxis = list(title = "Date",  
                         tickfont = list(size=10)),
            yaxis = list(title = "Number of new confirmed cases"),
            legend = list(x = 0.1, y = 0.9) 
            )
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data))

```{r dataplotTrendNewCasesCounty}
dtafig<-dtacounty%>%select(date, county, cases, latesttotal)%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,rollmean(newcases, 7),NA,NA,NA), 
        newcasessmooth = round(newcasessmooth, 3)
        )%>%
    mutate(
        rank = dense_rank(desc(latesttotal))
    )%>%
    filter(latesttotal>=100)%>% arrange(county, date)

ncounty100<-n_distinct(dtafig$county)
ncounty100
```

```{r plotTrendNewCasesCounty, fig.align="left", out.width="800px"}
plot_ly(dtafig, x=~date, y=~newcases, 
             type = 'bar', color= ~county ) %>%
        layout(
            title = c("Trend of daily new confirmed COVID-19 cases by county in Maryland"),
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new confirmed cases"),
            barmode="stack",  
            legend = list(x = 0.1, y = 0.9, 
                          title=list(text='Counties with 50 or more cases'))
            )

```


```{r}
dtafig<-dtafig%>%filter(latesttotal>=150)%>% arrange(county, date)
ncounty150<-n_distinct(dtafig$county)
ncounty150

dtafig<-dtafig%>%filter(latesttotal>=200)%>% arrange(county, date)
ncounty200<-n_distinct(dtafig$county)
ncounty200
```

Now, _among `r ncounty200` counties with 200 or more confirmed cases_, below shows the trends of daily number of NEW confirmed cases for each of the county, with 7-day rolling averages in black lines. Again, [large spikes on April 8th may well be results of delayed processes in laboratory and/or data entry, not actual increases on that date](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).  

_Hover over each figure to see values and more options._
```{r plotTrendNewCasesCountyBar, results='asis', fig.align="left", out.width="800px", out.height="800px"}

panel <- . %>% 
    plot_ly(x=~date, y=~newcases, type = 'bar',
            marker=list(color=("lightgray")) 
        ) %>%
    add_trace(
        y=~newcasessmooth, name="New cases, 7-day rolling average",
        type='scatter',mode = 'lines', 
        marker=list(color = c( "black"), size = 1),
        line=list(color = c( "black"))
        )%>%
    add_annotations(
        text = ~unique(county),
        x = 0.5, y = 0.9, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        showlegend = FALSE,
        xaxis=list(title = "Date",  
                 font=list(size=10),
                 tickfont = list(size=8) 
                 ),
        yaxis=list(title = "New cases")
        )

dtafig<-dtacounty%>%select(date, county, cases, latesttotal)%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,rollmean(newcases, 7),NA,NA,NA), 
        newcasessmooth = round(newcasessmooth, 3)
        )%>%
    mutate(
        rank = dense_rank(desc(latesttotal))
    )%>%
    filter(latesttotal>=200)

#write.csv(dtafig, "KCOVID/dtaKCOVIDSouthKoreaUnlike1.csv")

dtafig%>%
    group_by(county) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 4, shareX = TRUE, shareY = FALSE)    
```

```{r fig.align="left", out.width="800px"}
countylist<-as.vector(as.data.frame(table(dtafig$county))$Var1)

#looping code not working to save a figure with a number! why??? 
for (i in 1:ncounty150){
    temp<-dtafig%>%filter(county==countylist[i])
}

listx<- list(title = "",  
             font=list(size=8),
             autotick = FALSE,
             tickfont = list(size=8), 
             tickangle=-90)

    temp<-dtafig%>%filter(county==countylist[1])
    fig1<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[1])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[2])
    fig2<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[2])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[3])
    fig3<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[3])%>%layout(xaxis=listx)            

listx<- list(title = "Date",  
             font=list(size=10),
             autotick = FALSE,
             showticklabels = TRUE, 
             tickfont = list(size=8), 
             tickangle=-90)

listy<- list(title = "Number of new confirmed cases")

listlegend <- list(font=list(size=10), orientation = "h",   
                        xanchor = "center", x=0.5, y=-0.15)

subplot(fig1 , fig2, fig3, 
        nrows = 3, shareX = TRUE )%>%
    layout(title = c("Trend of daily new confirmed COVID-19 cases by county, among counties with 150+ cases"),
           xaxis=listx,  yaxis = listy, legend= listlegend)
```
(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data))

```{r}

dtafig<-dtacounty%>%select(date, county, cases, pop)%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,rollmean(newcases, 7),NA,NA,NA), 
        newcasessmooth = round(newcasessmooth, 3), 
        newcasessmoothpp = round(newcasessmooth*100000/pop,3)
        )%>%
    filter(is.na(newcasessmooth)==FALSE)%>%
    filter(date==max(date))


temp<-dtafig%>%filter(county=="Prince George's")
newPG<-round(mean(temp$newcasessmoothpp), 0)
```
Finally, below shows counties ranked by the latest level of daily new cases (i.e., right end of the black line above) - per 100,000 population this time. For example, based on the latest 7-day average, there are `r newPG` new cases per day per 100,000 population in Prince George's county.  
```{r plotnewcasesCountyLatest, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%select(date, county, cases, pop)%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,rollmean(newcases, 7),NA,NA,NA), 
        newcasessmooth = round(newcasessmooth, 3), 
        newcasessmoothpp = round(newcasessmooth*100000/pop,3)
        )%>%
    filter(is.na(newcasessmooth)==FALSE)%>%
    filter(date==max(date))%>%
    mutate(
        rank = dense_rank(desc(newcasessmoothpp))
    )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$newcasessmoothpp, decreasing = FALSE)])

plot_ly(dtafig, y = ~county, x = ~newcasessmoothpp, type="bar", orientation="h", 
             marker = list(color = c( "gray"))) %>%
        layout(
            title = "Latest daily new cases per 100,000 population by county in Maryland",
            yaxis = list(title = "",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10) 
               
                         ),
            xaxis = list(title = "New cases per day per 100,000 population (7-day average)")
            )

```

---

#####__Q 1. How many confirmed cases do we have now, and where are they?__ 
```{r}
latestdatecounty<-max(dtacounty$date)
temp<-dtacounty%>%filter(date==latestdatecounty)
statecases<-sum(temp$cases)

ncounties<-dtacounty%>%filter(date==latestdatecounty)%>%nrow()
ncountiestotal<-dtapopcounty%>%filter(county!="Maryland")%>%nrow()
popstate<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(sum))

latestdateMD<-max(dtaMD$date)
casesMD<-dtaMD%>%filter(date==max(date))%>%select(cases)%>%summarize_all(funs(max))
incidencerateMD<-round(100000*casesMD/popstate, 0)
casesMD<-as.character(casesMD)

topincidencecounty<-dtacounty%>%filter(date==latestdatecounty)%>%mutate(incidence=round(cases*100000/pop), 0)%>%filter(county!="Unknown")%>%filter(incidence==max(incidence)) %>%select(county)
topincidencecounty<-topincidencecounty
topincidencecounty

```
As of `r latestdateMD` 10:00AM, __`r casesMD` confirmed cases have been reported in Maryland__, according to Maryland Department of Health. This means there are __`r incidencerateMD` people with confirmed COVID-19 per 100,000 population in the state__. 

Below figure shows number of confirmed cases (gray bars) and infection rates (i.e., number of confirmed cases per 100,000 population) (blue bars) by county, as of `r latestdatecounty`.  

_Hover over each figure to see values and more options._
```{r plottotalcasesCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtacounty%>%filter(date==latestdatecounty)%>%
    select(date, county, cases, pop)%>%
    mutate(incidence=round(cases*100000/pop), 0)

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$cases, decreasing = FALSE)])

figcases<-plot_ly(dtafig, y = ~county, x = ~cases, 
                  name="total confirmed cases", 
                  type="bar", orientation="h" , 
                  marker = list(color = c( "gray"))) %>%
        layout(
            yaxis = list(title = "",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=9)
                         ),
            xaxis = list(title = "Total number of confirmed cases")
            )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$incidence, decreasing = FALSE)])

figincidence<-plot_ly(dtafig, y = ~county, x = ~incidence, 
                      name="incidence rate",
                      type="bar", orientation="h",
                      marker = list(color = c( "#1f77b4"))) %>%
        layout(
            yaxis = list(title = "",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=9)
                         ),
            xaxis = list(title = "Number of confirmed cases per 100,000 population")
            )

subplot(figcases, figincidence, 
        nrows=1, margin=0.05, shareY = FALSE, titleY = TRUE) %>%
        layout(  title ="Cumulative COVID-19 total cases and incidence rate by county in Maryland", 
                 legend = list(font=list(size=9), 
                      orientation = "h", xanchor = "center",  
                      x=0.5, y=-0.1) 
        )

```

(__Source__: New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data), US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage))

```{r}
#####__Q 1. When and where was COVID-19 first reported in Maryland?__ 
firstdatestate<-mean(dtacounty$firstdatestate)

firstcountyname<-dtacounty%>%filter(firstcounty==TRUE)%>%select(county)
firstcountyname<-firstcountyname$county

#The first confirmed COVID-19 case was reported in __`r firstcountyname` county on `r firstdatestate`__. 
```

---

__Data sources__:  
1. __All COVID-19 data for counties__ come from New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data). Accessed on `r date`.    
2. __All COVID-19 data for Maryland disaggregated by age and sex__ come from [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/) by Maryland Department of Health. This dashboard presents latest numbers as of 10:00AM on each day. Accessed on `r date`.      
3. All data on county population come from US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage). Accessed on March 29, 2020.   
4. Data on Maryland population by age and sex come from Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx). Accessed on April 1, 2020.    

---

<p style="color:lightgray">
See [GitHub](https://github.com/yoonjoung/COVID19_MD) for data, code, and more information. 
For typos, errors, and questions, contact me at [www.isquared.global](https://www.iSquared.global/YJ). 

_Making Data Delicious, One Byte at a Time_, in good times and bad times.</p>