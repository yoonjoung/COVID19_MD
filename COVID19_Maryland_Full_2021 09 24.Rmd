---
output:
  html_document:
    toc: yes
    toc_depth: 5
    toc_float: true
---
```{r intro, echo=FALSE, results="hide"}
knitr::opts_chunk$set(echo=FALSE, 
                      message=FALSE, 
                      comment = "", 
                      warning=FALSE, 
                      results="hide") 
knitr::opts_knit$set(root.dir = "~/Dropbox/0 Project/COVID19_US/")

date<-as.Date(Sys.time(	), format='%d%b%Y')
time<-Sys.time()

suppressWarnings(suppressMessages(library(dplyr)))
suppressWarnings(suppressMessages(library(ggplot2)))
suppressWarnings(suppressMessages(library(tidyverse)))
suppressWarnings(suppressMessages(library(readxl)))
suppressWarnings(suppressMessages(library(plotly)))
suppressWarnings(suppressMessages(library(Matrix)))
suppressWarnings(suppressMessages(library(stringr)))
suppressWarnings(suppressMessages(library(stringi)))

suppressWarnings(suppressMessages(library(jsonlite)))
suppressWarnings(suppressMessages(library(httr)))
suppressWarnings(suppressMessages(library(rlist)))
suppressWarnings(suppressMessages(library(zoo)))
suppressWarnings(suppressMessages(library(RColorBrewer))) 
suppressWarnings(suppressMessages(library(lubridate)))
```

```{r dataPop}
dtapopcounty<-read.csv("~/Dropbox/0 Project/COVID19_US/DataCensusBureau/co-est2019-alldata.csv")

names(dtapopcounty)<- tolower(names(dtapopcounty))   
dtapopcounty<-dtapopcounty%>%select(stname, ctyname, popestimate2019)%>%
    filter(stname=="Maryland")%>%
    mutate(pop=popestimate2019, 
           state=as.character(stname), 
           county=str_remove(as.character(ctyname), " County")
           )%>%
    select(state, county, pop)%>%
    filter(state=="Maryland")%>%
    select(county, pop)

##View(dtapopcounty)
```

```{r dataByCounty, eval=FALSE}
# using NYTIMES data (retired on 7/19/2020)
url<-"https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv"
dtacases<-read.csv(url)

dtabycounty<-read.csv(url)%>%
    mutate(
        date=as.Date(as.character(date)),
        state=as.character(state),
        county=as.character(county)
    )

dtabycounty<-dtabycounty%>%
    filter(state=="Maryland")%>%
    select(-state)%>%
    mutate(
        firstdatestate=min(date), #first date for the state
        firstcounty=FALSE, 
        firstcounty=ifelse(firstdatestate==date, TRUE, firstcounty),
        firstcountyname="", 
        firstcountyname=ifelse(firstcounty==TRUE, county, firstcountyname) 
    )%>%
    group_by(date)%>%
    mutate(
        numcounties= n_distinct(county)#number of affected counties by date
    )%>%ungroup()%>%
    group_by(county)%>%
    mutate(
        firstdatecounty=min(date),#first date by county 
        latestdatecounty=max(date),#latest update date by county
        latesttotalcases=max(cases)#latest cumulative number
    )%>%ungroup()%>%
    arrange(county, date)

dim(dtabycounty)
dtabycounty<-left_join(dtabycounty, dtapopcounty, by = "county")%>%
    filter(county!="Maryland") 
dim(dtabycounty)

length(unique(dtabycounty$county))
colnames(dtabycounty)
tail(dtabycounty)

```

```{r APIdtabycountyCases}

url<-("https://opendata.arcgis.com/datasets/0573e90adab5434f97b082590c503bc1_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

countylist<-as.vector(colnames(dta))[-c(1:2)]

casesbycounty<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(county, cases, countylist)%>%
    mutate(
        county=ifelse(county=="Anne_Arundel", "Anne Arundel", county), 
        county=ifelse(county=="Baltimore_City", "Baltimore city", county), 
        county=ifelse(county=="Prince_Georges", "Prince George's", county), 
        county=ifelse(county=="Queen_Annes", "Queen Anne's", county), 
        county=ifelse(county=="St_Marys", "St. Mary's", county)    
        )    
```

```{r APIdtabycountyConfirmeddeaths}

url<-("https://opendata.arcgis.com/datasets/3dbd3e633b344c7c9a0d166b1d6a2b03_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

countylist<-as.vector(colnames(dta))[-c(1:2)]

str(dta)

deathsbycounty<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(county, deaths, countylist)%>%
    mutate(
        county=ifelse(county=="Anne_Arundel", "Anne Arundel", county), 
        county=ifelse(county=="Baltimore_City", "Baltimore city", county), 
        county=ifelse(county=="Prince_Georges", "Prince George's", county), 
        county=ifelse(county=="Queen_Annes", "Queen Anne's", county), 
        county=ifelse(county=="St_Marys", "St. Mary's", county)    
        )    

```

```{r APIdtabycountyProbabledeaths}

url<-("https://opendata.arcgis.com/datasets/14dfc21466d34c2ea250a4642f08e880_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)

jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

#View(dta)

countylist<-as.vector(colnames(dta))[-c(1:2)]

probabledeathsbycounty<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(county, probabledeaths, countylist)%>%
    mutate(
        county=ifelse(county=="Anne_Arundel", "Anne Arundel", county), 
        county=ifelse(county=="Baltimore_City", "Baltimore city", county), 
        county=ifelse(county=="Prince_Georges", "Prince George's", county), 
        county=ifelse(county=="Queen_Annes", "Queen Anne's", county), 
        county=ifelse(county=="St_Marys", "St. Mary's", county)    
        )     

#View(probabledeathsbycounty)
```

```{r APIdtabycountyTesstpersons}
url<-("https://opendata.arcgis.com/datasets/736d3e5a280840a7916ab309b6ac8908_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]    

datelist<-as.vector(colnames(dta))[-c(1:2)]

testpersonsbycounty<-dta%>%
    select(-OBJECTID)%>%
    gather(date, personstested, datelist)%>%
    rename(county=County)%>%
    mutate(
        date=substring(date, 3),
        date=gsub("\\_", "/", date),
        date=as.Date(date, format = "%m/%d/%Y")
        )%>%    
    mutate(
        county=ifelse(county=="Anne_Arundel", "Anne Arundel", county), 
        county=ifelse(county=="Baltimore_City", "Baltimore city", county), 
        county=ifelse(county=="Baltimore_city", "Baltimore city", county), 
        county=ifelse(county=="Baltimore City", "Baltimore city", county), 
        county=ifelse(county=="Prince_Georges", "Prince George's", county), 
        county=ifelse(county=="Queen_Annes", "Queen Anne's", county), 
        county=ifelse(county=="St_Marys", "St. Mary's", county)    
        )     

    #View(testpersonsbycounty)
```

```{r APIdtabycountyTessts}
url<-("https://opendata.arcgis.com/datasets/853593daf977435aaa909b334445542c_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]    

    #View(dta)

datelist<-as.vector(colnames(dta))[-c(1:2)]

testsbycounty<-dta%>%
    select(-OBJECTID)%>%
    gather(date, tests, datelist)%>%
    rename(county=County)%>%
    mutate(
        date=substring(date, 3),
        date=gsub("\\_", "/", date),
        date=as.Date(date, format = "%m/%d/%Y")
        )%>%
    mutate(
        county=ifelse(county=="Anne_Arundel", "Anne Arundel", county), 
        county=ifelse(county=="Baltimore_City", "Baltimore city", county), 
        county=ifelse(county=="Baltimore_city", "Baltimore city", county), 
        county=ifelse(county=="Baltimore City", "Baltimore city", county), 
        county=ifelse(county=="Prince_Georges", "Prince George's", county), 
        county=ifelse(county=="Queen_Annes", "Queen Anne's", county), 
        county=ifelse(county=="St_Marys", "St. Mary's", county)    
        )    


    str(testsbycounty)
    
    #View(testsbycounty)
```

```{r APIdtabycountyPositiveRate}
url<-("https://opendata.arcgis.com/datasets/54d028e340f44e88945e26579eecd447_0.geojson")
#metadata: https://www.arcgis.com/sharing/rest/content/items/54d028e340f44e88945e26579eecd447/info/metadata/metadata.xml?format=default&output=html

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]    

    #View(dta)

#two indicators. Keep only the rolling avearage positivity rate    
dta<-dta%>%
    select(-ends_with("Percent_Positive"))%>%
    rename(date=ReportDate)%>%
    mutate(
        date=substring(date, 1, 10),
        date=as.Date(date, format = "%Y/%m/%d")
        )

    #colnames(dta)
    #str(dta)
   
countylist<-as.vector(colnames(dta))[-c(1:2)]

prbycounty<-dta%>%
    select(-OBJECTID)%>%
    gather(county, positivityrate, countylist)%>%
    mutate(
        county=gsub( "_Rolling_Avg", "", county)
        )%>%
    mutate(
        county=ifelse(county=="Anne_Arundel", "Anne Arundel", county), 
        county=ifelse(county=="Baltimore_City", "Baltimore city", county), 
        county=ifelse(county=="Baltimore_city", "Baltimore city", county), 
        county=ifelse(county=="Baltimore City", "Baltimore city", county), 
        county=ifelse(county=="Prince_Georges", "Prince George's", county), 
        county=ifelse(county=="Queen_Annes", "Queen Anne's", county), 
        county=ifelse(county=="St_Marys", "St. Mary's", county)    
        )    

    str(prbycounty)
   
```

```{r, eval=FALSE}
dim(casesbycounty)
dim(deathsbycounty)
dim(probabledeathsbycounty)
dim(testpersonsbycounty)
dim(testsbycounty)
dim(prbycounty)

table(casesbycounty$county)
table(deathsbycounty$county)
table(probabledeathsbycounty$county)
table(testpersonsbycounty$county)
table(testsbycounty$county)
table(prbycounty$county)

colnames(casesbycounty)
colnames(deathsbycounty)
colnames(probabledeathsbycounty)
colnames(testpersonsbycounty)
colnames(testsbycounty)
colnames(prbycounty)
```

```{r dtabycounty}
dtabycounty<-left_join(casesbycounty, deathsbycounty, 
                     by = c("county", "date"))

dtabycounty<-left_join(dtabycounty, probabledeathsbycounty, 
                     by = c("county", "date"))

dtabycounty<-left_join(dtabycounty, testsbycounty, 
             by = c("county", "date"))

dtabycounty<-left_join(dtabycounty, testpersonsbycounty, 
             by = c("county", "date"))

dtabycounty<-left_join(dtabycounty, prbycounty, 
             by = c("county", "date"))

    #table(dtabycounty$county)
    #colnames(dtabycounty)

dtabycounty<-left_join(dtabycounty, dtapopcounty, by = "county")
    dim(dtabycounty)
    colnames(dtabycounty)
    length(unique(dtabycounty$county))

dtabycounty<-dtabycounty%>%
    mutate(
        firstdatestate=min(date), #first date for the state
        firstcounty=FALSE, 
        firstcounty=ifelse(firstdatestate==date, TRUE, firstcounty),
        firstcountyname="", 
        firstcountyname=ifelse(firstcounty==TRUE, county, firstcountyname) 
    )%>%
    group_by(date)%>%
    mutate(
        numcounties= n_distinct(county, na.rm = TRUE)#number of affected counties by date
    )%>%ungroup()%>%
    group_by(county)%>%
    mutate(
        firstdatecounty=min(date, na.rm = TRUE),#first date by county 
        latestdatecounty=max(date, na.rm = TRUE),#latest update date by county
        latesttotalcases=max(cases, na.rm = TRUE)#latest cumulative number
    )%>%ungroup()%>%
    arrange(county, date)%>%
    filter(county!="Maryland") 


```

```{r dataMD, eval=FALSE}
#DATA FROM MDHD
#dtaMD<-read_excel("~/Dropbox/0 Project/COVID19_US/DataMD/MDHealthDepartmentDashboard.xlsx")
str(dtaMD)

names(dtaMD)<- tolower(names(dtaMD))   
dtaMD<-dtaMD%>%
    filter(group=="total")%>%
    mutate(    
        cases=as.numeric(str_replace_all(stri_trim_both(cases), fixed(","),"")),
        negativetest=as.numeric(str_replace_all(stri_trim_both(negativetest), fixed(","),"")),
        deaths=as.numeric(str_replace_all(stri_trim_both(deaths), fixed(","),"")),
        probabledeaths=as.numeric(str_replace_all(stri_trim_both(probabledeaths), fixed(","),"")),
        hospitalizations=as.numeric(str_replace_all(stri_trim_both(hospitalizations), fixed(","),"")),
        releasedfromisolation=as.numeric(str_replace_all(stri_trim_both(releasedfromisolation), fixed(","),"")),
        totaltests=cases+negativetest
    )%>%
    arrange(date)%>%
    mutate(
        newcases=lead(cases)-cases,
        newtests=lead(totaltests)-totaltests
    )%>%
    select(date, cases, negativetest, deaths, hospitalizations, releasedfromisolation, totaltests, probabledeaths, starts_with("new"))
str(dtaMD)

```

```{r APIdtaMD}

url<-("https://opendata.arcgis.com/datasets/18582de727934249b92c52542395a3bf_0.geojson")

    jsondata<-fromJSON(url) 
    jsondta<-jsondata[[4]]
    dta<-jsondta[[2]]
    
    cases<-dta%>%
        mutate(date=as.Date(DATE))%>%
        select(-OBJECTID, -DATE)%>%
        rename(cases=Count_)

url<-("https://opendata.arcgis.com/datasets/9a33ce5efe0e458db636f215433765bd_0.geojson")

    jsondata<-fromJSON(url) 
    jsondta<-jsondata[[4]]
    dta<-jsondta[[2]]
    
    hospitalizations_ever<-dta%>%
        mutate(date=as.Date(DATE))%>%
        select(-OBJECTID, -DATE)%>%
        rename(hospitalizations_ever=Count_)

url<-("https://opendata.arcgis.com/datasets/096cca5f77404a06babb9367530136b9_0.geojson")

    jsondata<-fromJSON(url) 
    jsondta<-jsondata[[4]]
    dta<-jsondta[[2]]
    
    deaths<-dta%>%
        mutate(date=as.Date(DATE))%>%
        select(-OBJECTID, -DATE)%>%
        rename(deaths=Count_)

url<-("https://opendata.arcgis.com/datasets/f5cbe0d04c1f47c3970b081c9be3c332_0.geojson")

    jsondata<-fromJSON(url) 
    jsondta<-jsondata[[4]]
    dta<-jsondta[[2]]
    
    probabledeaths<-dta%>%
        mutate(date=as.Date(DATE))%>%
        select(-OBJECTID, -DATE)%>%
        rename(probabledeaths=Count_)

url<-("https://opendata.arcgis.com/datasets/e5d044bda3a44bfa8ba224145617cda0_0.geojson")

    jsondata<-fromJSON(url) 
    jsondta<-jsondata[[4]]
    dta<-jsondta[[2]]
    
    newtests<-dta%>%
        mutate(date=as.Date(date))%>%
        select(-OBJECTID)%>%
        rename(newtests=number_of_tests,
               newpositivetests=number_of_positives)%>%
        select(-rolling_avg)

url<-("https://opendata.arcgis.com/datasets/67c49f40064c45f9aadfcc9298cba9e6_0.geojson")

    jsondata<-fromJSON(url) 
    jsondta<-jsondata[[4]]
    dta<-jsondta[[2]]
    
    negativetests<-dta%>%
        mutate(date=as.Date(ReportDate))%>%
        select(-OBJECTID, -ReportDate)%>%
        rename(negativetests=NegativeTests)

url<-("https://opendata.arcgis.com/datasets/bf3f201b056b4c488b5dac3441b7ac20_0.geojson")

jsondata<-fromJSON(url) 
jsondta<-jsondata[[4]]
dta<-jsondta[[2]]

hospital<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    rename(acute=Acute,
           icu=ICU,
           hospitalizations_current=Total)

```

```{r dtaMD}
dim(cases)
dim(deaths)
dim(probabledeaths)
dim(newtests)
dim(negativetests)
dim(hospital)
dim(hospitalizations_ever)

dtaMD<-left_join(cases, deaths, by = c("date"))
    dim(dtaMD)
dtaMD<-left_join(dtaMD, probabledeaths, by = c("date"))
    dim(dtaMD)
dtaMD<-left_join(dtaMD, newtests, by = c("date"))
    dim(dtaMD)    
dtaMD<-left_join(dtaMD, negativetests, by = c("date"))
    dim(dtaMD)   
dtaMD<-left_join(dtaMD, hospital, by = c("date"))
    dim(dtaMD)   
dtaMD<-left_join(dtaMD, hospitalizations_ever, by = c("date"))
    dim(dtaMD)       
    
    str(dtaMD)
    
dtaMD<-dtaMD%>%
    mutate(    
        totaltests=cases+negativetests
    )%>%
    arrange(date)%>%
    mutate(
        newcases=lead(cases)-cases,
        newtests_calculated=lead(totaltests)-totaltests
    )

str(dtaMD)

```

```{r}
temp<-dtaMD%>%select(date, cases, negativetests, totaltests, newcases, newtests)
tail(temp, 10)

```

```{r APIdtabyageCases}

url<-("https://opendata.arcgis.com/datasets/68fbe34617cd450aa423e27692f503b0_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

agelist<-c("Age_0_to_9", "Age_10_to_19", "Age_20_to_29", 
           "Age_30_to_39", "Age_40_to_49", "Age_50_to_59", 
           "Age_60_to_69", "Age_70_to_79", "Age_80plus", "Age_Unknown") 
 
casesbyage<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(agegroup, cases, agelist)    
```

```{r APIdtabyageConfirmeddeaths}

url<-("https://opendata.arcgis.com/datasets/b51451a222cd4c3d89a58c3393212cc7_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

agelist<-c("Age_0_to_9", "Age_10_to_19", "Age_20_to_29", 
           "Age_30_to_39", "Age_40_to_49", "Age_50_to_59", 
           "Age_60_to_69", "Age_70_to_79", "Age_80plus", "Age_Unknown") 

deathsbyage<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(agegroup, deaths, agelist)

```

```{r APIdtabyageProbabledeaths}

url<-("https://opendata.arcgis.com/datasets/65469571a26b4177a554e06d6fd601ad_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)

jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

agelist<-c("Age_0_to_9", "Age_10_to_19", "Age_20_to_29", 
           "Age_30_to_39", "Age_40_to_49", "Age_50_to_59", 
           "Age_60_to_69", "Age_70_to_79", "Age_80plus", "Age_Unknown") 

probabledeathsbyage<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(agegroup, probabledeaths, agelist) 
```

```{r dtabyage}
dim(casesbyage)
dim(deathsbyage)
dim(probabledeathsbyage)

dtabyage<-left_join(casesbyage, deathsbyage, 
                     by = c("agegroup", "date"))

dtabyage<-left_join(dtabyage, probabledeathsbyage, 
                     by = c("agegroup", "date"))%>%
    mutate(
        agegroup=substring(agegroup, 5),
        agegroup=gsub("\\_to_", "-", agegroup),
        agegroup=ifelse(agegroup=="80plus", "80+", agegroup),
        age=as.numeric(sapply(strsplit(agegroup,"-"), `[`, 1)), 
        age=ifelse(agegroup=="80+", 80, age)
    )


#DATA FROM MDHD
dtapopbyage<-read_excel("~/Dropbox/0 Project/COVID19_US/DataMD/CNTY-PopEst-2018.xlsx")%>%
    select(agegroup, pop10)%>%
    filter(is.na(pop10)==F)%>%
    filter(agegroup!="Total")%>%
    mutate(    
        age=as.numeric(sapply(strsplit(agegroup,"-"), `[`, 1)), 
        pop=pop10
    )%>%
    select(age, pop)

dtabyage<-left_join(dtabyage, dtapopbyage, by = "age")
    dim(dtabyage)
    colnames(dtabyage)

dtabyage<-dtabyage%>%
    mutate(
        incidence=round(cases*100000/pop, 1), 
        cfr=round(100*deaths/cases, 3), 
        cfrprobable=round(100*(deaths+probabledeaths)/(cases+probabledeaths), 3), 
        cfrextra=cfrprobable - cfr, 
        temp=max(date),
        latest=date==temp
    )%>%select(-temp)
```

```{r APIdtabyraceCases}

url<-("https://opendata.arcgis.com/datasets/2362c46380aa48f9a18f88571d2090bb_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

racelist<-c("African_American", "White", "Hispanic", "Asian", "Other", "Not_Available")

casesbyrace<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(race, cases, racelist)    
```

```{r APIdtabyraceConfirmeddeaths}

url<-("https://opendata.arcgis.com/datasets/312715a843064ef18879eb726f64c63a_0.geojson")

jsondata<-fromJSON(url) 
    #str(jsondata)
    
jsondta<-jsondata[[4]]
    #str(jsondta)
    
dta<-jsondta[[2]]

racelist<-c("African_American", "White", "Hispanic", "Asian", "Other", "Not_Available")

deathsbyrace<-dta%>%
    mutate(date=as.Date(DATE))%>%
    select(-OBJECTID, -DATE)%>%
    gather(race, deaths, racelist)

```

```{r APIdtabyraceProbabledeaths}

url<-("https://services.arcgis.com/njFNhDsUCentVYJW/arcgis/rest/services/MDCOVID19_ProbableDeathsByRaceAndEthnicityDistribution/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json")

jsondata<-fromJSON(url) 
    #str(jsondata)

jsondta<-jsondata[[5]]
    #str(jsondta)
    
dta<-jsondta[[1]]

racelist<-c("African_American", "White", "Hispanic", "Asian", "Other", "Not_Available")

probabledeathsbyrace<-dta%>%
    mutate(date=as.Date(as.POSIXct(round((DATE+0.1)/1000, 0), origin = "1970-01-01")))%>%
    select(-OBJECTID, -DATE)%>%
    gather(race, probabledeaths, racelist) 
```

```{r dtabyrace}
dim(casesbyrace)
dim(deathsbyrace)
dim(probabledeathsbyrace)

dtabyrace<-left_join(casesbyrace, deathsbyrace, 
                     by = c("race", "date"))

dtabyrace<-left_join(dtabyrace, probabledeathsbyrace, 
                     by = c("race", "date"))%>%
    mutate(race=ifelse(race=="African_American", "African-American", race),
           race=ifelse(race=="Not_Available", "Unknown", race))

    dim(dtabyrace)
    colnames(dtabyrace)

#Total pop
popMD<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(mean))

#pop data FROM MD planning deparment 
dtapopbyrace<-read_excel("~/Dropbox/0 Project/COVID19_US/DataMD/table1a.xlsx")%>%
    filter(is.na(pop)==F)%>%
    mutate(
        popMD=as.numeric(popMD),
        pop=round(popMD*pctpop, 0)
    )%>%select(race, pop)%>%
    group_by(race)%>%summarize_all(funs(sum))%>%filter(is.na(pop)==F)

dtabyrace<-left_join(dtabyrace, dtapopbyrace, by = "race")
    dim(dtabyrace)
    colnames(dtabyrace)

dtabyrace<-dtabyrace%>%
    mutate(
        incidence=round(cases*100000/pop, 1), 
        cfr=round(100*deaths/cases, 3), 
        cfrprobable=round(100*(deaths+probabledeaths)/(cases+probabledeaths), 3), 
        cfrextra=cfrprobable - cfr, 
        mortality=round(100000*(deaths)/pop, 3),
        mortalityprobable=round(100000*(deaths+probabledeaths)/pop, 3), 
        temp=max(date),
        latest=date==temp
    )%>%select(-temp)
```

```{r dtaGlobal}
url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv"

dtacases<- read.csv(url)%>%
    rename(country = Country.Region,
           region = Province.State)%>%
    mutate(country=as.character(country), 
           country=ifelse(country=="Korea, South", "South Korea", country))%>%
    filter(country=="South Korea" | country=="Italy")%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           cases = value, 
           group = country)%>%
    select(group, date, cases)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()
            
url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv"
dtadeaths<- read.csv(url)%>%
    rename(country = Country.Region,
           region = Province.State)%>%
    mutate(country=as.character(country), 
           country=ifelse(country=="Korea, South", "South Korea", country))%>%
    filter(country=="South Korea" | country=="Italy")%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           deaths = value, 
           group = country)%>%
    select(group, date, deaths)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()

url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"

dtacasesMD<-read.csv(url)%>%
    rename(country = Country_Region,
           state = Province_State,
           county = Admin2)%>%
    filter(state=="Maryland" | state=="New York")%>%
    select(country, state, county, FIPS, Combined_Key, starts_with("X"))%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           cases = value)%>%
    mutate(group="",
           group=ifelse(state=="Maryland", "Maryland, US", group),
           group=ifelse(state=="New York", "New York, US", group))%>%
    select(group, date, cases)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()


url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv"

dtadeathsMD<-read.csv(url)%>%
    rename(country = Country_Region,
           state = Province_State,
           county = Admin2)%>%
        filter(state=="Maryland" | state=="New York")%>%
    select(country, state, county, FIPS, Combined_Key, starts_with("X"))%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           deaths = value)%>%
    mutate(group="",
           group=ifelse(state=="Maryland", "Maryland, US", group),
           group=ifelse(state=="New York", "New York, US", group))%>%
    select(group, date, deaths)%>%
    group_by(group, date)%>%
    summarize_all(funs(sum))%>%ungroup()

dtacases<-rbind(dtacases, dtacasesMD)
dtadeaths<-rbind(dtadeaths, dtadeathsMD)

dtacurve<-left_join(dtacases, dtadeaths, by = c("group", "date"))%>%
    mutate(
        date=mdy(substring(date, 2)), 
        pop=0,  
        pop=ifelse(group=="Maryland, US",  6045.680, pop), 
        pop=ifelse(group=="New York, US", 19453.561, pop), 
        pop=ifelse(group=="South Korea",  51269.183, pop), 
        pop=ifelse(group=="Italy",        60461.828, pop)
        )%>%
    arrange(group, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases),

        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(group!=lag(group), NA, newdeaths),
        
        incidence=round(100000*cases/(pop*1000), 1), # confiremd cases per 100,000 pop
        cfr=round(100*deaths/cases, 3), # deaths per 100 confirmed cases   
        mortality=round(100000*deaths/(pop*1000), 1) # deaths per 100000 pop
    )%>%arrange(group, date)%>%
    mutate(
        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newdeathssmooth=c(NA,NA,NA,NA,NA,NA,rollmean(newdeaths, 7)), 
        newcasessmooth=ifelse(group!=lag(group), NA, newcasessmooth),
        newdeathssmooth=ifelse(group!=lag(group), NA, newdeathssmooth),
        newcasessmooth =round(newcasessmooth, 3),  
        newdeathssmooth=round(newdeathssmooth, 3),

        newcasessmoothpp=round(100*newcasessmooth/pop, 1),   
        newdeathssmoothpp=round(100*newdeathssmooth/pop, 1)
       
		)

#data quality problem: cumulative deaths and acses going down in some cases 

#Force negative smooth numbers to 0 

dtacurve<-dtacurve%>%
    mutate(
        newcasessmooth   =ifelse(newcasessmooth<0,    0, newcasessmooth),
        newcasessmoothpp =ifelse(newcasessmoothpp<0,  0, newcasessmoothpp),
        newdeathssmooth  =ifelse(newdeathssmooth<0,   0, newdeathssmooth),
        newdeathssmoothpp=ifelse(newdeathssmoothpp<0, 0, newdeathssmoothpp)
    )

```

##### __COVID-19 in Maryland, US: Daily Updates and Insights with Granular Local Data__ 

(Updated: `r time` EDT)  

So, I have been watching the epidemic in China and Korea since the beginning, but it is still not easy to settle into this reality here in the US. 

* First of all, everyone, __STAY HEALTHY and [see what YOU can do](https://www.cdc.gov/coronavirus/2019-ncov/protect/index.html)__! 

* Second, there are many excellent news articles and information sources, but I'm sharing some more __questions (see left panel) and answers for those who are curious about a specific situation in Maryland, US - especially including local data__. Maryland is my beautiful adopted home state of over 20 years. The State is doing its best with strong leadership, but this virus arrived here when the country was not ready and is spreading fast unfortunately... 

_See footnote for further information about data sources. More questions and answers will be added, as more local data become available._ 

(Sorry, this is not mobile device friendly, and is best viewed on your regular monitor.)

```{r plotTestsAndCasesCounty, fig.align="left", out.width="800px", out.height="500px"}

##### __Q 11.1. What are levels of testing across counties? And how do they relate with the level of confirmed cases?__ 

dtafig<-dtabycounty%>%
    filter(county!="Unknown")%>%
    filter(date==max(date))%>%
    select(county, date,  cases, tests, pop)%>%
    mutate(casespp=round(100000*cases/pop, 1),
           testspp=round(100000*tests/pop, 1)
           )

maxx<-max(dtafig$testspp)+5000
maxy<-max(dtafig$casespp)+500

dtafig%>%
    plot_ly(x=~testspp,
        y=~casespp,
        type='scatter',
        marker=list(color = toRGB("grey50"), size=8), 
        text = ~county)%>%
    add_text(textfont = list(size = 8, color = toRGB("grey50")),
             textposition = "top")%>%
    layout(
        showlegend = FALSE,
        xaxis=list(title = "Total tests per 100,000 population",  
                 font=list(size=8),
                 tickfont = list(size=8),
                 range=c(0, maxx)
                 ),
        yaxis=list(title = "total confirmed cases per 100,000 population",
                 font=list(size=8),
                 tickfont = list(size=8),
                 range=c(0, maxy)
                 )
        )

```

```{r plotTrendTestsCounty, fig.align="left", out.width="800px", out.height="800px"}

##### __Q 11.2. How has the testing changed over time across counties?__ 
#__NOTE__: county-level testing data are available sincemid June, 

dtafig<-dtabycounty%>%
    mutate(group=county)%>%
    filter(county!="Unknown")%>%
    arrange(group, date)%>%
    mutate(
        newtests=tests-lag(tests),
        newtests=ifelse(group!=lag(group), NA, newtests), 
        newtests=ifelse(newtests<0,    0, newtests),
    
        newtestssmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newtests, 7)), 1), 
        newtestssmooth=ifelse(group!=lag(group), NA, newtestssmooth),
        
        newtestspp=round(100000*newtests/pop, 1),
        newtestssmoothpp=round(100000*newtestssmooth/pop, 5),
        
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
    
        newcasessmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 1), 
        newcasessmooth=ifelse(group!=lag(group), NA, newcasessmooth),
        
        newcasespp=round(100000*newcases/pop, 1),
        newcasessmoothpp=round(100000*newcasessmooth/pop, 5)
    )

panel <- . %>% 
    plot_ly(x=~date,
        y=~newtestssmoothpp, name="New tests per 100,000 (7-day rolling average)",
        type='scatter',mode = 'lines', 
        marker=list(color = c( "darkgray"), size = 1),
        line=list(color = c( "darkgray"))
        )%>%
    add_annotations(
        text = ~unique(group),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        showlegend = FALSE,
        xaxis=list(title = "",  
                 font=list(size=10),
                 tickfont = list(size=8) 
                 ),
        yaxis=list(title = "New daily tests per 100,000 population",
                   overlaying='y2', side="left", showgrid = FALSE)
        )

dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareX = TRUE, shareY = FALSE)%>%
        layout(
        yaxis=list(title = "New daily tests per 100,000 population",
                   overlaying='y2', side="left", showgrid = FALSE)
        )    

```

```{r plotTrendTestsCasesCounty, eval=FALSE, fig.align="left", out.width="800px", out.height="800px"}


panel <- . %>% 
    plot_ly(x=~date,
        y=~newtestssmoothpp, name="New tests per 100,000 (7-day rolling average)",
        type='scatter',mode = 'lines', 
        marker=list(color = c( "darkgray"), size = 1),
        line=list(color = c( "darkgray"))
        )%>%
    add_trace(
        y=~newcasessmoothpp, name="New cases per 100,000 (7-day rolling average)",
        type='scatter',mode = 'lines', 
        marker=list(color = c( "orange"), size = 1),
        line=list(color = c( "orange")),
        yaxis='y2'
        )%>%      
    add_annotations(
        text = ~unique(group),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        showlegend = FALSE,
        xaxis=list(title = "",  
                 font=list(size=10),
                 tickfont = list(size=8) 
                 ),
        yaxis=list(title = "New daily tests per 100,000 population",
                   overlaying='y2', side="left", showgrid = FALSE),
        yaxis2=list(title = "New daily cases per 100,000 population", 
                    side="right", showgrid = FALSE)
        )

dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 5, shareX = TRUE, shareY = FALSE)%>%
        layout(
        yaxis=list(title = "New daily tests per 100,000 population",
                   overlaying='y2', side="left", showgrid = FALSE),
        yaxis2=list(title = "New daily cases per 100,000 population", 
                    side="right", showgrid = FALSE)
        )    

```

---

##### __Q 12. Is the current (November) transmission situation in Maryland worse than the first wave in Spring?__    

There were many unknowns and [not enough tests in Spring of 2020](https://coronavirus.jhu.edu/testing/tracker/map/percent-positive). So, we cannot confidently compare the current transmission with the earlier one.   

Nevertheless, we can conclude that the current situation is substantially worse than what we had in summer - when we had a roughly similar level of testing - judging by the test volume and positivity rate (see Question 4 below). A positivity rate above 5% implies that there are not enough tests being conducted, and thus we very likely under-count new cases.   

A good news - if it is at all - is that proportionately there are more "young" people getting infected now than in spring (See Question 8.1). [This means mortality among those who are infected (i.e., case fatality ratio) would be lower now than before, in addition to the fact that clinical management of cases has improved](https://www.medrxiv.org/content/10.1101/2020.11.15.20232066v2). Even so, an increasing absolute number of hospitalizations can overwhelm health systems in the state. 


```{r plotTrendNewTestsNewCasesMD, results='asis', fig.align="left", out.width="800px"}
# use test-level data from MD  dashboard
dtafig<-dtaMD%>%select(date, newtests, newcases, percent_positive )%>%
    mutate(
           positiverate=percent_positive, 
           positiveratesmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(positiverate, 7)), 1), 
           positiveratesmooth =ifelse(positiveratesmooth<0,  0, positiveratesmooth), 
           newcasessmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 1),
           newcasessmooth =ifelse(newcasessmooth<0,  0, newcasessmooth)
           )

dtafig%>%
    plot_ly(x=~date, 
        type='scatter', mode='line',  
        y=~positiveratesmooth, name="Positive rate, 7-day average", 
        marker=list(color = "black", size=1),
        line=list(color = "black"))%>%
    add_trace(    
        y=~newcasessmooth, name="Daily new cases, 7-day average", 
        marker=list(color = "#1F77B4", size=1),
        line=list(color = "#1F77B4"), 
        yaxis='y2')%>%
    add_segments(x = min(dtafig$date), xend = max(dtafig$date), 
                 y = 5, yend = 5, yaxis='y', 
                 marker = list(color = "gray",size = 2),
                 line= list(color = "gray",  dash = 'dot'),
                 showlegend=FALSE)%>%
    layout(
        title = c("Trend of daily new cases and positive test rate"),
        xaxis = list(title = "", tickfont = list(size=10), showgrid = FALSE), 
        yaxis = list(title = "Positive rate (%)", 
                      #range=c(0, max(dtafig$positiveratesmooth)),
                      range=c(0, 35),
                      zeroline = TRUE,
                      side="left", showgrid = FALSE),
        yaxis2 = list(title = "Number of daily new cases", 
                     #range=c(0, max(dtafig$newcases)),
                     range=c(0, 3500),
                     zeroline = TRUE,
                     overlaying='y',  
                     side="right", showgrid = FALSE ),
        margin = list(r=100), 
        legend=list(orientation="v", xanchor = "left", yanchor = "center", 
                    x = 0.05, y = 0.95) 
        
        ) 

```


---

##### __Q 11. How is Maryland doing, compared to neighboring states and the country as a whole?__ 

```{r dtaPop_USstates}
#estimates:Total population, both sexes combined, as of 1 July (thousands)
dtapop_USstates<-read.csv("~/Dropbox/0 Project/COVID19_US/DataCensusBureau/co-est2019-alldata.csv")

dtapop_USstates<-dtapop_USstates%>%
    mutate(state=as.character(STNAME), 
           pop=as.numeric(POPESTIMATE2019))%>%
    filter(COUNTY==0)%>%
    select(state, pop)

```

```{r dtaCOVID_USstates}
url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv"

dtacases_USstates<-read.csv(url)%>%
    rename(country = Country_Region,
           state = Province_State,
           county = Admin2)%>%
    select(country, state, county, FIPS, Combined_Key, starts_with("X"))%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           cases = value)%>%
    mutate(country=as.character(country),
           state=as.character(state),
           county=as.character(county))%>%
    select(country, state, date, cases)%>%
    group_by(country, state, date)%>%
    summarize_all(funs(sum))%>%ungroup()

url<-"https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_US.csv"

dtadeaths_USstates<-read.csv(url)%>%
    rename(
           state = Province_State,
           county = Admin2)%>%
    select(state, county, FIPS, Combined_Key, starts_with("X"))%>%
    gather(variable, value, starts_with("X"))%>%
    rename(date = variable,
           deaths = value)%>%
    mutate(
           state=as.character(state),
           county=as.character(county))%>%
    select(state, date, deaths)%>%
    group_by(state, date)%>%
    summarize_all(funs(sum))%>%ungroup()

dtacovid_USstates<-left_join(dtacases_USstates, dtadeaths_USstates, by = c("state", "date"))%>%
    mutate(date=mdy(substring(date, 2)) )

```

```{r dta_USstates}
dta_USstates<-full_join(dtacovid_USstates, dtapop_USstates, by = "state")%>%
    filter(is.na(pop)==FALSE)%>%
    arrange(state, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(state!=lag(state), NA, newcases),
        
        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(state!=lag(state), NA, newdeaths),
        
        incidence=round(100000*cases/pop, 3), # confiremd cases per 100,000 pop
        cfr=round(100*deaths/cases, 3), # deaths per 100 confirmed cases   
        mortality=round(100000*deaths/pop, 3) # deaths per 100000 pop
    )%>%arrange(state, date)%>%
    mutate(
        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newdeathssmooth=c(NA,NA,NA,NA,NA,NA,rollmean(newdeaths, 7)), 
        newcasessmooth=ifelse(state!=lag(state), NA, newcasessmooth),
        newdeathssmooth=ifelse(state!=lag(state), NA, newdeathssmooth),
        newcasessmooth =round(newcasessmooth, 3),  
        newdeathssmooth=round(newdeathssmooth, 3),

        newcasessmoothpp=round(100000*newcasessmooth/pop, 1),   
        newdeathssmoothpp=round(100000*newdeathssmooth/pop, 1)

    )

dta_USstates<-dta_USstates%>%
    mutate(
        newcasessmooth   =ifelse(newcasessmooth<0,    0, newcasessmooth),
        newcasessmoothpp =ifelse(newcasessmoothpp<0,  0, newcasessmoothpp),
        newdeathssmooth  =ifelse(newdeathssmooth<0,   0, newdeathssmooth),
        newdeathssmoothpp=ifelse(newdeathssmoothpp<0, 0, newdeathssmoothpp)
    )

dta_USstates<-dta_USstates%>%filter(date>="2020-03-01")

```

```{r dtaus}

dtaus<-dtacovid_USstates%>%
    select(date, cases, deaths)%>%
    group_by(date)%>%
    summarize_all(funs(sum))%>% #collapse cases and deaths 
    mutate(pop=sum(dtapop_USstates$pop))%>% #total popualtion 
    arrange(date)%>%
    mutate(
        newcases=cases-lag(cases),
        newdeaths=deaths-lag(deaths),

        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newdeathssmooth=c(NA,NA,NA,NA,NA,NA,rollmean(newdeaths, 7)), 

        newcasessmooth =round(newcasessmooth, 3),  
        newdeathssmooth=round(newdeathssmooth, 3),

        newcasessmoothpp_US=round(100000*newcasessmooth/pop, 1),   
        newdeathssmoothpp_US=round(100000*newdeathssmooth/pop, 1))%>%
    filter(date>="2020-03-01")%>%
    select(date, newcasessmoothpp_US)

```

```{r dtacurve_USstates}
dtacurve_USstates<-left_join(dta_USstates, dtaus, by = c("date"))

dtacurve_USstates<-dtacurve_USstates%>%
    arrange(country, state, date)%>%
    group_by(state)%>%  
    mutate(
        latest=date==max(date), 
        
        peakcasespp=round(max(newcasessmoothpp, na.rm = TRUE), 1), 
        peakdate=as.character(date),
            peakdate=ifelse(peakcasespp!=newcasessmoothpp, "", peakdate),
            peakdate=ymd(substring(peakdate, 1)) )%>%
    fill(peakdate)%>%
    fill(peakdate, .direction = "up")%>%
    mutate(
        latestcasespp=newcasessmoothpp, 
        latestcasespp=ifelse(latest==FALSE, NA, latestcasespp),
        latestlevel=round((latestcasespp)/(peakcasespp), 3)
        )%>%
    fill(latestlevel)%>%
    fill(latestlevel, .direction = "up")%>%
    ungroup()%>%
    select(country, state, date, cases, deaths, pop, incidence, cfr, mortality, starts_with("new"), starts_with("start"), starts_with("peak"), starts_with("latest"))


```

```{r plotpanelMidAtlantic}    
mindate<-min(dtacurve$date)
maxdate<-max(dtacurve$date)

panel <- . %>% 
    plot_ly(x = ~date)%>% 
    add_trace(
        y = 0, type = 'scatter', mode = 'lines',
        line= list(color = "#F1F1F1") ) %>%    
    add_trace(
        y = 10, type = 'scatter', mode = 'lines',
        fill = 'tonexty',fillcolor='#EEEEEE', opacity=0.1,
        line= list(color = "#F1F1F1") ) %>%    
    add_lines(y = ~newcasessmoothpp_US,
        line= list(color = "#AF8199"),
        hoverinfo = 'text',
        text = ~paste(
                      '</br> United States',          
                      '</br> Date: ', date,
                      '</br> New cases per 100,000: ', newcasessmoothpp_US)  )%>%
    add_lines(y = ~newcasessmoothpp,
        line= list(color = "#073763"),  
        hoverinfo = 'text',
        text = ~paste(
                      '</br> State: ', state,          
                      '</br> Date: ', date,
                      '</br> New cases per 100,000: ', newcasessmoothpp)  )%>%

    add_annotations(
        text = ~unique(state),
        x = 0.5, y = 0.90, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)  )%>%
    layout(
        showlegend = FALSE,
        yaxis=list(title="New cases per 100,000" , 
                   range=c(0,maxy), showgrid = FALSE),
        xaxis=list(title="" , range=c(mindate,maxdate), showgrid = FALSE)
        ) 

```

_Note: The x-axis is date since March. The y-axis is 7-day rolling average of daily new cases per 100,000 population. The light gray box represents the number of daily new cases 10 or lower per 100,000. <span style="color: #630737;">The light purple line is the US national data</span>._   

```{r plotMidAtlantic, results="asis", fig.align="left", out.width="800px", out.height="450px"}

dtafig<-dtacurve_USstates%>%
    filter(state=="Maryland"|state=="Delaware"|state=="Virginia"|
               state=="District of Columbia"|
               state=="Pennsylvania")

maxy<-max(dtafig$newcasessmoothpp)
    
dtafig%>%
    group_by(state) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 2, shareX = TRUE, shareY = TRUE)  
```



---

##### __Q 10. What have been trends of new cases since the phase-2 reopening - across differnet groups by age, race, and county?__ 

With the reopening, we expect to see - and have seen - increases in new cases. We hope it remains within a manageable level that the health systems can respond effectively.  

Nonetheless, __where and among whom have the new cases increased most?__  

* The increase is most prominent among __those in their 10s and 20s. The two groups have not recovered back to the pre-opening level, and the trend among those in 10s is worrisome__. 

```{r plotTrendSincePhase2panel}
panel <- . %>% 
    plot_ly(x=~date,
        y=~newcasessmoothppMD, type='scatter', mode = 'lines', 
        marker=list(color = c( "#D6D6D6"), size = 0.3),
        line=list(color = c( "#D6D6D6")) 
        )%>%
    add_trace(
        y=~newcasessmoothpp, type='scatter', mode = 'lines', 
        marker=list(color = c( "#828282"), size = 1),
        line=list(color = c( "#828282"))
        )%>%
    add_trace(
        y=~newcasessmoothpp2, type='scatter', mode = 'lines', 
        marker=list(color = c( "#3288bd"), size = 1),
        line=list(color = c( "#3288bd"))
        )%>%   
    add_trace(
        y=~newcasessmoothpp3, type='scatter', mode = 'lines', 
        marker=list(color = c( "#f46d43"), size = 1),
        line=list(color = c( "#f46d43"))
        )%>%      
    add_trace(
        y=~newcasessmoothpp4, type='scatter', mode = 'lines', 
        marker=list(color = c( "#66bd63"), size = 1),
        line=list(color = c( "#66bd63"))
        )%>%      
    add_trace(
        y=~newcasessmoothpp5, type='scatter', mode = 'lines', 
        marker=list(color = c( "#f46d43"), size = 1),
        line=list(color = c( "#f46d43"))
        )%>%      
    add_trace(
        y=~newcasessmoothpp6, type='scatter', mode = 'lines', 
        marker=list(color = c( "#66bd63"), size = 1),
        line=list(color = c( "#66bd63"))
        )%>%     
    add_trace(
        y=~newcasessmoothpp7, type='scatter', mode = 'lines', 
        marker=list(color = c( "#f46d43"), size = 1),
        line=list(color = c( "#f46d43"))
        )%>%  
    add_trace(
        y=~newcasessmoothpp8, type='scatter', mode = 'lines', 
        marker=list(color = c( "#66bd63"), size = 1),
        line=list(color = c( "#66bd63"))
        )%>%      
    add_trace(
        y=~newcasessmoothpp9, type='scatter', mode = 'lines', 
        marker=list(color = c( "#f46d43"), size = 1),
        line=list(color = c( "#f46d43"))
        )%>%  
    add_trace(
        y=~newcasessmoothpp10, type='scatter', mode = 'lines', 
        marker=list(color = c( "#66bd63"), size = 1),
        line=list(color = c( "#66bd63"))
        )%>%    
    add_trace(
        y=~newcasessmoothpp11, type='scatter', mode = 'lines', 
        marker=list(color = c( "#f46d43"), size = 1),
        line=list(color = c( "#f46d43"))
        )%>%        
    add_trace(
        y=~newcasessmoothpp12, type='scatter', mode = 'lines', 
        marker=list(color = c( "#66bd63"), size = 1),
        line=list(color = c( "#66bd63"))
        )%>%    
    add_trace(
        y=~newcasessmoothpp13, type='scatter', mode = 'lines', 
        marker=list(color = c( "#f46d43"), size = 1),
        line=list(color = c( "#f46d43"))
        )%>%  
    add_trace(
        y=~newcasessmoothpp14, type='scatter', mode = 'lines', 
        marker=list(color = c( "#66bd63"), size = 1),
        line=list(color = c( "#66bd63"))
        )%>%    
    add_trace(
        y=~newcasessmoothpp15, type='scatter', mode = 'lines', 
        marker=list(color = c( "#f46d43"), size = 1),
        line=list(color = c( "#f46d43"))
        )%>%    
    add_trace(
        y=~newcasessmoothpp16, type='scatter', mode = 'lines', 
        marker=list(color = c( "#66bd63"), size = 1),
        line=list(color = c( "#66bd63"))
        )%>%         
    
    add_annotations(
        text = ~unique(group),
        x = 0.5, y = 0.95, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        showlegend = FALSE,
        xaxis=list(title = "", font=list(size=10),tickfont = list(size=8),
                   showgrid = FALSE),
        yaxis=list(title = "New daily cases/100,000", 
                   showgrid = FALSE)
        )
```

```{r plotTrendSincePhase2Age, results="asis", fig.align="left", out.width="800px", out.height="400px"}
dtafig<-dtabyage%>%
    filter(is.na(age)==FALSE)%>%
    mutate(group=agegroup)

dtafig<-dtafig%>%
    arrange(group, date)%>%
    mutate(
       
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
    
        newcasessmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 1), 
        newcasessmooth=ifelse(group!=lag(group), NA, newcasessmooth),
        
        newcasespp=round(100000*newcases/pop, 1),
        newcasessmoothpp=round(100000*newcasessmooth/pop, 5), 

        newcasessmooth2=newcasessmooth,
        newcasessmooth2=ifelse(date<=("2020-06-12"), NA, newcasessmooth2),  
        newcasessmooth3=newcasessmooth,
        newcasessmooth3=ifelse(date<=("2020-06-30"), NA, newcasessmooth3),
        newcasessmooth4=newcasessmooth,
        newcasessmooth4=ifelse(date<=("2020-07-31"), NA, newcasessmooth4),
        newcasessmooth5=newcasessmooth,
        newcasessmooth5=ifelse(date<=("2020-08-31"), NA, newcasessmooth5), 
        newcasessmooth6=newcasessmooth,
        newcasessmooth6=ifelse(date<=("2020-09-30"), NA, newcasessmooth6), 
        newcasessmooth7=newcasessmooth,
        newcasessmooth7=ifelse(date<=("2020-10-31"), NA, newcasessmooth7), 
        newcasessmooth8=newcasessmooth,
        newcasessmooth8=ifelse(date<=("2020-11-30"), NA, newcasessmooth8),   
        newcasessmooth9=newcasessmooth,
        newcasessmooth9=ifelse(date<=("2020-12-31"), NA, newcasessmooth9),    
        newcasessmooth10=newcasessmooth,
        newcasessmooth10=ifelse(date<=("2021-1-31"), NA, newcasessmooth10),    
        newcasessmooth11=newcasessmooth,
        newcasessmooth11=ifelse(date<=("2021-2-28"), NA, newcasessmooth11),    
        newcasessmooth12=newcasessmooth,
        newcasessmooth12=ifelse(date<=("2021-3-31"), NA, newcasessmooth12),     
        newcasessmooth13=newcasessmooth,
        newcasessmooth13=ifelse(date<=("2021-4-30"), NA, newcasessmooth13),             
        newcasessmooth14=newcasessmooth,
        newcasessmooth14=ifelse(date<=("2021-5-31"), NA, newcasessmooth14),             
        newcasessmooth15=newcasessmooth,
        newcasessmooth15=ifelse(date<=("2021-6-30"), NA, newcasessmooth15),         
        newcasessmooth16=newcasessmooth,
        newcasessmooth16=ifelse(date<=("2021-7-31"), NA, newcasessmooth16),         
        
        newcasessmoothpp2=newcasessmoothpp,
        newcasessmoothpp2=ifelse(date<=("2020-06-12"), NA, newcasessmoothpp2),  
        newcasessmoothpp3=newcasessmoothpp,
        newcasessmoothpp3=ifelse(date<=("2020-06-30"), NA, newcasessmoothpp3),
        newcasessmoothpp4=newcasessmoothpp,
        newcasessmoothpp4=ifelse(date<=("2020-07-31"), NA, newcasessmoothpp4),
        newcasessmoothpp5=newcasessmoothpp,
        newcasessmoothpp5=ifelse(date<=("2020-08-31"), NA, newcasessmoothpp5),
        newcasessmoothpp6=newcasessmoothpp,
        newcasessmoothpp6=ifelse(date<=("2020-09-30"), NA, newcasessmoothpp6),
        newcasessmoothpp7=newcasessmoothpp,
        newcasessmoothpp7=ifelse(date<=("2020-10-31"), NA, newcasessmoothpp7),
        newcasessmoothpp8=newcasessmoothpp,
        newcasessmoothpp8=ifelse(date<=("2020-11-30"), NA, newcasessmoothpp8),
        newcasessmoothpp9=newcasessmoothpp,
        newcasessmoothpp9=ifelse(date<=("2020-12-31"), NA, newcasessmoothpp9), 
        newcasessmoothpp10=newcasessmoothpp,
        newcasessmoothpp10=ifelse(date<=("2021-1-31"), NA, newcasessmoothpp10),
        newcasessmoothpp11=newcasessmoothpp,
        newcasessmoothpp11=ifelse(date<=("2021-2-28"), NA, newcasessmoothpp11),
        newcasessmoothpp12=newcasessmoothpp,
        newcasessmoothpp12=ifelse(date<=("2021-3-31"), NA, newcasessmoothpp12),
        newcasessmoothpp13=newcasessmoothpp,
        newcasessmoothpp13=ifelse(date<=("2021-4-30"), NA, newcasessmoothpp13),
        newcasessmoothpp14=newcasessmoothpp,
        newcasessmoothpp14=ifelse(date<=("2021-5-31"), NA, newcasessmoothpp14),
        newcasessmoothpp15=newcasessmoothpp,
        newcasessmoothpp15=ifelse(date<=("2021-6-30"), NA, newcasessmoothpp15),        
        newcasessmoothpp16=newcasessmoothpp,
        newcasessmoothpp16=ifelse(date<=("2021-7-31"), NA, newcasessmoothpp16)              
    )%>%
    group_by(group)%>%
    mutate(
           total=max(cases, na.rm = TRUE),   
           bottom=min(newcasessmooth2, na.rm = TRUE),
           current=newcasessmooth, 
           changeratio=round(current/bottom, 2),
           changediff =current-bottom)%>%
    ungroup()

dtafig$group<-factor(dtafig$group, 
                    levels = unique(dtafig$group) 
                    [order(dtafig$total, decreasing = TRUE)])

temp<-dtacurve_USstates%>%
    filter(state=="Maryland")%>%
    mutate(newcasessmoothppMD = newcasessmoothpp)%>%
    select(date, newcasessmoothppMD)
    
dtafig<-left_join(dtafig, temp, by = "date") 

dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 2, shareX = TRUE, titleX = FALSE, shareY = TRUE)%>%
        layout(
            title ="Trends of new daily cases per 100,000 by age, Maryland", 
            yaxis=list(title = "New daily cases/100,000")
        )
```
_Solid line is 7-day rolling average of daily new cases per 100,000 population. <span style="color: #3288bd;">Blue segment of the line is June after reopening on June 12</span>, followed by: <span style="color: #f46d43;">July</span>, <span style="color: #66bd63;">August</span>, <span style="color: #f46d43;">September</span>, <span style="color: #66bd63;">October</span>, <span style="color: #f46d43;">November</span>, <span style="color: #66bd63;">December</span>, <span style="color: #f46d43;">January</span>, <span style="color: #66bd63;">February</span>, <span style="color: #f46d43;">March</span>, <span style="color: #66bd63;">April</span>, <span style="color: #f46d43;">May</span>, <span style="color: #66bd63;">June</span>, <span style="color: #f46d43;">July</span>, and <span style="color: #66bd63;">August</span>.<span style="color: #ABABAB;">The light gray line is the Maryland state-level data.</span>_

```{r}
temp<-dtafig%>%
    filter(is.na(changeratio)==FALSE)%>%
    filter(date==max(date))%>%
    select(group, current, bottom, changeratio, changediff)

head(temp, 10)

```

* It is increasing across all race & ethnic groups, but __the relative increase from the lowest level in June is largest among white and African-American populations__.  

```{r plotTrendSincePhase2Race, results="asis", fig.align="left", out.width="800px", out.height="250px"}
dtafig<-dtabyrace%>%
    filter(race!="Other" & race!="Unknown")%>%
    mutate(group=race)

dtafig<-dtafig%>%
    arrange(group, date)%>%
    mutate(
        
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
    
        newcasessmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 1), 
        newcasessmooth=ifelse(group!=lag(group), NA, newcasessmooth),
        
        newcasespp=round(100000*newcases/pop, 1),
        newcasessmoothpp=round(100000*newcasessmooth/pop, 5), 

        newcasessmooth2=newcasessmooth,
        newcasessmooth2=ifelse(date<=("2020-06-12"), NA, newcasessmooth2),  
        newcasessmooth3=newcasessmooth,
        newcasessmooth3=ifelse(date<=("2020-06-30"), NA, newcasessmooth3),
        newcasessmooth4=newcasessmooth,
        newcasessmooth4=ifelse(date<=("2020-07-31"), NA, newcasessmooth4),
        newcasessmooth5=newcasessmooth,
        newcasessmooth5=ifelse(date<=("2020-08-31"), NA, newcasessmooth5), 
        newcasessmooth6=newcasessmooth,
        newcasessmooth6=ifelse(date<=("2020-09-30"), NA, newcasessmooth6), 
        newcasessmooth7=newcasessmooth,
        newcasessmooth7=ifelse(date<=("2020-10-31"), NA, newcasessmooth7), 
        newcasessmooth8=newcasessmooth,
        newcasessmooth8=ifelse(date<=("2020-11-30"), NA, newcasessmooth8),       
        newcasessmooth9=newcasessmooth,
        newcasessmooth9=ifelse(date<=("2020-12-31"), NA, newcasessmooth9),    
        newcasessmooth10=newcasessmooth,
        newcasessmooth10=ifelse(date<=("2021-1-31"), NA, newcasessmooth10),            
        newcasessmooth11=newcasessmooth,
        newcasessmooth11=ifelse(date<=("2021-2-28"), NA, newcasessmooth11),    
        newcasessmooth12=newcasessmooth,
        newcasessmooth12=ifelse(date<=("2021-3-31"), NA, newcasessmooth12),            
        newcasessmooth13=newcasessmooth,
        newcasessmooth13=ifelse(date<=("2021-4-30"), NA, newcasessmooth13),             
        newcasessmooth14=newcasessmooth,
        newcasessmooth14=ifelse(date<=("2021-5-31"), NA, newcasessmooth14),             
        newcasessmooth15=newcasessmooth,
        newcasessmooth15=ifelse(date<=("2021-6-30"), NA, newcasessmooth15),             
        newcasessmooth16=newcasessmooth,
        newcasessmooth16=ifelse(date<=("2021-7-31"), NA, newcasessmooth16),         
        
        newcasessmoothpp2=newcasessmoothpp,
        newcasessmoothpp2=ifelse(date<=("2020-06-12"), NA, newcasessmoothpp2),  
        newcasessmoothpp3=newcasessmoothpp,
        newcasessmoothpp3=ifelse(date<=("2020-06-30"), NA, newcasessmoothpp3),
        newcasessmoothpp4=newcasessmoothpp,
        newcasessmoothpp4=ifelse(date<=("2020-07-31"), NA, newcasessmoothpp4),
        newcasessmoothpp5=newcasessmoothpp,
        newcasessmoothpp5=ifelse(date<=("2020-08-31"), NA, newcasessmoothpp5),
        newcasessmoothpp6=newcasessmoothpp,
        newcasessmoothpp6=ifelse(date<=("2020-09-30"), NA, newcasessmoothpp6),
        newcasessmoothpp7=newcasessmoothpp,
        newcasessmoothpp7=ifelse(date<=("2020-10-31"), NA, newcasessmoothpp7),
        newcasessmoothpp8=newcasessmoothpp,
        newcasessmoothpp8=ifelse(date<=("2020-11-30"), NA, newcasessmoothpp8),
        newcasessmoothpp9=newcasessmoothpp,
        newcasessmoothpp9=ifelse(date<=("2020-12-31"), NA, newcasessmoothpp9), 
        newcasessmoothpp10=newcasessmoothpp,
        newcasessmoothpp10=ifelse(date<=("2021-1-31"), NA, newcasessmoothpp10),
        newcasessmoothpp11=newcasessmoothpp,
        newcasessmoothpp11=ifelse(date<=("2021-2-28"), NA, newcasessmoothpp11),
        newcasessmoothpp12=newcasessmoothpp,
        newcasessmoothpp12=ifelse(date<=("2021-3-31"), NA, newcasessmoothpp12),
        newcasessmoothpp13=newcasessmoothpp,
        newcasessmoothpp13=ifelse(date<=("2021-4-30"), NA, newcasessmoothpp13),
        newcasessmoothpp14=newcasessmoothpp,
        newcasessmoothpp14=ifelse(date<=("2021-5-31"), NA, newcasessmoothpp14),
        newcasessmoothpp15=newcasessmoothpp,
        newcasessmoothpp15=ifelse(date<=("2021-6-30"), NA, newcasessmoothpp15),        
        newcasessmoothpp16=newcasessmoothpp,
        newcasessmoothpp16=ifelse(date<=("2021-7-31"), NA, newcasessmoothpp16)       
        
    )%>%
    group_by(group)%>%
    mutate(
           total=max(cases, na.rm = TRUE),   
           bottom=min(newcasessmooth2, na.rm = TRUE),
           current=newcasessmooth, 
           changeratio=round(current/bottom, 2),
           changediff =current-bottom)%>%
    ungroup()

dtafig$group<-factor(dtafig$group, 
                    levels = unique(dtafig$group) 
                    [order(dtafig$total, decreasing = TRUE)])

temp<-dtacurve_USstates%>%
    filter(state=="Maryland")%>%
    mutate(newcasessmoothppMD = newcasessmoothpp)%>%
    select(date, newcasessmoothppMD)
    
dtafig<-left_join(dtafig, temp, by = "date") 

dtafig%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareX = TRUE, titleX = FALSE, shareY = TRUE)%>%
        layout(
            title ="Trends of new daily cases per 100,000 by race, Maryland", 
            yaxis=list(title = "New daily cases/100,000")
        )
```
_Solid line is 7-day rolling average of daily new cases per 100,000 population. <span style="color: #3288bd;">Blue segment of the line is June after reopening on June 12</span>, followed by: <span style="color: #f46d43;">July</span>, <span style="color: #66bd63;">August</span>, <span style="color: #f46d43;">September</span>, <span style="color: #66bd63;">October</span>, <span style="color: #f46d43;">November</span>, <span style="color: #66bd63;">December</span>, <span style="color: #f46d43;">January</span>, <span style="color: #66bd63;">February</span>, <span style="color: #f46d43;">March</span>, <span style="color: #66bd63;">April</span>, <span style="color: #f46d43;">May</span>, <span style="color: #66bd63;">June</span>, <span style="color: #f46d43;">July</span>, and <span style="color: #66bd63;">August</span>.<span style="color: #ABABAB;">The light gray line is the Maryland state-level data.</span>_

```{r}
temp<-dtafig%>%
    filter(is.na(changeratio)==FALSE)%>%
    filter(date==max(date))%>%
    select(group, current, bottom, changeratio, changediff)

head(temp, 10)

```

```{r plotTrendSincePhase2County}

dtafig<-dtabycounty%>%
    mutate(group=county)%>%
    arrange(group, date)%>%
    mutate(
        newtests=tests-lag(tests),
        newtests=ifelse(group!=lag(group), NA, newtests), 
        newtests=ifelse(newtests<0,    0, newtests),
    
        newtestssmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newtests, 7)), 1), 
        newtestssmooth=ifelse(group!=lag(group), NA, newtestssmooth),
        
        newtestspp=round(100000*newtests/pop, 1),
        newtestssmoothpp=round(100000*newtestssmooth/pop, 5),
        
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
    
        newcasessmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 1), 
        newcasessmooth=ifelse(group!=lag(group), NA, newcasessmooth),
        
        newcasespp=round(100000*newcases/pop, 1),
        newcasessmoothpp=round(100000*newcasessmooth/pop, 5), 

        newcasessmooth2=newcasessmooth,
        newcasessmooth2=ifelse(date<=("2020-06-12"), NA, newcasessmooth2),  
        newcasessmooth3=newcasessmooth,
        newcasessmooth3=ifelse(date<=("2020-06-30"), NA, newcasessmooth3),
        newcasessmooth4=newcasessmooth,
        newcasessmooth4=ifelse(date<=("2020-07-31"), NA, newcasessmooth4),
        newcasessmooth5=newcasessmooth,
        newcasessmooth5=ifelse(date<=("2020-08-31"), NA, newcasessmooth5), 
        newcasessmooth6=newcasessmooth,
        newcasessmooth6=ifelse(date<=("2020-09-30"), NA, newcasessmooth6), 
        newcasessmooth7=newcasessmooth,
        newcasessmooth7=ifelse(date<=("2020-10-31"), NA, newcasessmooth7), 
        newcasessmooth8=newcasessmooth,
        newcasessmooth8=ifelse(date<=("2020-11-30"), NA, newcasessmooth8),    
        newcasessmooth9=newcasessmooth,
        newcasessmooth9=ifelse(date<=("2020-12-31"), NA, newcasessmooth9),    
        newcasessmooth10=newcasessmooth,
        newcasessmooth10=ifelse(date<=("2021-1-31"), NA, newcasessmooth10),            
        newcasessmooth11=newcasessmooth,
        newcasessmooth11=ifelse(date<=("2021-2-28"), NA, newcasessmooth11),    
        newcasessmooth12=newcasessmooth,
        newcasessmooth12=ifelse(date<=("2021-3-31"), NA, newcasessmooth12),            
        newcasessmooth13=newcasessmooth,
        newcasessmooth13=ifelse(date<=("2021-4-30"), NA, newcasessmooth13),             
        newcasessmooth14=newcasessmooth,
        newcasessmooth14=ifelse(date<=("2021-5-31"), NA, newcasessmooth14),             
        newcasessmooth15=newcasessmooth,
        newcasessmooth15=ifelse(date<=("2021-6-30"), NA, newcasessmooth15),             
        newcasessmooth16=newcasessmooth,
        newcasessmooth16=ifelse(date<=("2021-7-31"), NA, newcasessmooth16),         
        
        newcasessmoothpp2=newcasessmoothpp,
        newcasessmoothpp2=ifelse(date<=("2020-06-12"), NA, newcasessmoothpp2),  
        newcasessmoothpp3=newcasessmoothpp,
        newcasessmoothpp3=ifelse(date<=("2020-06-30"), NA, newcasessmoothpp3),
        newcasessmoothpp4=newcasessmoothpp,
        newcasessmoothpp4=ifelse(date<=("2020-07-31"), NA, newcasessmoothpp4),
        newcasessmoothpp5=newcasessmoothpp,
        newcasessmoothpp5=ifelse(date<=("2020-08-31"), NA, newcasessmoothpp5),
        newcasessmoothpp6=newcasessmoothpp,
        newcasessmoothpp6=ifelse(date<=("2020-09-30"), NA, newcasessmoothpp6),
        newcasessmoothpp7=newcasessmoothpp,
        newcasessmoothpp7=ifelse(date<=("2020-10-31"), NA, newcasessmoothpp7),
        newcasessmoothpp8=newcasessmoothpp,
        newcasessmoothpp8=ifelse(date<=("2020-11-30"), NA, newcasessmoothpp8),
        newcasessmoothpp9=newcasessmoothpp,
        newcasessmoothpp9=ifelse(date<=("2020-12-31"), NA, newcasessmoothpp9), 
        newcasessmoothpp10=newcasessmoothpp,
        newcasessmoothpp10=ifelse(date<=("2021-1-31"), NA, newcasessmoothpp10),
        newcasessmoothpp11=newcasessmoothpp,
        newcasessmoothpp11=ifelse(date<=("2021-2-28"), NA, newcasessmoothpp11),
        newcasessmoothpp12=newcasessmoothpp,
        newcasessmoothpp12=ifelse(date<=("2021-3-31"), NA, newcasessmoothpp12),
        newcasessmoothpp13=newcasessmoothpp,
        newcasessmoothpp13=ifelse(date<=("2021-4-30"), NA, newcasessmoothpp13),
        newcasessmoothpp14=newcasessmoothpp,
        newcasessmoothpp14=ifelse(date<=("2021-5-31"), NA, newcasessmoothpp14),
        newcasessmoothpp15=newcasessmoothpp,
        newcasessmoothpp15=ifelse(date<=("2021-6-30"), NA, newcasessmoothpp15),        
        newcasessmoothpp16=newcasessmoothpp,
        newcasessmoothpp16=ifelse(date<=("2021-7-31"), NA, newcasessmoothpp16)     
        
    )%>%
    group_by(group)%>%
    mutate(
        peakcasespp=round(max(newcasessmoothpp, na.rm = TRUE), 5), 
        peakdate=as.character(date),
            peakdate=ifelse(peakcasespp!=newcasessmoothpp, "", peakdate),
            peakdate=ymd(substring(peakdate, 1)),      
        
        total=max(cases, na.rm = TRUE),   
        bottom=min(newcasessmooth2, na.rm = TRUE),
        current=newcasessmooth, 
        changeratio=round(current/bottom, 2),
        changediff =current-bottom)%>%
    ungroup()

dtafig$group<-factor(dtafig$group, 
                    levels = unique(dtafig$group) 
                    [order(dtafig$total, decreasing = TRUE)])

temp<-dtacurve_USstates%>%
    filter(state=="Maryland")%>%
    mutate(newcasessmoothppMD = newcasessmoothpp)%>%
    select(date, newcasessmoothppMD)
    
dtafig<-left_join(dtafig, temp, by = "date") 
```

* Counties with the highest peak less than 100 per 100,000.   
```{r plotTrendSincePhase2County_1, results='asis', fig.align="left", out.width="800px", out.height="800px"}

dtafig%>%
    filter(county!="Unknown")%>%
    #filter(total>=500)%>%
    filter(peakcasespp<100)%>%
    group_by(group)%>%
    do(p = panel(.))%>%
    subplot(nrows = 4, shareX = TRUE, shareY = TRUE)%>%
    layout(
        title ="Trends of new daily cases per 100,000 by county, Maryland", 
        yaxis=list(title = "New daily cases/100,000")
        )    
```

* Counties with the highest peak 100 per 100,000 or higher.    
```{r plotTrendSincePhase2County_2, results='asis', fig.align="left", out.width="640px", out.height="250px"}

dtafig%>%
    filter(county!="Unknown")%>%
    #filter(total>=500)%>%
    filter(peakcasespp>=100)%>%
    group_by(group) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE)%>%
        layout(
            title =" ", 
            yaxis=list(title = "New daily cases/100,000")
        )    
```
_Solid line is 7-day rolling average of daily new cases per 100,000 population. <span style="color: #3288bd;">Blue segment of the line is June after reopening on June 12</span>, followed by: <span style="color: #f46d43;">July</span>, <span style="color: #66bd63;">August</span>, <span style="color: #f46d43;">September</span>, <span style="color: #66bd63;">October</span>, <span style="color: #f46d43;">November</span>, <span style="color: #66bd63;">December</span>, <span style="color: #f46d43;">January</span>, <span style="color: #66bd63;">February</span>, <span style="color: #f46d43;">March</span>, <span style="color: #66bd63;">April</span>, <span style="color: #f46d43;">May</span>, <span style="color: #66bd63;">June</span>, <span style="color: #f46d43;">July</span>, and <span style="color: #66bd63;">August</span>.<span style="color: #ABABAB;">The light gray line is the Maryland state-level data.</span>_

```{r dtaMDcounty_export}
dtaMDCOVIDcounty_HPC_Lightening<-dtafig%>%
    select(date, county, pop, 
           cases, deaths, probabledeaths, tests, personstested, positivityrate, 
           newtests, newtestssmooth, newtestssmoothpp,
           newcases, newcasessmooth, newcasessmoothpp )

write.csv(dtaMDCOVIDcounty_HPC_Lightening, "~/Dropbox/0 iSquared/iSquared_HPC_COVID/Covid-19 HPC Lightning Pilot/Covid-19 HPC Lightning Pilot/dtaMDHD/dtaMDCOVIDcounty.csv")

colnames(dtaMDCOVIDcounty_HPC_Lightening)

colnames(read.csv("~/Dropbox/0 iSquared/iSquared_HPC_COVID/Covid-19 HPC Lightning Pilot/Covid-19 HPC Lightning Pilot/dtaMDHD/dtaMDCOVIDcounty.csv"))
```

---

##### __Q 9. Maryland started phase-2 reopening from June 12th. How important is social distancing?__  

__VERY IMPORTANT!__ The state starts [phase-2 reopening](https://www.wbaltv.com/article/coronavirus-recovery-plan-maryland-stage-two-update-governor-larry-hogan/32824562) on June 12th probably for various reasons. The number of new cases had been declining (see Question 2) - _[though third highest in the country as of June 10th](https://rpubs.com/YJ_Choi/COVID19_US_supplement) when the phase-2 reopening was announced_. Test positivity rate is decreasing (see Question 4) - _though still well above 5% as of June 10th_. Hospitalization is decreasing and under the state capacity threshold. Economic reasons are important, too.   

However, __the number of new confirmed cases is substantially higher currently than in early March__ (see below also Question 2). In other words, __without following strict preventive guidelines, our chance of getting infected is actually higher now than in early March__, since there is a higher proportion of the state population who are likely contagious. You may wonder if this higher number of new cases now is because of more testing, thus maybe things are potentially better now than in early March. That's possible (since we know very little about the level back then), but probably unlikely based on other pieces of data - such as test positivity rate (see Question 4).       

Still not convinced? Think this way. As of June 10, __our number of new infections ([11 per 100,000 population](https://rpubs.com/YJ_Choi/COVID19_US_states_curve)) was about 9 times higher than the peak level in [South Korea](https://rpubs.com/YJ_Choi/COVID19_SouthKorea) (back in early March) and also higher than the first peak level in Italy back in late March, an earlier epicenter in Europe__ ([see here for more international comparisons](https://rpubs.com/YJ_Choi/KCOVID_Global)).   

We may reopen. But, __we must keep social distancing seriously__. Again, here are [business guidelines from the state](https://commerce.maryland.gov/Documents/BusinessResource/Restaurants-bars-COVID-19-Best-Practices.pdf) and [preventive guidelines from CDC](https://www.cdc.gov/coronavirus/2019-ncov/protect/index.html).  

```{r plotMD_Global, results="asis", fig.align="left", out.width="800px"}

dtafig<-dtacurve%>%
    select(group, date, newcasessmoothpp)%>%
    filter(group!="New York, US")%>%
    select(group, date, newcasessmoothpp)%>%
    mutate(
        group=paste0("Y_",group)
    ) %>% 
    arrange(date, group) %>% 
    spread(group, newcasessmoothpp, fill = NA, convert = FALSE)%>%
    rename(Y_MD = "Y_Maryland, US",
           Y_SK = "Y_South Korea")
#%>%
#    mutate(Y_Italy=ifelse(date>="2020-10-20", NA, Y_Italy))

plot_ly(dtafig, x=~date, y=~Y_MD, name = "Maryland, US", 
        type = 'scatter', mode='lines', line = list(color = c("#1f77b4")),
        hoverinfo = 'text',
        text = ~paste(
                      '</br> Date: ', date,
                      '</br> New cases per 100,000: ', Y_MD)) %>%
    add_trace(y=~Y_Italy, name="Italy", line = list(color = c("#e34a33")) ,
            hoverinfo = 'text',
            text = ~paste(
                          '</br> Date: ', date,
                          '</br> New cases per 100,000: ', Y_Italy)) %>%
    add_trace(y=~Y_SK, name="South Korea", line = list(color = c("#b30000")) ,
            hoverinfo = 'text',
            text = ~paste(
                          '</br> Date: ', date,
                          '</br> New cases per 100,000: ', Y_SK)) %>%
    layout(showlegend=TRUE,
           title = "New cases per 100,000 population (7-day rolling average)", 
           xaxis = list(title = "Date", 
                        tickfont = list(size=10)),
           yaxis = list(title = "Daily new confirmed cases per 100,000 population"), 
           legend = list(font=list(size=12), 
                      orientation = "v", xanchor = "left",  
                      x=0.1, y=0.9)    
           )

#    add_trace(y=~Y_NY, name="New York, US", line = list(color = c("#fc8d59")) ,
#            hoverinfo = 'text',
#            text = ~paste(
#                          '</br> Date: ', date,
#                          '</br> New cases per 100,000: ', Y_NY)) %>%
```
(Date sources: [JHU/CSSE COVID-19 Dashgboard](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data), [World Population Prospects 2019 Revision](https://population.un.org/wpp/), [Maryland Population from US Census Bureau](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage)) 

---

##### __Q 8. Demographic characteristics of people with confirmed COVID-19 cases and those who died from COVID-19: how has it changed over time?__ 

##### __Q 8.1. Focusing on recent cases and deaths, using weekly data__ 

Looking at weekly data on new cases, the shift towards younger age groups has continued since the beginning. By mid September, almost half of the new confirmed cases in Maryland is by those younger than 30. Since mid June, the share of white people has increased among new weekly cases. This however does not mean that incidence rate is higher among white (see Questions 6 & 10). 

It is important to know _age composition within each race_ among new cases as well. As of mid September, COVID data in Maryland are broken down by only one dimension - either age, race, or sex. Here's one study looking at [how states share COVID data broken down by relevant and multiple characteristics: Maryland isn't doing well from that sense](https://www.healthaffairs.org/do/10.1377/hblog20200710.964611/full/). 
```{r, eval=FALSE}
dtafigage<-dtabyage%>%
    filter(is.na(age)==FALSE)%>%
    mutate(group=agegroup)%>%
    arrange(group, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
        
        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(group!=lag(group), NA, newdeaths), 
        newdeaths=ifelse(newdeaths<0,    0, newdeaths),        
        
        week=as.numeric(strftime(date, format = "%V")),
        totalnewcasesweekly=sum(newcases),
        numberofdays=1
    )%>%
    select(group, week, pop, newcases, newdeaths, numberofdays)%>%
    group_by(group, week)%>%
    summarize_all(sum)%>%
    group_by(week)%>%
    mutate(

        totalnewcases=sum(newcases, na.rm = TRUE),
        totalnewdeaths=sum(newdeaths, na.rm = TRUE),
        
        pctnewcases=round(100*newcases/totalnewcases,1), 
        pctnewdeaths=round(100*newdeaths/totalnewdeaths,1)        )%>%
    ungroup()%>%
    mutate(
        first.day=as.numeric(format(as.Date("2020-01-01"), "%w")), 
        weekdate=as.Date("2020-01-01") + week * 7 - first.day)

dtafigrace<-dtabyrace%>%
    #filter(race!="Other" & race!="Unknown")%>%
    filter(race!="Unknown")%>%
    mutate(group=race)%>%
    arrange(group, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
        
        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(group!=lag(group), NA, newdeaths), 
        newdeaths=ifelse(newdeaths<0,    0, newdeaths),        
        
        week=as.numeric(strftime(date, format = "%V")),
        totalnewcasesweekly=sum(newcases),
        numberofdays=1
    )%>%
    select(group, week, pop, newcases, newdeaths, numberofdays)%>%
    group_by(group, week)%>%
    summarize_all(sum)%>%
    group_by(week)%>%
    mutate(
        totalnewcases=sum(newcases, na.rm = TRUE),
        totalnewdeaths=sum(newdeaths, na.rm = TRUE),
        
        pctnewcases=round(100*newcases/totalnewcases,1), 
        pctnewdeaths=round(100*newdeaths/totalnewdeaths,1) )%>%
    ungroup()%>%
    mutate(
        first.day=as.numeric(format(as.Date("2020-01-01"), "%w")), 
        weekdate=as.Date("2020-01-01") + week * 7 - first.day)
```

```{r}
dtafigage<-dtabyage%>%
    filter(is.na(age)==FALSE)%>%
    mutate(group=agegroup)%>%
    arrange(group, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
        
        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(group!=lag(group), NA, newdeaths), 
        newdeaths=ifelse(newdeaths<0,    0, newdeaths),        
        
        #week=as.numeric(strftime(date, format = "%V")),
        #totalnewcasesweekly=sum(newcases),
        latest  =max(date, na.rm = TRUE),
        retromonth =  floor((latest-date)/30),
        totalnewcasesmonthly=sum(newcases),
        numberofdays=1
    )%>%
    group_by(retromonth)%>%
    mutate(
        retromonthdate=max(date, na.rm = TRUE))%>%
    select(group, retromonthdate, pop, newcases, newdeaths, numberofdays)%>%
    group_by(group, retromonthdate)%>%
    summarize_all(sum)%>%
    ungroup()%>%
    group_by(retromonthdate)%>%
    mutate(

        totalnewcases=sum(newcases, na.rm = TRUE),
        totalnewdeaths=sum(newdeaths, na.rm = TRUE),
        
        pctnewcases=round(100*newcases/totalnewcases,1), 
        pctnewdeaths=round(100*newdeaths/totalnewdeaths,1))%>%
    ungroup()

dtafigrace<-dtabyrace%>%
    filter(is.na(race)==FALSE)%>%
    filter(race!="Unknown")%>%
    mutate(group=race)%>%
    arrange(group, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(group!=lag(group), NA, newcases), 
        newcases=ifelse(newcases<0,    0, newcases),
        
        newdeaths=deaths-lag(deaths),
        newdeaths=ifelse(group!=lag(group), NA, newdeaths), 
        newdeaths=ifelse(newdeaths<0,    0, newdeaths),        
        
        #week=as.numeric(strftime(date, format = "%V")),
        #totalnewcasesweekly=sum(newcases),
        latest  =max(date, na.rm = TRUE),
        retromonth =  floor((latest-date)/30),
        totalnewcasesmonthly=sum(newcases),
        numberofdays=1
    )%>%
    group_by(retromonth)%>%
    mutate(
        retromonthdate=max(date, na.rm = TRUE))%>%
    select(group, retromonthdate, pop, newcases, newdeaths, numberofdays)%>%
    group_by(group, retromonthdate)%>%
    summarize_all(sum)%>%
    ungroup()%>%
    group_by(retromonthdate)%>%
    mutate(

        totalnewcases=sum(newcases, na.rm = TRUE),
        totalnewdeaths=sum(newdeaths, na.rm = TRUE),
        
        pctnewcases=round(100*newcases/totalnewcases,1), 
        pctnewdeaths=round(100*newdeaths/totalnewdeaths,1))%>%
    ungroup()
```

```{r plotWeeklyTrendCases, results="asis", fig.align="left", out.width="800px", eval=FALSE}
dtafigage %>% filter(numberofdays==7) %>% group_by(group) %>% 
    arrange(week) %>%
    plot_ly( x = ~weekdate, y = ~pctnewcases, type = "bar",
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigage$group)),
                                "Spectral")
             ) %>%
    layout(
        title ="Age composition among weekly new cases over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

dtafigrace %>% filter(numberofdays==7) %>% group_by(group) %>% 
    arrange(weekdate) %>%
    plot_ly( x = ~weekdate, y = ~pctnewcases, type = "bar",
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigrace$group)),
                                "Set3")
             ) %>%
    layout(
        title ="Race composition among weekly new cases over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

```

```{r plotMonthlyTrendCases, results="asis", fig.align="left", out.width="800px"}
dtafigage %>% group_by(group) %>% 
    arrange(retromonthdate) %>%
    plot_ly( x = ~retromonthdate, y = ~pctnewcases, type = "bar",
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigage$group)),
                                "Spectral")
             ) %>%
    layout(
        title ="Age composition among monthly new cases over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

dtafigrace %>% group_by(group) %>% 
    arrange(retromonthdate) %>%
    plot_ly( x = ~retromonthdate, y = ~pctnewcases, type = "bar",
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigrace$group)),
                                "Set3")
             ) %>%
    layout(
        title ="Race composition among monthly new cases over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

```
_NOTE on race data_: composition excluding cases with unknown race. Hispanic was not reported as a separate category until April 15th.  

Meanwhile, the age composition among deaths has been by and large similar - predominantly by those 50 or older. The race-composition also roughly has remained similar. 
```{r plotWeeklyTrendDeaths, results="asis", fig.align="left", out.width="800px", eval=FALSE}
dtafigage %>% filter(numberofdays==7) %>% group_by(group) %>% 
    arrange(week) %>%
    plot_ly( x = ~weekdate, y = ~pctnewdeaths, type = "bar", showlegend=F,
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigage$group)),
                                "Spectral")
             ) %>%
    layout(
        barmode = 'stack',
        title ="Age composition among weekly new deaths over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 
    
dtafigrace %>% filter(numberofdays==7) %>% group_by(group) %>% 
    arrange(week) %>%
    plot_ly( x = ~weekdate, y = ~pctnewdeaths, type = "bar", showlegend=F,
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigrace$group)),
                                "Set3")
             ) %>%
    layout(
        barmode = 'stack',
        title ="Race composition among weekly new deaths over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

```

```{r plotMonthlyTrendDeaths, results="asis", fig.align="left", out.width="800px"}
dtafigage %>% group_by(group) %>% 
    plot_ly( x = ~retromonthdate, y = ~pctnewdeaths, type = "bar", showlegend=F,
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigage$group)),
                                "Spectral")
             ) %>%
    layout(
        barmode = 'stack',
        title ="Age composition among monthly new deaths over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 
    
dtafigrace %>% group_by(group) %>% 
    plot_ly( x = ~retromonthdate, y = ~pctnewdeaths, type = "bar", showlegend=F,
             color= ~group, 
             colors = brewer.pal(length(unique(dtafigrace$group)),
                                "Set3")
             ) %>%
    layout(
        barmode = 'stack',
        title ="Race composition among monthly new deaths over time, Maryland", 
        yaxis = list(title = "Percent",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

```
_NOTE on race data_: composition excluding cases with unknown race. Hispanic was not reported as a separate category until April 15th.  

##### __Q 8.2. Focusing on overall picture, using cumulative data__ 
Again, among those with COVID-19, the proportions of younger population have increased. Also, the proportions of minority groups, __especially Hispanics__, have increased. __Only 10% of population is Hispanic (as of 2018), but one third of confirmed cases belong to Hipanic population so far__.     

```{r plotcompositiontrend, results="asis", fig.align="left", out.width="800px"}
### cases

dtafig <- dtabyage%>%
    select(date, age, agegroup, cases, pop)%>%
    filter(is.na(age)==FALSE)%>%
    group_by(date)%>%
    mutate(
        total=sum(cases),
        pct=round(100*cases/total,1), 
        totalpop=sum(pop),
        pctpop=round(100*pop/totalpop,1) )%>%
    ungroup()

dtapopbyage <- dtafig%>%filter(date==max(date))%>%select(agegroup, pop, totalpop, pctpop)

#head(dtapopbyage, 10)

fig1<-dtafig %>% group_by(agegroup) %>% 
    arrange(date) %>%
    plot_ly( x = ~date, y = ~pct, type = "bar",
             color= ~agegroup, 
             colors = brewer.pal(length(unique(dtafig$agegroup)),
                                "Spectral")
             ) %>%
    layout(
        title ="Composition by age-group among cumulative confirmed COVID-19 cases over time, Maryland", 
        yaxis = list(title = "Percent of confirmed cases",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

fig1

dtafig <- dtabyrace%>%
    select(date, race, cases, pop)%>%
    filter(is.na(race)==FALSE)%>%
    filter(race!="Unknown")%>%
    mutate(
        raceorder="", 
        raceorder=ifelse(race=="White", "1 White", raceorder),
        raceorder=ifelse(race=="African-American", "2 African-American", raceorder),
        raceorder=ifelse(race=="Hispanic", "3 Hispanic", raceorder),
        raceorder=ifelse(race=="Asian", "4 Asian", raceorder),
        raceorder=ifelse(race=="Other", "5 Other", raceorder)
        )%>%
    group_by(date)%>%
    mutate(
        total=sum(cases),
        pct=round(100*cases/total,1), 
        totalpop=sum(pop),
        pctpop=round(100*pop/totalpop,1) )%>%
    ungroup()

dtapopbyrace <- dtafig%>%filter(date==max(date))%>%select(raceorder, pop, totalpop, pctpop)

#head(dtapopbyrace, 10)
fig2a<-dtafig %>% group_by(raceorder) %>% 
    arrange(date) %>%
    plot_ly( x = ~date, y = ~pct, type = "bar",
             color= ~raceorder, 
             colors = brewer.pal(length(unique(dtafig$raceorder)),
                                "Set3")
             ) %>%
    layout(
        title ="Composition by race* among cumulative confirmed COVID-19 cases over time, Maryland", 
        yaxis = list(title = "Percent of confirmed cases",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 

fig2<-dtafig %>% group_by(race) %>% 
    arrange(date) %>%
    plot_ly( x = ~date, y = ~pct, type = "bar",
             color= ~race, 
             colors = brewer.pal(length(unique(dtafig$race)),
                                "Set3")
             ) %>%
    layout(
        title ="Composition by race* among confirmed COVID-19 cases over time, Maryland", 
        yaxis = list(title = "Percent of confirmed cases",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=12)),
        barmode = 'stack'
        ) 
fig2

#subplot(fig1, fig2, 
#        nrows=1, margin=0.05, shareY = TRUE, shareX = TRUE) %>%
#        layout(  title ="Changing composition by age and race among confirmed COVID-19 cases, Maryland")
```
_NOTE on race data_: composition excluding cases with unknown race. Hispanic was not reported as a separate category until April 15th.  

##### __Q 8.3. Does it explain slightly decreasing mortality?__ 

Yes, at least partially. There is a very strong age-pattern in COVID-19 mortality (i.e., the older, the higher risk of dying), and having proportionately more younger people with COVID-19 would lower _overall, all-age, case fatality ratio_, which has declined slightly (See Question 5). In addition, importantly, a recent study showed [how hospital care might have improved and saved lives more effectively over time, even just over several weeks](https://www.bmj.com/content/369/bmj.m1966). 

At the same time, minority populations [have lower health insurance coverage](https://www.kff.org/disparities-policy/issue-brief/changes-in-health-coverage-by-race-and-ethnicity-since-the-aca-2010-2018/) and [receive lower quality of care](https://www.ahrq.gov/research/findings/nhqrdr/nhqdr18/index.html) than White population in the US. So, having proportionately more minorities means access to quality health care may decrease among people with confirmed cases.     

---

##### __Q 7. How has mortality changed over time by age?__

Answers to Question 5 show latest case fatality ratio (i.e., deaths per 100 COVID-19 cases) by county and how it has changed in the State. But, how about across different age groups? __Case fatality ratio has increased continuously in older age groups. The rate of increase is highest among people who are 80 and older__.  

```{r plotmortalitytrendbyage, results="asis", fig.align="left", out.width="800px"}
    #add_trace(        y=~cfrprobable, name="CFR",        type='scatter',mode = 'lines',         marker=list(color = c( "gray"), size = 1),        line=list(color = c( "gray"))        )%>%
    
panel <- . %>% 
    plot_ly(x=~date, 
            y=~cfr, name="CFR including probable cases/deaths",
            type = 'scatter', mode = 'lines'
            ) %>%
    add_annotations(
        text = ~unique(agegroup),
        x = 0.5, y = 0.9, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        showlegend = FALSE,
        title=c("Trend of cumulative case fatality ratio by age group, since April 2020"),
        xaxis=list(title = "Date", tickfont = list(size=8)),
        yaxis=list(title = "Case fatality ratio (per 100) (log scale)", 
                   range=c(0, upperrange+30), 
                   type = "log")
        
        )

upperrange<-round(max(dtabyage$cfrprobable)+1) 

dtabyage%>%filter(age>=0)%>%
    filter(date>=as.Date("2020-04-01"))%>%
    group_by(agegroup) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 1, shareX = TRUE, shareY = TRUE)  
```
(__Note__: case fatality ratio including only lab-confirmed COVID-19 deaths and cases. See Question 5 for comparison between case fatality ratios _with vs. without_ probable deaths/cases.) 

---

##### __Q 6. How has it affected population across different races? And, how has it changed over time?__

The Maryland Department of Health started publishing data by race (i.e., the number of cases and deaths by race) on April 9th, following an upsetting report about racial disparity in COVID mortality in the US: [higher morality in states with higher proportions of black population](https://www.washingtonpost.com/nation/2020/04/07/coronavirus-is-infecting-killing-black-americans-an-alarmingly-high-rate-post-analysis-shows/?arc404=true). Further data - specifically disaggregated by individual people's race, beyond the state-level analysis - are crucial to monitor and understand the disparity. Also, though initially unavailable, __a separate category for Hispanic population is published on April 15__. As a resident of Maryland, I am very proud of the state's rapid action to publish race data!

```{r}
incidencetop<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(incidence==max(incidence))%>%select(incidence)%>%
    summarize_all(funs(max))
                            
incidencetoprace<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(incidence==max(incidence))%>%select(race)
incidencetoprace<-incidencetoprace$race

missingracecases<-dtabyrace%>%filter(latest==TRUE)%>%
    filter(race=="Unknown")%>%select(cases)%>%
    summarize_all(funs(mean))
allcases<-dtabyrace%>%filter(latest==TRUE)%>%select(cases)%>%
    summarize_all(funs(sum))
missingracepct<-round(100*missingracecases/allcases, 0)

```

```{r plotbyracecases, fig.align="left", out.width="500px"}
dtafig<-dtabyrace%>%filter(date==max(date))

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$cases, decreasing = TRUE)])

plot_ly(dtafig, x=~race, y=~cases, type = 'bar', name="confirmed cases")%>% 
    layout(
            title = c("COVID-19 cases by race"),
            yaxis = list(title = "Number of confirmed cases")
            )
```

Now with Hispanic population disaggregated from "other", the pattern of incidence and mortality by race/ethnicity can be examined better. In terms of rates (important to compare across races with different population sizes), __the incidence rate is substantially higher among Hispanic, followed by African American population__ (blue bars). And, __incidence rate among Hispanic population has increased most rapidly__ - see the second figure below.   

However, __case fatality ratio is highest among White and Asian Americans__ (orange bars). This implies that __the disproportionately higher number of deaths among African American population in Maryland is because of the higher rate of infection, not because of higher risk of dying among those who are infected__. At the same time, it is notable that, though the infection rate is lower, mortality risk is higher among Asian Americans in Maryland.    

To understand reasons behind this, we will need to learn more about characteristics of patients by race (e.g., Do Asian Americans with COVID tend to be older and/or have existing conditions in Maryland? Are Hispanic Marylanders with COVID younger than their counterparts?) and any differences in access to health care by race among COVID patients. Also, __what can we do to reduce the higher infection rate among African Americans and Hispanic population in Maryland?__ Finally and importantly, if and when we have better data on race (i.e., less cases with missing race information), the findings on racial disparity may well change (see below note on race data in Maryland).    

_Hover over each figure to see values and more options._

```{r plotbyracerates, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabyrace%>%filter(date==max(date))%>%
    filter(race!="Unknown")%>%filter(race!="Other")

dtafig$incidence=round(dtafig$incidence, 0)

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$incidence, decreasing = TRUE)])

figincidencerate<-plot_ly(dtafig, 
                          x=~race, y=~incidence, type = 'bar', 
                          name="Cases per 100,000 population",
                          text=~incidence, textposition="outside")%>%   
    layout(
            xaxis = list(title = "Race",  
                         titlefont=list(size=12), 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=12)),
            yaxis = list(title = "Confirmed cases per 100,000 population", 
                         titlefont=list(size=12) )
            )

dtafig<-dtabyrace%>%filter(date==max(date))%>%
    filter(race!="Unknown")%>%filter(race!="Other")

dtafig$cfr=round(dtafig$cfr, 1)

dtafig$race<-factor(dtafig$race, 
                    levels = unique(dtafig$race) 
                    [order(dtafig$cfr, decreasing = TRUE)])

figcfr<-plot_ly(dtafig, 
                x=~race, y=~cfr, type = 'bar' , 
                name="Deaths per 100 cases (%)", 
                text=~cfr, textposition="outside")%>%  
    layout(
            xaxis = list(title = "Race",  
                         titlefont=list(size=12), 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=12)),
            yaxis = list(title = "Deaths per 100 cases (%)",
                         titlefont=list(size=12) )
            )

subplot(figincidencerate, figcfr, 
        nrows=1, margin=0.05, shareY = FALSE, titleY = TRUE) %>%
        layout(  title ="Cumulative incidence and case fatality ratios by race in Maryland", 
                 showlegend=FALSE  )
```
(__Note__: case fatality ratio including only lab-confirmed COVID-19 deaths and cases. See Question 5 for comparison between case fatality ratios _with vs. without_ probable deaths/cases.)   

```{r plottrendbyrace, results="asis", fig.align="left", out.width="800px"}

dtafig<-dtabyrace%>%select(date, race, incidence)%>%
    mutate(
        race=ifelse(race=="African-American", "AfricanAmerican", race), 
        race=paste0("incidence",race)
    )%>%
    arrange(date, race)%>% 
    spread(race, incidence, fill = NA, convert = FALSE) 

maxy<-max(dtabyrace$incidence)

figincidenceratetrend<-plot_ly(dtafig, x=~date, y=~incidenceAfricanAmerican, name = "African-American", 
               type = 'scatter', mode='lines',
               line = list(color = c( "#d62728"))) %>% 
    add_trace(y = ~incidenceAsian, name = "Asian", line = list(color = c( "#ff7f0e"))) %>% 
    add_trace(y = ~incidenceHispanic, name = "Hispanic", line = list(color = c( "#2ca02c"))) %>% 
    add_trace(y = ~incidenceWhite, name = "White", line = list(color = c( "#1f77b4"))) %>%  
    layout(
        title ="Trends of cumulative incidence rate by race",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of confirmed cases (per 100,000 population)",
                     titlefont=list(size=10),
                     tickfont=list(size=10),
                     range=c(0, maxy) ), 
        legend = list(font=list(size=10), 
                      orientation = "h", xanchor = "center",  
                      x=0.5, y=-0.1)               
        ) 

dtafig<-dtabyrace%>%select(date, race, cfr)%>%
    mutate(
        race=ifelse(race=="African-American", "AfricanAmerican", race), 
        race=paste0("cfr",race)
    )%>%
    arrange(date, race)%>% 
    spread(race, cfr, fill = NA, convert = FALSE) 

maxy<-max(dtabyrace$cfr)+1

figcfrtrend<-plot_ly(dtafig, x=~date, y=~cfrAfricanAmerican, name = "African-American", 
               type = 'scatter', mode='lines',
               line = list(color = c( "#d62728"))) %>% 
    add_trace(y = ~cfrAsian, name = "Asian", line = list(color = c( "#ff7f0e"))) %>% 
    add_trace(y = ~cfrHispanic, name = "Hispanic", line = list(color = c( "#2ca02c"))) %>% 
    add_trace(y = ~cfrWhite, name = "White", line = list(color = c( "#1f77b4"))) %>%   
    layout(
        title ="Trends of case fatality ratio by race",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of deaths per 100 cases (%)",
                     titlefont=list(size=10),
                     tickfont=list(size=10),
                     range=c(0, maxy)), 
        legend = list(font=list(size=10), 
                      orientation = "h", xanchor = "center",  
                      x=0.5, y=-0.1)          
        ) 

subplot(figincidenceratetrend, figcfrtrend, 
        nrows=1, margin=0.05, shareY = FALSE, titleY = TRUE) %>%
        layout(  title ="Trends of cumulative incidence and case fatality ratios by race in Maryland" , 
                 showlegend=TRUE, 
                 legend=list(font=list(size=9))
                 )

```            
(__Note__: case fatality ratio including only lab-confirmed COVID-19 deaths and cases. See Question 5 for comparison between case fatality ratios _with vs. without_ probable deaths/cases.)    

__Important note on race data in Maryland__:   
1. _`r missingracepct` % of cases do not have race information_. This is likely because [private labs are not required to report race](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-race-data-20200409-ffim7y4bljcz3hjk4dmt773mp4-story.html). All data shown here is only based among cases and deaths with known race.   
2. In Maryland, "Other" population includes: American Indian and Alaska Native, Native Hawaiian and Other Pacific Islander, and 'Two or more races' - accounting for about 3% of total population in the state. Figures do not include "Other" races, given possibility that Hispanic population might have been included in this category initially. 

---

##### __Q 5. What is the latest mortality, and how has it changed?__ 
```{r}
latestdateMD<-max(dtaMD$date)

deathsMD<-dtaMD%>%filter(date==max(date))%>%select(deaths)%>%summarize_all(funs(mean))
casesMD<-dtaMD%>%filter(date==max(date))%>%select(cases)%>%summarize_all(funs(mean))
cfrMD<-round(100*deathsMD/casesMD, 1)

probabledeathsMD<-dtaMD%>%filter(date==max(date))%>%select(probabledeaths)%>%summarize_all(funs(mean))
cfrprobableMD<-round(100*(deathsMD+probabledeathsMD)/(casesMD+probabledeathsMD), 1)

latestdatecounty<-max(dtabycounty$date)
```
As of `r latestdateMD` 10:00AM, according to Maryland Department of Health, __`r deathsMD` COVID-19 deaths have occurred, that had been laboratory-confirmed__. In addition, MD Health Department has published the number of probably COVID deaths since April 15. There have been __`r probabledeathsMD` probable COVID-19 deaths__, for which death certificate lists COVID-19 as the cause of death but not yet confirmed by a laboratory test. This means case fatality ratio can be calculated _with vs. without_ the probable deaths (which are thus probable cases as well). Case fatality ratio is: 

* __`r cfrMD`__ % based on only laboratory confirmed cases and deaths.   
* __`r cfrprobableMD`__ % based on laboratory confirmed as well as probable cases and deaths. 

Given relatively small differences across groups (i.e., by age, sex, and race, results now shown), __only laboratory-confirmed COVID-19 deaths and cases are used throughout this report__. I will keep monitoring how the two approaches produce different/similar results, and update as needed. 

Below figure shows mortality by county - in terms of both absolute number (red bars) and case fatality ratio (orange bars) as of `r latestdatecounty`.  

```{r plotdeathsCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabycounty%>%filter(date==latestdatecounty)%>%
    filter(county!="Unknown")%>%
    select(date, county, deaths, cases)%>%mutate(cfr=round(100*deaths/cases, 3))

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$deaths, decreasing = FALSE)])

fig1<-plot_ly(dtafig, y = ~county, x = ~deaths, type="bar", orientation="h",
              name = "lab confirmed COVID-19 deaths", 
              marker = list(color = c( "#d62728"))) %>%
        layout(
            title ="Absolute number of COVID-19-positive deaths by county in Maryland",
            yaxis = list( 
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=9)
                         ),
        xaxis = list(title = "Total number of deaths")
            )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$cfr, decreasing = FALSE)])

fig2<-plot_ly(dtafig, y = ~county, x = ~cfr, type="bar", orientation="h",
              name="Deaths per 100 cases (%)",
              marker = list(color = c( "#ff7f0e"))) %>%
        layout(
            title ="COVID-19 case fatality ratio by county in Maryland",
            yaxis = list(  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=9) 
                    
                         ),
            xaxis = list(title = "Deaths per 100 cases (%)")
            )

subplot(fig1, fig2, titleX = TRUE) %>%
        layout(
            title ="COVID-19 mortality by county in Maryland",
            legend = list(orientation = "h",   
                        xanchor = "center",  
                        x=0.5, y=-0.4)            
            )

```

Below chart shows the mortality trends, since March 18 when the first COVID-19 death was reported in Maryland. Globally in countries severely affected by the epidemic before US, case fatality ratios increased rapidly in the beginning. The rates then stabilized in some of the countries, depending on health systems' response and characteristics of patient population.  

```{r plotcfrMDtrends, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtaMD%>%select(date, deaths, cases)%>%
    mutate(cfr=round(100*deaths/cases, 3), na.rm=TRUE)%>%
    filter(cfr>0)

plot_ly(dtafig, x = ~date, y = ~cfr, type="bar", 
        marker=list(color = c( "#ff7f0e"))
        ) %>%
        layout(
            title ="Trend of COVID-19 case fatality ratio in Maryland",
            yaxis = list(title = "Deaths per 100 confirmed cases (%)")
            )
```

```{r plotdeathsMDtrends, fig.align="left", out.width="800px"}
dtafig<-dtabycounty%>%select(date, deaths, cases)%>%
    group_by(date)%>%
    summarize_all(funs(sum))%>%
    mutate(cfr=round(100*deaths/cases, 3))%>%
    filter(cfr>0)

plot_ly(dtafig, x = ~date, y = ~deaths, type="bar") %>%
        layout(
            title ="Trends of COVID-19 mortality in Maryland",
            yaxis = list(title = "Number of COVID-19 deaths")
            )
```

---

##### __Q 4. How extensive has testing been? How has the test positivity rate changed?__ 

```{r}
totaltestMD<-dtaMD%>%filter(date==max(date))%>%select(totaltests)%>%summarize_all(funs(max))

popstate<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(sum))

testrateMD<-round(1000*totaltestMD/popstate, 1)

totaltestMD<-as.character(totaltestMD)

temp<-dtaMD%>%
    select(date, date, newtests, percent_positive)%>%
    mutate(notestdata=(date>as.Date("2020-03-11") & date< as.Date("2020-03-29")) ,
           positiveratesmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(percent_positive, 7)), 1), 
           positiveratesmooth =ifelse(positiveratesmooth<0,  0, positiveratesmooth)
           )%>%
    filter(is.na(positiveratesmooth)==FALSE)%>%filter(date==max(date))
                                                                 
positiveratesmoothlatest<-mean(temp$positiveratesmooth)    

testrateMD
totaltestMD
positiveratesmoothlatest

```
This is a very important question, since the magnitude of testing over time is critical information to understand the epidemic. I got trend data on testing in Maryland from [COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/) by Maryland Department of Health also [COVID Tracking Project](https://covidtracking.com/data/state/maryland#historical) for earlier data. Still, data on the number of new tests are not available between 3/12 and 3/28. 

As of `r latestdateMD` 10:00AM, __a total of `r totaltestMD` tests have been conducted__. There are about 6 million people in Maryland, and this means __`r testrateMD` tests have been conducted in every 1000 people__. 

However, __a high rate of positive test, `r positiveratesmoothlatest` % (average over the latest 7-day data)__, indicates that testing is still limited to those with symptoms primarily, not based on effective contact tracing. Ideally, [the positive test rate should be below 5%](https://coronavirus.jhu.edu/testing/tracker/map/percent-positive). 

```{r plotTrendNewTestsMD_retired, eval=FALSE}
#using scraped data in excel. LIkely test-level and case-level data are mix-used
dtafig<-dtaMD%>%select(date, cases, newcases,  negativetests, totaltests, newtests, newpositive )%>%
    mutate(notestdata=(date>as.Date("2020-03-11") & date< as.Date("2020-03-29")) ,
           newtests=ifelse(notestdata==TRUE, NA, newtests), 
           #positiverate=round(100*(cases/totaltests), 1), 
           positiverate=round(100*(newcases/newtests), 1), 
           positiverate=ifelse(date==min(date), NA, positiverate),  
           positiverate=ifelse(notestdata==TRUE, NA, positiverate), 
           
           positiveratesmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(positiverate, 7)), 1), 
           positiveratesmooth =ifelse(positiveratesmooth<0,  0, positiveratesmooth)
           )


fig<-plot_ly(dtafig, x=~date, y=~newtests, type = 'bar') %>%
    #, name="Total tests"     
    #add_trace(y=dtafig$newcases, name = 'Positive tests') %>%
        layout(
            annotations= list(x = "2020-03-22",
                              y = 5500,
                              text = "Total number of new tests not available between 3/12-3/28",
                              font = list(color = 'gray', size = 12),
                              xref = "x",
                              yref = "y",
                              showarrow = FALSE),
            title = "Trend of daily new COVID-19 tests in Maryland",
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new tests"))

plot_ly(dtafig, x=~date, 
        y=~newtests, name="New tests per day",
        type='bar',  
        marker=list(color = c( "#8DB9D9"), opacity=1, size=2)
        ) %>%
    add_lines(
        y=~positiveratesmooth, name="Positive rate, 7-day average", 
        marker=list(color = "black"),
        line=list(color = "black"),
        yaxis='y2')%>%
    add_segments(x = min(dtafig$date), xend = max(dtafig$date), 
                 y = 5, yend = 5, yaxis='y2', 
                 marker = list(color = "gray",size = 2),
                 line= list(color = "gray",  dash = 'dot'),
                 showlegend=FALSE)%>%
    layout(
        title = c("Trend of daily tests and positive test rate"),
        xaxis = list(title = "", tickfont = list(size=10), showgrid = FALSE), 
        yaxis = list(title = "Number of tests", 
                     range=c(0, max(dtafig$newtests)+1000),
                     side="left", showgrid = FALSE ),
        yaxis2 = list(title = "Positive rate (%)", 
                      range=c(0, 40),
                      overlaying='y',  
                      side="right", showgrid = FALSE),
        margin = list(r=100), 
        legend=list(orientation="v", xanchor = "left", yanchor = "center", 
                    x = 0.05, y = 0.9) 
        
        ) 


```

```{r plotTrendNewTestsMD, results='asis', fig.align="left", out.width="800px"}
# use test-level data from MD  dashboard
dtafig<-dtaMD%>%select(date, newtests, percent_positive )%>%
    mutate(
           positiverate=percent_positive, 
           positiveratesmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(positiverate, 7)), 1), 
           positiveratesmooth =ifelse(positiveratesmooth<0,  0, positiveratesmooth)
           )


fig<-plot_ly(dtafig, x=~date, y=~newtests, type = 'bar') %>%
    #, name="Total tests"     
    #add_trace(y=dtafig$newcases, name = 'Positive tests') %>%
        layout(
            annotations= list(x = "2020-03-22",
                              y = 5500,
                              text = "Total number of new tests not available between 3/12-3/28",
                              font = list(color = 'gray', size = 12),
                              xref = "x",
                              yref = "y",
                              showarrow = FALSE),
            title = "Trend of daily new COVID-19 tests in Maryland",
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new tests"))

plot_ly(dtafig, x=~date, 
        y=~newtests, name="New tests per day",
        type='bar',  
        marker=list(color = c( "#8DB9D9"), opacity=1, size=2)
        ) %>%
    add_lines(
        y=~positiveratesmooth, name="Positive rate, 7-day average", 
        marker=list(color = "black"),
        line=list(color = "black"),
        yaxis='y2')%>%
    add_segments(x = min(dtafig$date), xend = max(dtafig$date), 
                 y = 5, yend = 5, yaxis='y2', 
                 marker = list(color = "gray",size = 2),
                 line= list(color = "gray",  dash = 'dot'),
                 showlegend=FALSE)%>%
    layout(
        title = c("Trend of daily tests and positive test rate"),
        xaxis = list(title = "", tickfont = list(size=10), showgrid = FALSE), 
        yaxis = list(title = "Number of tests", 
                     range=c(0, max(dtafig$newtests)+1000),
                     side="left", showgrid = FALSE ),
        yaxis2 = list(title = "Positive rate (%)", 
                      range=c(0, 40),
                      overlaying='y',  
                      side="right", showgrid = FALSE),
        margin = list(r=100), 
        legend=list(orientation="v", xanchor = "left", yanchor = "center", 
                    x = 0.05, y = 0.9) 
        
        ) 


```

_Note 1_: On May 28th, Maryland Health Department started publishing ["total testing volume"](https://coronavirus.maryland.gov/)". However, it is unclear what a unit of testing is, since the volume is about 15% higher than the sum of "Number of confirmed cases" and "Number of persons tested negative", as of May 28, 2020. Until this is clarified, the test positivity in this report is calculated consistently as percent of "number of _new_ confirmed cases" out of "number of _new_ confirmed cases AND number of _new_ persons tested negative." The number of _new_ cases/persons is a difference between cumulative numbers over two consecutive days, which are published by the state. Then, the test positivity rates are averaged over 7 days.      

_Note 2_: On May 28th, Maryland Health Department also started publishing ["Percent positive testing, all jurisdictions"](https://phpa.health.maryland.gov/Documents/Positivity%20by%20Jurisdiction.pdf)".     

_Note 3_: [A large spike on the number of new tests on April 7th appears to be artifact of delayed processes in laboratory and/or data entry, not actual changes in the number of tests](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).  

---

##### __Q 3. What age groups are affected? And, how has it changed over time?__ 

```{r}
incidencetop<-dtabyage%>%filter(latest==TRUE)%>%filter(is.na(age)==FALSE)%>%
    filter(incidence==max(incidence))%>%select(incidence)%>%
    summarize_all(funs(mean))
                            
incidencetopage<-dtabyage%>%filter(latest==TRUE)%>%filter(is.na(age)==FALSE)%>%
    filter(incidence==max(incidence))%>%select(agegroup)
incidencetopage<-incidencetopage$agegroup


incidencetop

incidencetopage

```
Initially, COVID-19 has affected __adult population relatively evenly across different ages__ (approaching or above 300 per 100,000 population in all age groups 30 and above). Recently, however, __the incidence rate has increased more rapidly among those 80 and older__ (see the second figure). Currently, the incidence rate is highest, `r incidencetop` per 100,000 population, among people `r incidencetopage` years of age.  

```{r plotincidencebyage, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabyage%>%filter(latest==TRUE)
plot_ly(dtafig, x=~agegroup, y=~incidence, 
        mode = 'marker',
        transforms = list(
            list(
                type = 'groupby',
                groups = dtabyage$date
                )
            )
        ) %>%
        layout(
            title = "COVID-19 cumulative incidence rate by age group in Maryland",
            xaxis = list(title = "Age group"),
            yaxis = list(title = "Number of COVID-19 cases per 100,000 population"))
```

```{r plotincidencebyagetrends, results='asis', fig.align="left", out.width="800px"}

dtafig<-dtabyage%>%select(date, age, incidence)%>%
    mutate(
        age=paste0("incidence",age)
    )%>%
    arrange(date, age)%>% 
    spread(age, incidence, fill = NA, convert = FALSE) 
#head(dta, 20)
#str(dta)

plot_ly(dtafig, x=~date, y=~incidence20, name = "20-29", 
               type = 'scatter', mode='lines',
               line = list(color = c( "orange"))) %>% 
    add_trace(y = ~incidence30, name = "30-39", line = list(color = c( "rgb(65,174,118)"))) %>% 
    add_trace(y = ~incidence40, name = "40-49", line = list(color = c( "rgb(35,139,69)"))) %>% 
    add_trace(y = ~incidence50, name = "50-59", line = list(color = c( "rgb(0,109,44)"))) %>% 
    add_trace(y = ~incidence60, name = "60-69", line = list(color = c( "rgb(0,68,27)"))) %>% 
    add_trace(y = ~incidence70, name = "70-79", line = list(color = c( "rgb(33,113,18)"))) %>% 
    add_trace(y = ~incidence80, name = "80+", line = list(color = c( "rgb(239,59,44)"))) %>% 
    layout(
        title ="Trends of cumulative incidence rate by age group in Maryland",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of confirmed cases (per 100,000 population)",
                     titlefont=list(size=12), 
                     type = "log"), 
        legend = list(font=list(size=10), traceorder="reversed") 
        ) 

fig <- plot_ly(dtafig, x=~date, y=~incidence0, name = "0-9", 
               type = 'scatter', mode='lines',
               line = list(color = c( "rgb(204,236,230)"))) %>% 
    add_trace(y = ~incidence10, name = "10-19", line = list(color = c( "rgb(153,216,201)"))) %>% 
    add_trace(y = ~incidence20, name = "20-29", line = list(color = c( "rgb(102,194,164)"))) %>% 
    add_trace(y = ~incidence30, name = "30-39", line = list(color = c( "rgb(65,174,118)"))) %>% 
    add_trace(y = ~incidence40, name = "40-49", line = list(color = c( "rgb(35,139,69)"))) %>% 
    add_trace(y = ~incidence50, name = "50-59", line = list(color = c( "rgb(0,109,44)"))) %>% 
    add_trace(y = ~incidence60, name = "60-69", line = list(color = c( "rgb(0,68,27)"))) %>% 
    add_trace(y = ~incidence70, name = "70-79", line = list(color = c( "rgb(33,113,18)"))) %>% 
    add_trace(y = ~incidence80, name = "80+", line = list(color = c( "rgb(239,59,44)"))) %>% 
    layout(
        title ="Trends of cumulative incidence rate by age group in Maryland",
        xaxis = list(title = ""), 
        yaxis = list(title = "Number of confirmed cases (per 100,000 population)",
                     titlefont=list(size=12), 
                     type = "log"), 
        legend = list(font=list(size=10), traceorder="reversed") 
        ) 

```
(__Source__: Maryland Department of Health's [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/), and Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx))


```{r plotagecompositiontrend, fig.align="left", out.width="800px"}
#Another approach, potentially simpler, is to see any changes in age-composition of confirmed cases. As expected based on the above figure, there are relatively more elderlies. 

#_Hover over each figure to see values and more options._

temp <- dtabyage%>%filter(is.na(agegroup)==FALSE)%>%select(date, cases)%>%
    group_by(date)%>%summarize_all(funs(sum))%>%
    mutate(total=cases)%>%select(date, total)

dta<-left_join(dtabyage, temp, by = "date") %>% 
    select(date, agegroup, cases, total) %>% 
    mutate(
        pct=round(100*cases/total,1)    
    )


dta %>% group_by(agegroup) %>% 
    arrange(date) %>%
    plot_ly( x = ~date, y = ~pct, 
             color= ~agegroup, colors = 'Reds',
             type = "bar") %>%
    layout(
        title ="Age pattern of confirmed cases over time in Maryland",
        yaxis = list(title = "Percent of confirmed cases",
                     titlefont=list(size=12)), 
        legend = list(font=list(size=10)),
        barmode = 'stack'
        ) 

```

---

##### __Q 2. How fast has it been spreading? What is the trend of new cases?__ 
```{r dataplotTrendNewCasesMD}
dtafig<-dtabycounty%>%select(date, cases)%>%group_by(date)%>%
    summarize_all(funs(sum))%>%
    arrange(date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newcasessmooth = round(newcasessmooth, 3)
        )

latestdate<-max(dtafig$date)
latestnewcases<-dtafig%>%filter(date==max(date))%>%select(newcases)%>%summarize_all(funs(mean)) 
previousnewcases<-dtafig%>%arrange(date)%>%mutate(previousnewcases=lag(newcases))%>%filter(date==max(date))%>%select(previousnewcases)%>%summarize_all(funs(mean)) 
```
Since testing capacity has been low, we _cannot_ confidently answer this question. Nevertheless, we can see __the number of NEW confirmed cases each day__. The first figure is for the entire state. We want to see the number of new infections to be stable more or less, without sudden and large increases. __On `r latestdate`, `r latestnewcases` new cases were confirmed, compared to `r previousnewcases` on the previous date__. The (now relatively small) peak on March 28th was due to new cases in Carroll county on March 28 - see the second figure below.  

[The spike of new confirmed cases on April 8th may be artifact of delayed processes in laboratory and/or data entry, not an actual increase on this specific date](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).

_Hover over each figure to see values and more options._
```{r plotTrendNewCasesMD, results='asis', fig.align="left", out.width="800px"}

plot_ly(dtafig, x=~date, y=~newcases, name="New cases, daily",
        type = 'bar',
        marker=list(color=("lightgray")) ) %>%
        add_trace(
            y=~newcasessmooth, name="7-day rolling average",
            type='scatter',mode = 'lines', 
            marker=list(color = c( "black"), size = 1),
            line=list(color = c( "black"))
            )%>%
        layout(
            title = "Trend of daily new confirmed COVID-19 cases in Maryland",
            xaxis = list(title = "Date",  
                         tickfont = list(size=10)),
            yaxis = list(title = "Number of new confirmed cases"),
            legend = list(x = 0.1, y = 0.9) 
            )
```

```{r dataplotTrendNewCasesCounty}
dtafig<-dtabycounty%>%select(date, county, cases, latesttotalcases)%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,NA,NA,NA, rollmean(newcases, 7)), 
        newcasessmooth = round(newcasessmooth, 3)
        )%>%
    mutate(
        rank = dense_rank(desc(latesttotalcases))
    )%>%
    filter(latesttotalcases>=100)%>% arrange(county, date)

ncounty100<-n_distinct(dtafig$county)
ncounty100
```

```{r plotTrendNewCasesCounty, fig.align="left", out.width="800px"}
plot_ly(dtafig, x=~date, y=~newcases, 
             type = 'bar', color= ~county ) %>%
        layout(
            title = c("Trend of daily new confirmed COVID-19 cases by county in Maryland"),
            xaxis = list(title = "Date",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10), 
                         tickangle=-90),
            yaxis = list(title = "Number of new confirmed cases"),
            barmode="stack",  
            legend = list(x = 0.1, y = 0.9, 
                          title=list(text='Counties with 50 or more cases'))
            )

```

```{r}
dtafig<-dtafig%>%filter(latesttotalcases>=150)%>% arrange(county, date)
ncounty150<-n_distinct(dtafig$county)
ncounty150

dtafig<-dtafig%>%filter(latesttotalcases>=200)%>% arrange(county, date)
ncounty200<-n_distinct(dtafig$county)
ncounty200   
```

Now, _among `r ncounty200` counties with 200 or more confirmed cases_, below shows the trends of daily number of NEW confirmed cases for each of the county, with 7-day rolling averages in black lines. Again, [large spikes on April 8th may well be results of delayed processes in laboratory and/or data entry, not actual increases on that date](https://www.baltimoresun.com/coronavirus/bs-md-coronavirus-update-wednesday-20200408-eexgmqygnfetdcp3xymhjpxab4-story.html).  

_Hover over each figure to see values and more options._
```{r plotTrendNewCasesCountyBar, results='asis', fig.align="left", out.width="800px", out.height="800px"}

panel <- . %>% 
    plot_ly(x=~date, y=~newcases, type = 'bar',
            marker=list(color=("lightgray")) 
        ) %>%
    add_trace(
        y=~newcasessmooth, name="New cases, 7-day rolling average",
        type='scatter',mode = 'lines', 
        marker=list(color = c( "black"), size = 1),
        line=list(color = c( "black"))
        )%>%
    add_annotations(
        text = ~unique(county),
        x = 0.5, y = 0.9, xref = "paper", yref = "paper",    
        xanchor = "center", yanchor = "bottom", showarrow = FALSE,
        font = list(size = 12)
        ) %>%
    layout(
        showlegend = FALSE,
        xaxis=list(title = "Date",  
                 font=list(size=10),
                 tickfont = list(size=8) 
                 ),
        yaxis=list(title = "New cases")
        )

dtafig<-dtabycounty%>%select(date, county, cases, latesttotalcases)%>%
    filter(county!="Unknown")%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newcasessmooth = round(newcasessmooth, 3)
        )%>%
    mutate(
        rank = dense_rank(desc(latesttotalcases))
    )%>%
    filter(latesttotalcases>=200)

#write.csv(dtafig, "KCOVID/dtaKCOVIDSouthKoreaUnlike1.csv")

dtafig%>%
    group_by(county) %>%
    do(p = panel(.)) %>%
    subplot(nrows = 4, shareX = TRUE, shareY = FALSE)   

length(unique(dtafig$county))
```

```{r fig.align="left", out.width="800px"}
countylist<-as.vector(as.data.frame(table(dtafig$county))$Var1)

#looping code not working to save a figure with a number! why??? 
for (i in 1:ncounty150){
    temp<-dtafig%>%filter(county==countylist[i])
}

listx<- list(title = "",  
             font=list(size=8),
             autotick = FALSE,
             tickfont = list(size=8), 
             tickangle=-90)

    temp<-dtafig%>%filter(county==countylist[1])
    fig1<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[1])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[2])
    fig2<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[2])%>%layout(xaxis=listx) 
    temp<-dtafig%>%filter(county==countylist[3])
    fig3<- plot_ly(temp, x=~date, y=~newcases, type = 'bar', name=countylist[3])%>%layout(xaxis=listx)            

listx<- list(title = "Date",  
             font=list(size=10),
             autotick = FALSE,
             showticklabels = TRUE, 
             tickfont = list(size=8), 
             tickangle=-90)

listy<- list(title = "Number of new confirmed cases")

listlegend <- list(font=list(size=10), orientation = "h",   
                        xanchor = "center", x=0.5, y=-0.15)

subplot(fig1 , fig2, fig3, 
        nrows = 3, shareX = TRUE )%>%
    layout(title = c("Trend of daily new confirmed COVID-19 cases by county, among counties with 150+ cases"),
           xaxis=listx,  yaxis = listy, legend= listlegend)
```

```{r}

dtafig<-dtabycounty%>%select(date, county, cases, pop)%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newcasessmooth = round(newcasessmooth, 3), 
        newcasessmoothpp = round(newcasessmooth*100000/pop,3)
        )%>%
    filter(is.na(newcasessmooth)==FALSE)%>%
    filter(date==max(date))


temp<-dtafig%>%filter(county=="Prince George's")
newPG<-round(mean(temp$newcasessmoothpp), 0)
```
Finally, below shows counties ranked by the latest level of daily new cases (i.e., right end of the black line above) - per 100,000 population this time. For example, based on the latest 7-day average, there are `r newPG` new cases per day per 100,000 population in Prince George's county.  
```{r plotnewcasesCountyLatest, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabycounty%>%select(date, county, cases, pop)%>%
    filter(county!="Unknown")%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases), 
        newcases=ifelse(newcases<0, 0, newcases),         
        newcases=ifelse(county!=lag(county), NA, newcases ), 
        newcasessmooth =c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 
        newcasessmooth = round(newcasessmooth, 3), 
        newcasessmoothpp = round(newcasessmooth*100000/pop,3)
        )%>%
    filter(is.na(newcasessmooth)==FALSE)%>%
    filter(date==max(date))%>%
    mutate(
        rank = dense_rank(desc(newcasessmoothpp))
    )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$newcasessmoothpp, decreasing = FALSE)])

plot_ly(dtafig, y = ~county, x = ~newcasessmoothpp, type="bar", orientation="h", 
             marker = list(color = c( "gray"))) %>%
        layout(
            title = "Latest daily new cases per 100,000 population by county in Maryland",
            yaxis = list(title = "",  
                         autotick = FALSE,
                         showticklabels = TRUE, 
                         tickfont = list(size=10) 
               
                         ),
            xaxis = list(title = "New cases per day per 100,000 population (7-day average)")
            )

```

---

##### __Q 1. How many confirmed cases do we have now, and where are they?__ 
```{r}
latestdatecounty<-max(dtabycounty$date)
temp<-dtabycounty%>%filter(date==latestdatecounty)
statecases<-sum(temp$cases)

ncounties<-dtabycounty%>%filter(date==latestdatecounty)%>%nrow()
ncountiestotal<-dtapopcounty%>%filter(county!="Maryland")%>%nrow()
popstate<-dtapopcounty%>%filter(county=="Maryland")%>%select(pop)%>%summarize_all(funs(sum))

latestdateMD<-max(dtaMD$date)
casesMD<-dtaMD%>%filter(date==max(date))%>%select(cases)%>%summarize_all(funs(max))
incidencerateMD<-round(100*casesMD/popstate, 0)
casesMD<-as.character(casesMD)

topincidencecounty<-dtabycounty%>%filter(date==latestdatecounty)%>%mutate(incidence=round(cases*100000/pop), 0)%>%filter(county!="Unknown")%>%filter(incidence==max(incidence)) %>%select(county)
topincidencecounty<-topincidencecounty
topincidencecounty

```
As of `r latestdateMD` 10:00AM, __`r casesMD` confirmed cases have been reported in Maryland__, according to Maryland Department of Health. This means there are __`r incidencerateMD` people with confirmed COVID-19 per 100 population in the state__. 

Below figure shows number of confirmed cases (gray bars) and infection rates (i.e., number of confirmed cases per 100,000 population) (blue bars) by county, as of `r latestdatecounty`.  

_Hover over each figure to see values and more options._
```{r plottotalcasesCounty, results='asis', fig.align="left", out.width="800px"}
dtafig<-dtabycounty%>%
    filter(county!="Unknown")%>%
    arrange(county, date)%>%
    mutate(
        newcases=cases-lag(cases),
        newcases=ifelse(county!=lag(county), NA, newcases), 
        newcases=ifelse(newcases<0, 0, newcases),
    
        newcasessmooth =round(c(NA,NA,NA,NA,NA,NA,rollmean(newcases, 7)), 1), 
        newcasessmooth=ifelse(county!=lag(county), NA, newcasessmooth),
        newcasessmoothpp=round(100000*newcasessmooth/pop, 5)
    )%>%
    filter(date==latestdatecounty)%>%
    select(date, county, cases, newcasessmoothpp, pop)%>%
    mutate(incidence=round(cases*100000/pop), 0)

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$cases, decreasing = FALSE)])

figcases<-  plot_ly(dtafig, y = ~county, x = ~cases, 
                  name="total confirmed cases", 
                  type="bar", orientation="h" , 
                  marker = list(color = c( "gray"))) %>%
            layout(
                yaxis = list(title = "",  
                             autotick = FALSE,
                             showticklabels = TRUE, 
                             tickfont = list(size=9)
                             ),
                xaxis = list(title = "Total cumulative number of confirmed cases")
                )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$incidence, decreasing = FALSE)])

figincidence<-  plot_ly(dtafig, y = ~county, x = ~incidence, 
                      name="incidence rate, cumulative (per 100,000)",
                      type="bar", orientation="h",
                      marker = list(color = c( "#1f77b4"))) %>%
                layout(
                    yaxis = list(title = "",  
                                 autotick = FALSE,
                                 showticklabels = TRUE, 
                                 tickfont = list(size=9)
                                 ),
                    xaxis = list(title = "Number of cumulative confirmed cases per 100,000 population")
                    )

dtafig$county<-factor(dtafig$county, 
                    levels = unique(dtafig$county) 
                    [order(dtafig$newcasessmoothpp, decreasing = FALSE)])

fignew7day<-plot_ly(dtafig, y = ~county, x = ~newcasessmoothpp, 
                      name="incidence rate, latest 7-day average (per 100,000)",
                      type="bar", orientation="h",
                      marker = list(color = c( "#B41F77"))) %>%
            layout(
                yaxis = list(title = "",  
                             autotick = FALSE,
                             showticklabels = TRUE, 
                             tickfont = list(size=9)
                             ),
                xaxis = list(title = "Number of confirmed cases (daily, latest 7-day average) per 100,000 population")
                )

subplot(figcases, figincidence, fignew7day, 
        nrows=1, margin=0.05, shareY = FALSE, titleY = TRUE) %>%
        layout(  title ="COVID-19 cumulative cases, cumulative incidence rate, and latest incidence rate by county in Maryland", 
                 legend = list(font=list(size=9), 
                      orientation = "h", xanchor = "center",  
                      x=0.5, y=-0.1) 
        )

```


```{r}
##### __Q 1. When and where was COVID-19 first reported in Maryland?__ 
firstdatestate<-mean(dtabycounty$firstdatestate)

firstcountyname<-dtabycounty%>%filter(firstcounty==TRUE)%>%select(county)
firstcountyname<-firstcountyname$county

#The first confirmed COVID-19 case was reported in __`r firstcountyname` county on `r firstdatestate`__. 
```

---

__Data sources__:  
1. __All COVID-19 data for Maryland__ come from [Maryland COVID-19 Case Map Dashboard](https://coronavirus.maryland.gov/) published by Maryland Department of Health. This dashboard presents latest numbers on tests, cases, hospitalizations, and deaths as of 10:00AM on each day. Accessed on `r date`. County-level data from New York Times' [Coronavirus in the U.S.: Latest Map and Case Count](https://github.com/nytimes/covid-19-data) are no longer used, as of July 19, 2020.   
2. __All COVID-19 data for other US states and countries__ come from [JHU/CSSE](https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data), accessed on `r date`.    
3. __All data on Maryland county population__ come from US Census Bureau's [County Population Totals: 2010-2019](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage). Accessed on March 29, 2020.   
4. __Data on Maryland population by age and sex__ come from Maryland Department of Planning's [Population Estimates by Race and Hispanic Origin for July 1, 2018](https://planning.maryland.gov/MSDC/Pages/pop_estimate/CensPopEst.aspx). Accessed on April 1, 2020.    
5. __All data on US state population__ come from [US Census Bureau](https://www.census.gov/data/tables/time-series/demo/popest/2010s-counties-total.html#par_textimage), accessed on March 29, 2020.   
---

<p style="color:lightgray">
See [GitHub](https://github.com/yoonjoung/COVID19_MD) for data, code, and more information. 
For typos, errors, and questions, contact me at [www.isquared.global](https://www.iSquared.global/YJ). 

_Making Data Delicious, One Byte at a Time_, in good times and bad times.</p>